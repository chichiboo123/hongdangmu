<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>홍당뮤 (With. 디자인씽킹)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Basic Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Grandiflora+One&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- App Design Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Single+Day&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- html2canvas 라이브러리 추가 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FEFBF6; /* 따뜻한 크림색 배경 */
            padding-bottom: 0; /* 기본값 초기화, 나중에 스크립트 전에 재설정 */
        }
        .grandiflora {
            font-family: 'Grandiflora One', cursive;
        }
        .nav-button.active-nav {
            font-weight: 700;
            transform: scale(1.1);
        }
        .content-card {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .animate-fade-in {
            animation: fadeIn .4s ease both;
        }
        @keyframes fadeIn {
            from { opacity:0; transform: translateY(6px); }
            to { opacity:1; transform:none; }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); animation-timing-function: cubic-bezier(0.8,0,1,1); }
            50% { transform: none; animation-timing-function: cubic-bezier(0,0,0.2,1); }
        }
        .animate-bounce {
            animation: bounce 1s infinite;
        }

        /* '빛' 탭 - 활성 이모지 버튼 */
        .emoji-btn.active {
            background-color: #fde68a; /* amber-200 */
            transform: scale(1.1);
            box-shadow: 0 0 0 2px #f59e0b; /* amber-500 */
        }

        /* '거울' 탭 - 활성 서브탭 스타일 */
        .mirror-tab-btn.active {
            border-bottom-color: #ec4899; /* pink-500 */
            background-color: white;
            color: #ec4899;
            font-weight: 600;
        }

        /* '거울' 탭 - 감정 슬라이더 커스텀 스타일 */
        input[type=range].emotion-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #fce7f3; /* pink-100 */
            border-radius: 5px;
            border: 1px solid #fbcfe8; /* pink-200 */
            outline: none;
        }
        input[type=range].emotion-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #ec4899; /* pink-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
        input[type=range].emotion-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #ec4899; /* pink-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }

        /* '거울' 탭 - '인물 감정 따라가기' 입력 상자 */
        .empathy-input-box {
            background-color: #fff;
            border: 1px solid #fbcfe8; /* pink-200 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1rem; /* p-4 */
            transition: box-shadow 0.2s;
        }
        .empathy-input-box:focus-within {
            box-shadow: 0 0 0 2px #ec4899; /* focus:ring-2 focus:ring-pink-500 */
            border-color: #ec4899;
        }
        .empathy-input-box label {
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem; /* mb-2 */
            display: block;
        }
        .empathy-input-box textarea {
            width: 100%;
            border: 1px solid #fce7f3; /* pink-100 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem; /* p-3 */
            resize: none;
        }
        .empathy-input-box textarea:focus {
            outline: none;
        }

        /* '창문' 탭 - 활성 서브탭 스타일 */
        .window-tab-btn.active {
            border-bottom-color: #3b82f6; /* blue-500 */
            background-color: white;
            color: #3b82f6;
            font-weight: 600;
        }

        /* '창문' 탭 - HMW 문장 생성기 상자 */
        .hmw-display-box {
            display: inline-block;
            background-color: white;
            border: 2px solid #60a5fa; /* blue-400 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.75rem; /* px-3 py-1 */
            font-weight: 600; /* font-semibold */
            color: #1d4ed8; /* blue-700 */
            min-width: 6rem; /* min-w-24 */
            text-align: center;
        }

        /* '창문' 탭 - 포스트잇 (말풍선 모양) */
        .post-it-bubble {
            background-color: #fef9c3; /* yellow-100 */
            border: 2px solid #fde68a; /* yellow-200 */
            color: #713f12; /* yellow-900 */
            padding: 1rem 1.5rem;
            border-radius: 1.5rem; /* rounded-3xl */
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-height: 8rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            word-break: break-word; /* Ensure text wraps */
        }
        .post-it-bubble::after { /* 말풍선 꼬리 */
            content: "";
            position: absolute;
            bottom: -10px;
            left: 20px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid #fde68a; /* yellow-200, Match border */
        }
         .post-it-bubble-inner { /* 내부 컨텐츠 wrapper */
             flex-grow: 1;
         }
        .post-it-name-input {
            width: 100%;
            border: none;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            margin-bottom: 0.5rem; /* mb-2 */
            color: #ca8a04; /* yellow-600 */
            outline: none;
        }
         .post-it-name-input::placeholder {
             color: #facc15; /* yellow-400 */
         }
        .post-it-text-bubble { /* Text area */
            width: 100%;
            border: none;
            background: transparent;
            resize: none;
            outline: none;
            min-height: 3rem;
             flex-grow: 1; /* Allow textarea to grow */
             font-size: 0.875rem; /* text-sm */
        }
        .post-it-delete-bubble {
            position: absolute;
            top: 0.5rem; /* Adjusted position */
            right: 0.5rem;
            background: #ef4444; /* red-500 */
            color: white;
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            border-radius: 9999px; /* rounded-full */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem; /* Smaller text */
            font-weight: bold;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s, transform 0.2s;
            border: 1px solid rgba(255,255,255,0.5); /* Slight border */
            line-height: 1; /* Ensure 'x' is centered */
        }
        .post-it-bubble:hover .post-it-delete-bubble {
            opacity: 1;
            transform: scale(1.1);
        }

        /* '창문' 탭 - SCAMPER 아코디언 */
        .scamper-trigger {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 1rem;
            font-weight: 700;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .scamper-trigger.active, .scamper-trigger:hover {
            background-color: #dbeafe; /* blue-200 */
        }
        .scamper-trigger .scamper-letter {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 900;
            margin-right: 1rem; /* mr-4 */
        }
        .scamper-trigger .scamper-title {
            flex-grow: 1;
            text-align: left;
        }
        .scamper-trigger .scamper-icon {
            transition: transform 0.3s;
        }
        .scamper-trigger.active .scamper-icon {
            transform: rotate(180deg);
        }
        .scamper-content {
            display: none;
            padding: 1rem;
            background-color: #eff6ff; /* blue-50 */
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .scamper-content.active {
            display: block;
        }

        /* '창문' 탭 - 주사위 실험실 */
        .dice-input-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem; /* gap-2 */
        }
        .dice-input {
            width: 100%;
            border: 1px solid #bfdbfe; /* blue-200 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            font-size: 0.875rem; /* text-sm */
            background-color: white;
        }
        #dice-result {
            background-color: #dbeafe; /* blue-200 */
            color: #1e3a8a; /* blue-800 */
            font-weight: 600; /* font-semibold */
            min-height: 4rem; /* min-h-16 */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
        }

        /* '창문' 탭 - 카운트다운 */
        #timer-display {
            font-size: 3rem; /* text-5xl */
            font-weight: 700; /* font-bold */
            color: #1d4ed8; /* blue-700 */
            letter-spacing: 0.05em;
            background-color: #eff6ff; /* blue-50 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem 2rem; /* px-8 py-4 */
            margin-bottom: 1rem; /* mb-4 */
            transition: color 0.3s, background-color 0.3s;
        }
        #timer-display.timer-finished {
            color: #b91c1c; /* red-700 */
            background-color: #fee2e2; /* red-100 */
            animation: pulse-red 1s infinite;
        }
        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .timer-input {
            width: 6rem; /* w-24 */
            text-align: center;
            font-size: 1.125rem; /* text-lg */
            border: 1px solid #93c5fd; /* blue-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.25rem 0.5rem; /* px-2 py-1 */
        }
        .timer-control-btn {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            font-weight: 600; /* font-semibold */
            transition: background-color 0.2s;
        }
        .timer-control-btn:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .timer-control-btn.pause {
            background-color: #f59e0b; /* amber-500 */
        }
        .timer-control-btn.pause:hover {
            background-color: #d97706; /* amber-600 */
        }
        .timer-control-btn.reset {
            background-color: #6b7280; /* gray-500 */
        }
        .timer-control-btn.reset:hover {
            background-color: #4b5563; /* gray-600 */
        }

        /* '미닫이문' 탭 - 활성 서브탭 스타일 */
        .door-tab-btn.active {
            border-bottom-color: #10b981; /* emerald-500 */
            background-color: white;
            color: #10b981;
            font-weight: 600;
        }
        /* '미닫이문' 탭 - 프로토타입 버튼 */
        .prototype-btn {
             background-color: white;
             border: 1px solid #a7f3d0; /* emerald-200 */
             color: #047857; /* emerald-700 */
             padding: 0.75rem 1.25rem; /* px-5 py-3 */
             border-radius: 0.75rem; /* rounded-xl */
             font-weight: 600; /* font-semibold */
             display: inline-flex;
             align-items: center;
             gap: 0.5rem; /* gap-2 */
             transition: all 0.2s;
        }
        .prototype-btn:hover {
            background-color: #d1fae5; /* emerald-100 */
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .prototype-btn.active {
            background-color: #10b981; /* emerald-500 */
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }
        .prototype-content {
            display: none; /* JS로 제어 */
        }
        .prototype-content.active {
            display: block; /* JS로 제어 */
            animation: fadeIn 0.4s ease both; /* 애니메이션 추가 */
        }
        /* 파일 입력 필드 스타일 */
        .file-input-style {
            background-color: #ecfdf5; /* emerald-50 */
            border: 2px dashed #a7f3d0; /* emerald-200 */
            color: #065f46; /* emerald-800 */
            padding: 1.5rem; /* p-6 */
            border-radius: 0.5rem; /* rounded-lg */
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-style:hover {
             background-color: #d1fae5; /* emerald-100 */
        }
        .file-input-style input[type="file"] {
            display: none;
        }
        /* 스케치 그림판 스타일 */
        #sketch-canvas {
            cursor: crosshair;
            touch-action: none; /* Prevent scrolling on canvas */
            width: 100%; /* Ensure canvas takes full width */
            height: 240px; /* Explicit height */
            display: block; /* Remove extra space below */
        }
        .sketch-tool.active {
            background-color: #a7f3d0; /* emerald-200 */
            border-color: #34d399; /* emerald-400 */
            box-shadow: 0 0 0 2px #34d399;
        }
        .sketch-color.active {
            border: 3px solid #059669; /* emerald-600 */
            transform: scale(1.1);
        }

        /* 앱 디자인 스타일 */
        #app-design-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
        }
        .phone-frame {
            width: 300px;
            height: 600px;
            border: 10px solid #1f2937; /* gray-800 */
            border-radius: 40px;
            background-color: #f9fafb; /* gray-50 */
            margin: 1rem auto;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            overflow: hidden; /* Important for containing elements */
        }
        .phone-screen {
            width: 100%;
            height: 100%;
            padding-top: 20px; /* Space for notch */
           /* background-color: white; /* Screen background */
            overflow: hidden; /* Hide overflow for now */
            position: relative; /* Crucial for absolute positioning of elements */
            user-select: none; /* Prevent text selection during drag */
            -webkit-user-select: none;
            touch-action: none; /* Prevent default touch actions like scroll */
        }
         /*.phone-screen::-webkit-scrollbar { width: 4px; }
         .phone-screen::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 20px; }*/
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 20px;
            background-color: #1f2937; /* gray-800 */
            border-radius: 0 0 15px 15px;
            z-index: 10;
        }
        /* App design elements */
        .app-element {
            position: absolute;
            cursor: grab;
            padding: 5px;
            border: 1px dashed transparent;
            min-width: 20px; /* Ensure elements are selectable */
            min-height: 20px;
             touch-action: none; /* Prevent scrolling when dragging elements */
             box-sizing: border-box; /* Include padding and border in element's total width and height */
             /* Prevent contenteditable elements from being dragged while editing text */
             -webkit-user-drag: none;
             user-drag: none;
             overflow: hidden; /* Hide potential overflow during resize */
        }
         .app-element[contenteditable="true"] {
             cursor: text; /* Change cursor for editable text */
             -webkit-user-drag: auto; /* Allow dragging to select text */
             user-drag: auto;
         }
        .app-element.dragging {
            cursor: grabbing;
            opacity: 0.7;
            z-index: 1000; /* Bring to front while dragging */
        }
         .app-element.selected {
             border-color: #60a5fa; /* blue-400 */
             outline: 2px solid #60a5fa; /* Add outline for visibility */
             z-index: 999; /* Bring selected element slightly forward */
             position: relative; /* Needed for absolute positioned handles */
         }
        .app-element.text-element { font-size: 16px; /* Default size */ line-height: 1.2; }
        .app-element.emoji-element { font-size: 24px; /* Default size */ background: none; padding: 0; border: none; }
        .app-element.button-element {
            background-color: #3b82f6; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; /* Default size */
            display: inline-flex; /* Ensure button size wraps content initially */
            align-items: center;
            justify-content: center;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping initially */
            /* overflow: hidden; /* Hide overflow text */ /* Allow overflow for resize handles */
            text-overflow: ellipsis; /* Add ellipsis for overflow */
        }
         .app-element.image-element {
             padding: 0; /* No padding for image container */
             border: none; /* No border for image container initially */
             line-height: 0; /* Remove extra space */
         }
         .app-element.image-element img {
             display: block;
             width: 100%;
             height: 100%;
             object-fit: contain; /* Or 'cover' depending on desired behavior */
             pointer-events: none; /* Prevent img from interfering with drag */
         }
         /* Button Shapes */
         .button-shape-circle {
             border-radius: 50% !important; /* Use important if needed */
             padding: 10px !important;
            /* width: auto !important; /* Let content or aspect ratio determine width */
            /* height: auto !important; /* Adjust height based on aspect ratio */
             aspect-ratio: 1 / 1; /* Force 1:1 aspect ratio */
             box-sizing: border-box; /* Ensure padding is included */
             display: flex; /* Center content in circle */
             align-items: center;
             justify-content: center;
             /* Ensure width and height are equal after resize */
             width: var(--size, 50px); /* Use CSS variable for size */
             height: var(--size, 50px);
         }
         /* Resize Handles */
         .resize-handle {
             position: absolute;
             width: 10px;
             height: 10px;
             background-color: #60a5fa;
             border: 1px solid white;
             border-radius: 2px;
             z-index: 1001; /* Above selected outline */
             display: none; /* Hidden by default */
         }
         .app-element.selected .resize-handle {
             display: block; /* Show handles when selected */
         }
         .resize-handle.top-left { top: -6px; left: -6px; cursor: nwse-resize; }
         .resize-handle.top-right { top: -6px; right: -6px; cursor: nesw-resize; }
         .resize-handle.bottom-left { bottom: -6px; left: -6px; cursor: nesw-resize; }
         .resize-handle.bottom-right { bottom: -6px; right: -6px; cursor: nwse-resize; }


        /* Controls for selected element */
         #element-controls {
            position: fixed;
            bottom: 70px; /* Adjusted position slightly above nav */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap; /* Prevent wrapping */
            visibility: hidden; /* Hidden by default */
            opacity: 0;
            transition: visibility 0s 0.2s, opacity 0.2s ease-out;
            max-width: 98%; /* Maximize available width */
            overflow-x: auto; /* Allow horizontal scroll if needed */
            white-space: nowrap; /* Prevent text wrapping */
         }
          #element-controls.visible {
              visibility: visible;
              opacity: 1;
              transition: opacity 0.2s ease-out;
          }
         #element-controls label, #element-controls input, #element-controls select, #element-controls button {
             font-size: 11px;
             margin: 0;
             padding: 3px 4px;
             flex-shrink: 0; /* Prevent shrinking */
         }
         #element-controls label {
             white-space: nowrap; /* Keep label text on one line */
         }
          #element-controls input[type="color"] {
              width: 24px;
              height: 24px;
              border: none;
              padding: 0;
              border-radius: 4px;
              cursor: pointer;
              background-color: transparent; /* Remove default background */
              -webkit-appearance: none; /* Override default appearance */
              appearance: none;
          }
           #element-controls input[type="color"]::-webkit-color-swatch-wrapper {
               padding: 0; /* Remove padding */
           }
           #element-controls input[type="color"]::-webkit-color-swatch {
               border: 1px solid #ccc; /* Add a border */
               border-radius: 4px;
           }
            #element-controls input[type="number"] {
                width: 45px;
                 border: 1px solid #ccc;
                 border-radius: 4px;
            }
            #element-controls select {
                 border: 1px solid #ccc;
                 border-radius: 4px;
                height: 26px; /* Match height */
                min-width: 70px; /* Ensure select has minimum width */
            }
         #delete-element-btn {
             background-color: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 4px 6px;
         }
         #delete-element-btn:hover { background-color: #dc2626; }


        /* Emoji Picker Modal */
        #emoji-picker-modal {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 1002;
            display: none; align-items: center; justify-content: center; padding: 1rem;
        }
        #emoji-picker-modal.visible { display: flex; }
        #emoji-picker-content {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 400px;
            max-height: 80vh; overflow-y: auto; display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem;
            position: relative; /* For positioning close button */
        }
        #emoji-picker-content button { font-size: 1.8rem; background: none; border: none; cursor: pointer; transition: transform 0.1s; }
        #emoji-picker-content button:hover { transform: scale(1.2); }
         #close-emoji-picker-inner { /* Style for the inner close button */
             position: absolute;
             top: 8px;
             right: 12px;
             font-size: 1.5rem;
             line-height: 1;
             padding: 0;
             color: #9ca3af; /* gray-400 */
         }
         #close-emoji-picker-inner:hover {
             color: #374151; /* gray-700 */
         }

        /* App Design Page Navigation */
         #app-page-nav {
             display: flex;
             justify-content: center;
             align-items: center;
             gap: 1rem;
             margin-top: 1rem;
         }

         /* Specific Font Styles */
         .font-noto-sans-kr { font-family: 'Noto Sans KR', sans-serif; }
         .font-nanum-gothic { font-family: 'Nanum Gothic', sans-serif; }
         .font-nanum-myeongjo { font-family: 'Nanum Myeongjo', serif; }
         .font-gowun-dodum { font-family: 'Gowun Dodum', sans-serif; }
         .font-east-sea-dokdo { font-family: 'East Sea Dokdo', cursive; }
         .font-black-han-sans { font-family: 'Black Han Sans', sans-serif; }
         .font-single-day { font-family: 'Single Day', cursive; }
         .font-grandiflora-one { font-family: 'Grandiflora One', cursive; }

        /* '어둠' 탭 - 이모지 문장 상자 (신규) */
        #reflection-emoji-sentence-box {
            background-color: white;
            border: 1px solid #e9d5ff; /* violet-200 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem; /* p-3 */
            min-height: 7rem; /* min-h-28 */
            display: flex;
            flex-wrap: wrap;
            align-items: center; /* 변경: 세로 가운데 정렬 */
            justify-content: center; /* 추가: 가로 가운데 정렬 */
            gap: 0.25rem; /* gap-1 */
            cursor: text;
        }
        #reflection-emoji-sentence-box .placeholder {
            color: #a78bfa; /* violet-400 */
            font-size: 0.875rem; /* text-sm */
            pointer-events: none;
            width: 100%; /* 추가: 너비 전체 차지 */
            text-align: center; /* 추가: 가운데 정렬 */
        }
        .selected-reflection-emoji {
            font-size: 2.25rem; /* 변경: text-3xl -> text-4xl */
            padding: 0.25rem;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }
        .selected-reflection-emoji:hover {
            background-color: #f3e8ff; /* violet-100 */
        }

        /* '어둠' 탭 - 이모지 피커 모달 (신규) */
        #reflection-emoji-picker-modal-new {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); z-index: 1002;
            display: none; align-items: center; justify-content: center; padding: 1rem;
        }
        #reflection-emoji-picker-modal-new.visible { display: flex; }
        #reflection-emoji-picker-content-new {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem; max-width: 480px;
            max-height: 80vh; overflow-y: auto; display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.5rem;
            position: relative; /* For positioning close button */
        }
        #reflection-emoji-picker-content-new button {
            font-size: 1.8rem; background: none; border: none; cursor: pointer; transition: transform 0.1s;
            padding: 0.25rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        #reflection-emoji-picker-content-new button:hover {
            transform: scale(1.2);
            background-color: #f5f3ff; /* violet-50 */
        }
         #close-reflection-emoji-picker-new {
             position: absolute;
             top: 8px;
             right: 12px;
             font-size: 1.5rem;
             line-height: 1;
             padding: 0;
             color: #9ca3af; /* gray-400 */
             background: none;
             border: none;
             cursor: pointer;
         }
         #close-reflection-emoji-picker-new:hover {
             color: #374151; /* gray-700 */
         }

        /* Padlet Embed Styles */
        #content-dictionary {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            min-height: 500px;
        }
        #content-dictionary.hidden {
            display: none !important;
        }
        #content-dictionary iframe.padlet-embed {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e5e7eb;
        }
        body.dark-mode .content-card {
            background-color: rgba(30, 30, 30, 0.8);
            border-color: rgba(255, 255, 255, 0.1);
        }
        body.dark-mode main#main-content {
            background-color: rgba(20, 20, 20, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
        }
        body.dark-mode textarea,
        body.dark-mode input[type="text"],
        body.dark-mode input[type="number"],
        body.dark-mode select {
            background-color: #2d2d2d;
            color: #e5e7eb;
            border-color: #404040;
        }
        body.dark-mode .bg-amber-50 { background-color: #3a2a1a !important; }
        body.dark-mode .bg-pink-50 { background-color: #3a1a2a !important; }
        body.dark-mode .bg-blue-50 { background-color: #1a2a3a !important; }
        body.dark-mode .bg-emerald-50 { background-color: #1a3a2a !important; }
        body.dark-mode .bg-violet-50 { background-color: #2a1a3a !important; }
        body.dark-mode .bg-red-50 { background-color: #3a1a1a !important; }
        body.dark-mode .text-gray-500 { color: #9ca3af !important; }
        body.dark-mode .text-gray-600 { color: #d1d5db !important; }
        body.dark-mode .text-gray-700 { color: #e5e7eb !important; }
        body.dark-mode .text-gray-800 { color: #f3f4f6 !important; }
        body.dark-mode .border-gray-200 { border-color: #404040 !important; }
        body.dark-mode .border-gray-300 { border-color: #505050 !important; }

        /* Top Control Bar */
        .top-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            display: flex;
            gap: 0.5rem;
            align-items: center;
            transition: all 0.3s ease;
        }
        .control-btn {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .control-btn svg {
            width: 20px;
            height: 20px;
            transition: all 0.3s ease;
        }
        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        body.dark-mode .control-btn {
            background: #2d2d2d;
            border-color: #404040;
            color: #e5e7eb;
        }

        /* 반응형 크기 조정 - 부드러운 전환 */
        @media (max-width: 768px) {
            .top-controls {
                top: 0.75rem;
                right: 0.75rem;
                gap: 0.4rem;
            }
            .control-btn {
                padding: 0.45rem;
            }
            .control-btn svg {
                width: 18px;
                height: 18px;
            }
        }

        @media (max-width: 640px) {
            .top-controls {
                top: 0.5rem;
                right: 0.5rem;
                gap: 0.3rem;
            }
            .control-btn {
                padding: 0.4rem;
                border-width: 1.5px;
            }
            .control-btn svg {
                width: 16px;
                height: 16px;
            }
            header h1 {
                font-size: 2.5rem !important;
            }
        }

        @media (max-width: 480px) {
            .top-controls {
                top: 0.5rem;
                right: 0.5rem;
                gap: 0.25rem;
            }
            .control-btn {
                padding: 0.35rem;
                border-width: 1px;
            }
            .control-btn svg {
                width: 14px;
                height: 14px;
            }
        }
    </style>
</head>
<body class="text-gray-800 pb-24">
    <!-- Top Control Bar -->
    <div class="top-controls">
        <!-- Language Toggle -->
        <button id="lang-toggle" class="control-btn" title="Language / 언어">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
        </button>
        <!-- Theme Toggle -->
        <button id="theme-toggle" class="control-btn" title="Dark/Light Mode">
            <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
            </svg>
        </button>
        <!-- Backup Download -->
        <button id="backup-download" class="control-btn" title="Download Backup">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
            </svg>
        </button>
        <!-- Backup Upload -->
        <button id="backup-upload" class="control-btn" title="Upload Backup">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L9 8m4-4v12"/>
            </svg>
        </button>
    </div>
    <input type="file" id="backup-file-input" accept="application/json" style="display: none;">

    <!-- Hidden file input for image upload -->
    <input type="file" id="image-upload-input" accept="image/png, image/jpeg, image/gif" style="display: none;">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <!-- 앱 헤더 -->
        <header class="text-center mb-8">
            <h1 id="app-title" class="grandiflora text-5xl md:text-7xl font-bold text-orange-500 drop-shadow-md cursor-pointer hover:text-orange-600 transition-colors">
                홍당뮤
            </h1>
            <p class="grandiflora text-gray-600 mt-6 text-xl md:text-2xl font-bold">
                With. 디자인씽킹
            </p>
        </header>

        <!-- 시작 페이지 -->
        <div id="home-page" class="text-center flex flex-col items-center justify-center py-16 animate-fade-in">
            <div class="mb-8 animate-bounce">
                <img src="https://i.ibb.co/jP4NnLp1/Chat-GPT-Image-2025-10-24-01-41-59.png" alt="홍당뮤 캐릭터" class="w-48 h-48 md:w-64 md:h-64 mx-auto">
            </div>
            <h2 class="grandiflora text-4xl font-bold text-orange-500">홍당뮤에 온 걸 환영해!</h2>
            <p class="text-gray-700 font-bold mt-4 mb-8 text-lg">홍익인간 = 당신의 생각 + 뮤지컬</p>
            <button id="manual-button" class="bg-orange-400 hover:bg-orange-500 text-white font-bold text-xl px-8 py-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-2 mb-6">
                설명서 📖
            </button>

            <!-- Additional Navigation Buttons -->
            <div class="flex flex-wrap gap-4 justify-center mt-4">
                <button data-tab="fruit" class="extra-nav-button bg-red-100 hover:bg-red-200 text-red-700 font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-2">
                    <i data-lucide="apple" class="w-5 h-5"></i>
                    열매맺기
                </button>
                <button data-tab="dictionary" class="extra-nav-button bg-teal-100 hover:bg-teal-200 text-teal-700 font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-2">
                    <i data-lucide="book-marked" class="w-5 h-5"></i>
                    생각사전
                </button>
                <button data-tab="report" class="extra-nav-button bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all duration-300 transform hover:scale-105 inline-flex items-center gap-2">
                    <i data-lucide="file-bar-chart" class="w-5 h-5"></i>
                    보고서
                </button>
            </div>
        </div>

        <!-- 메인 콘텐츠 (탭) -->
        <main id="main-content" class="hidden bg-white/70 backdrop-blur-lg rounded-2xl shadow-lg border border-gray-200">
            <div class="p-6 md:p-8">
                <!-- 1. 빛 (영감) 콘텐츠 -->
                <div id="content-light" class="tab-content space-y-6 animate-fade-in">
                     <h2 class="text-2xl font-bold text-amber-500">1단계: 생각의 시작 (빛) - 반짝! 영감 얻기</h2>
                    <p class="text-gray-600">뮤지컬을 감상하고, 떠오르는 생각과 느낌을 자유롭게 정리해봐요.</p>

                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">✨ 뮤지컬 조각 카드</h3>
                        <p class="text-sm text-gray-500 mb-4">이야기, 음악, 움직임, 무대미술 중 인상 깊었던 요소를 기록해 보세요.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- 이야기 카드 -->
                            <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <label for="card-story" class="font-bold text-amber-800">📖 이야기 (Story)</label>
                                <textarea id="card-story" rows="3" class="mt-2 w-full bg-white border border-amber-200 rounded-lg p-2 text-sm text-amber-900 focus:ring-1 focus:ring-amber-400 focus:outline-none placeholder:text-amber-600/70" placeholder="가장 기억에 남는 장면이나 대사는?"></textarea>
                            </div>
                            <!-- 음악 카드 -->
                            <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <label for="card-music" class="font-bold text-amber-800">🎵 음악 (Music)</label>
                                <textarea id="card-music" rows="3" class="mt-2 w-full bg-white border border-amber-200 rounded-lg p-2 text-sm text-amber-900 focus:ring-1 focus:ring-amber-400 focus:outline-none placeholder:text-amber-600/70" placeholder="기억에 남는 노래나 멜로디는?"></textarea>
                            </div>
                            <!-- 움직임 카드 -->
                            <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <label for="card-movement" class="font-bold text-amber-800">💃 움직임 (Movement)</label>
                                <textarea id="card-movement" rows="3" class="mt-2 w-full bg-white border border-amber-200 rounded-lg p-2 text-sm text-amber-900 focus:ring-1 focus:ring-amber-400 focus:outline-none placeholder:text-amber-600/70" placeholder="인상 깊었던 춤이나 동작은?"></textarea>
                            </div>
                            <!-- 무대미술 카드 -->
                            <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <label for="card-stage" class="font-bold text-amber-800">🎨 무대미술 (Stage Art)</label>
                                <textarea id="card-stage" rows="3" class="mt-2 w-full bg-white border border-amber-200 rounded-lg p-2 text-sm text-amber-900 focus:ring-1 focus:ring-amber-400 focus:outline-none placeholder:text-amber-600/70" placeholder="무대, 조명, 의상 중 기억에 남는 것은?"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">💖 나의 감상평</h3>
                        <p class="text-sm text-gray-500 mb-4">지금 나의 감정을 이모지로 표현하고, 한 줄 감상평을 남겨주세요.</p>
                        <div id="emoji-selector" class="flex justify-around items-center p-3 bg-amber-50 rounded-lg mb-4">
                            <button class="emoji-btn text-4xl p-2 rounded-full transition-transform duration-200 hover:scale-110" data-emoji="😍">😍</button>
                            <button class="emoji-btn text-4xl p-2 rounded-full transition-transform duration-200 hover:scale-110" data-emoji="😂">😂</button>
                            <button class="emoji-btn text-4xl p-2 rounded-full transition-transform duration-200 hover:scale-110" data-emoji="😢">😢</button>
                            <button class="emoji-btn text-4xl p-2 rounded-full transition-transform duration-200 hover:scale-110" data-emoji="🤔">🤔</button>
                            <button class="emoji-btn text-4xl p-2 rounded-full transition-transform duration-200 hover:scale-110" data-emoji="🔥">🔥</button>
                        </div>
                        <input type="hidden" id="selected-emoji" value="">
                        <textarea id="review-text" class="w-full h-24 bg-white border border-gray-300 rounded-lg p-3 text-gray-800 focus:ring-2 focus:ring-amber-400 focus:outline-none placeholder:text-gray-500" placeholder="한 줄 감상평을 입력하세요..."></textarea>
                    </div>

                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">❓ 질문상자 </h3>
                        <p class="text-sm text-gray-500 mb-4">"왜 그랬을까?" "나라면 어땠을까?" 작품을 보며 생긴 질문들을 던져보세요.</p>
                        <div class="flex gap-4 mb-4">
                            <input type="text" id="question-input" class="flex-grow bg-white border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-amber-400 focus:outline-none" placeholder="질문을 입력하세요...">
                            <button id="add-question-btn" class="bg-amber-400 hover:bg-amber-500 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow hover:shadow-md">등록</button>
                        </div>
                        <ul id="question-list" class="space-y-2">
                            <!-- 질문이 여기에 추가됩니다 -->
                            <li class="p-3 bg-amber-50 border border-amber-100 rounded-lg text-amber-900 text-sm hidden" id="question-placeholder">등록된 질문이 없습니다.</li>
                        </ul>
                    </div>
                </div>

                <!-- 2. 거울 (공감/정의) 콘텐츠 -->
                <div id="content-mirror" class="tab-content space-y-6 hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-pink-500">2단계: 나를 비추는 (거울) - 끄덕! 공감하고 문제 정의하기</h2>
                    <p class="text-gray-600">뮤지컬 속 인물의 감정과 고민에 공감하고, 나의 경험과 연결하며 문제를 정의합니다.</p>

                    <!-- '공감' / '정의' 서브 탭 네비게이션 -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex gap-2" aria-label="Tabs">
                            <button class="mirror-tab-btn active w-1/2 py-3 px-1 text-center border-b-4 text-sm font-medium rounded-t-lg transition-colors duration-200 ease-out hover:bg-pink-50" data-tab="empathy">
                                🪞 공감하기
                            </button>
                            <button class="mirror-tab-btn w-1/2 py-3 px-1 text-center border-b-4 border-transparent text-gray-500 text-sm font-medium rounded-t-lg transition-colors duration-200 ease-out hover:bg-pink-50" data-tab="definition">
                                ✏️ 문제 정의하기
                            </button>
                        </nav>
                    </div>

                    <!-- 2-1. 공감하기 탭 콘텐츠 -->
                    <div id="mirror-content-empathy" class="mirror-content space-y-6 animate-fade-in">
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 text-center flex items-center justify-center gap-2">❤️ 인물 감정 따라가기</h3>
                            <p class="text-sm text-gray-500 mb-6 text-center">인물의 '상황', '말', '행동'을 떠올려보고 중앙에 인물 이름을 적어보세요.</p>

                            <!-- '인물 감정 따라가기' UI -->
                            <div class="space-y-4">
                                <!-- 인물 이름 -->
                                <div class="empathy-input-box">
                                    <label for="pov-character-name" class="text-cyan-600">👤 인물 이름</label>
                                    <input type="text" id="pov-character-name" placeholder="인물의 이름을 적어주세요" class="w-full border border-pink-200 rounded-lg p-3 font-semibold text-pink-800 placeholder:text-pink-400/80 focus:outline-none focus:ring-1 focus:ring-pink-500">
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <!-- 상황 -->
                                    <div class="empathy-input-box">
                                        <label for="empathy-situation" class="text-cyan-600">🧊 상황</label>
                                        <textarea id="empathy-situation" rows="4" class="text-cyan-900 bg-cyan-50/50 placeholder:text-cyan-600/70" placeholder="어떤 상황이었나요?"></textarea>
                                    </div>
                                    <!-- 말 -->
                                    <div class="empathy-input-box">
                                        <label for="empathy-speech" class="text-yellow-700">💬 말 (대사/가사)</label>
                                        <textarea id="empathy-speech" rows="4" class="text-yellow-900 bg-yellow-50/50 placeholder:text-yellow-700/70" placeholder="무슨 말을 했나요?"></textarea>
                                    </div>
                                    <!-- 행동 -->
                                    <div class="empathy-input-box">
                                        <label for="empathy-action" class="text-fuchsia-600">🏃 행동</label>
                                        <textarea id="empathy-action" rows="4" class="text-fuchsia-900 bg-fuchsia-50/50 placeholder:text-fuchsia-600/70" placeholder="어떤 행동을 했나요?"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🤔 인물의 고민과 속마음 (니즈 찾기)</h3>
                            <p class="text-sm text-gray-500 mb-4">"이 인물은 무엇을 원했을까?" 질문에 답해보고, 인물의 감정을 슬라이더로 조절해 보세요.</p>
                            <textarea class="w-full h-24 bg-pink-50 border border-pink-200 rounded-lg p-3 text-pink-900 focus:ring-2 focus:ring-pink-400 focus:outline-none placeholder:text-pink-600/70" placeholder="이 인물이 정말 원했던 것은..."></textarea>
                            <div class="mt-4">
                                <label for="emotion-slider" class="block text-sm font-medium text-gray-700 mb-2">감정 조절하기 (예: 슬픔 😥 ... 기쁨 😀)</label>
                                <input type="range" id="emotion-slider" class="emotion-slider" min="0" max="100" value="50">
                            </div>
                        </div>

                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🔗 나의 경험과 연결하기</h3>
                            <p class="text-sm text-gray-500 mb-4">인물의 감정이나 상황과 비슷한 나의 경험을 적어보세요.</p>
                            <textarea class="w-full h-32 bg-pink-50 border border-pink-200 rounded-lg p-3 text-pink-900 focus:ring-2 focus:ring-pink-400 focus:outline-none placeholder:text-pink-600/70" placeholder="나도 예전에..."></textarea>
                        </div>
                    </div>

                    <!-- 2-2. 문제 정의하기 탭 콘텐츠 -->
                    <div id="mirror-content-definition" class="mirror-content space-y-6 hidden animate-fade-in">
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">🎯 POV(Point of View) 작성기</h3>
                            <p class="text-sm text-gray-500 mb-4">인물의 입장에서 '필요한 것(Need)'과 그 '이유(Insight)'를 정의해 보세요.</p>
                            <div class="space-y-4">
                                <div>
                                    <label for="pov-need" class="block text-sm font-bold text-gray-700 mb-1">필요한 것 (Need)</label>
                                    <textarea id="pov-need" rows="2" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="예: 자신의 마음을 솔직하게 표현할 용기"></textarea>
                                </div>
                                <div>
                                    <label for="pov-reason" class="block text-sm font-bold text-gray-700 mb-1">이유 (Reason / Insight)</label>
                                    <textarea id="pov-reason" rows="3" class="w-full bg-white border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-pink-400 focus:outline-none" placeholder="예: 오해받는 것이 두렵고, 친구를 잃고 싶지 않기 때문에"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🤖 자동 문장 생성 가이드</h3>
                            <p class="text-sm text-gray-500 mb-4">작성한 내용을 바탕으로 자동으로 생성된 POV 문장을 확인해 보세요.</p>
                            <div id="pov-sentence-display" class="bg-pink-50 border border-pink-200 rounded-lg p-4 text-pink-800 font-medium leading-relaxed min-h-[8rem] flex items-center justify-center">
                                <div>
                                    <span class="font-bold">[인물]</span>은(는) <span class="font-bold text-pink-600">[필요한 것]</span>을(를) 필요로 한다.
                                    <br>
                                    왜냐하면 <span class="font-bold text-pink-600">[이유/생각]</span> 때문이다.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 창문 (재정의/아이디어) 콘텐츠 -->
                <div id="content-window" class="tab-content space-y-6 hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-blue-500">3단계: 세상을 보는 (창문) - 상상! 아이디어 펼치기</h2>
                    <p class="text-gray-600">우리가 발견한 문제를 더 나은 세상을 위한 질문으로 바꾸고, 창의적인 아이디어를 자유롭게 상상해 보세요.</p>

                    <!-- '재정의' / '아이디어' 서브 탭 네비게이션 -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex gap-2" aria-label="Tabs">
                            <button class="window-tab-btn active w-1/2 py-3 px-1 text-center border-b-4 text-sm font-medium rounded-t-lg transition-colors duration-200 ease-out hover:bg-blue-50" data-tab="redefine">
                                🪟 문제 재정의
                            </button>
                            <button class="window-tab-btn w-1/2 py-3 px-1 text-center border-b-4 border-transparent text-gray-500 text-sm font-medium rounded-t-lg transition-colors duration-200 ease-out hover:bg-blue-50" data-tab="idea">
                                💡 아이디어
                            </button>
                        </nav>
                    </div>

                    <!-- 3-1. 문제 재정의 탭 콘텐츠 -->
                    <div id="window-content-redefine" class="window-content space-y-6 animate-fade-in">
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">👥 참여자 선택</h3>
                            <p class="text-sm text-gray-500 mb-4">문제를 함께 재정의할 사람의 이름을 적어보세요.</p>
                            <input type="text" class="w-full bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-900 focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder:text-blue-600/70" placeholder="예: 김홍익, 박당근, 이뮤이">
                        </div>
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">🔄 문제 재정의하기 (HMW)</h3>
                            <p class="text-sm text-gray-500 mb-4">아래 템플릿의 <span class="font-bold text-blue-600">[사용자]</span>와 <span class="font-bold text-blue-600">[원하는 것]</span>을 채워 HMW 질문을 완성해 보세요.</p>

                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                                <!-- Line 1 -->
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-medium text-gray-700">우리는 어떻게 하면</span>
                                    <input type="text" id="window-hmw-user" class="flex-grow bg-white border border-blue-300 rounded-lg p-2 font-semibold text-blue-700 placeholder:text-blue-400/80 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0 text-center" placeholder="[사용자]">
                                    <span class="font-medium text-gray-700">이/가</span>
                                </div>

                                <!-- Line 2 -->
                                <div class="flex items-center gap-2 flex-wrap">
                                    <input type="text" id="window-hmw-need" class="flex-grow bg-white border border-blue-300 rounded-lg p-2 font-semibold text-blue-700 placeholder:text-blue-400/80 focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0 text-center" placeholder="[원하는 것]">
                                    <span class="font-medium text-gray-700">할 수 있을까?</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-2. 아이디어 탭 콘텐츠 -->
                    <div id="window-content-idea" class="window-content space-y-6 hidden animate-fade-in">
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">💡 HMW(How Might We) 문장 생성기</h3>
                            <p class="text-sm text-gray-500 mb-4">'문제 재정의' 탭에서 작성한 내용이 긍정적인 질문으로 자동 변환됩니다.</p>
                            <div id="hmw-sentence-display" class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-blue-800 font-medium leading-relaxed min-h-[6rem] flex items-center justify-center text-center flex-wrap gap-2">
                                <span class="text-lg">우리는 어떻게 하면</span>
                                <span id="hmw-display-user" class="hmw-display-box">[사용자]</span>
                                <span class="text-lg">이/가</span>
                                <span id="hmw-display-need" class="hmw-display-box">[원하는 것]</span>
                                <span class="text-lg">할 수 있을까?</span>
                            </div>
                        </div>

                         <div class="content-card p-6 rounded-xl shadow-sm">
                             <h3 class="font-bold text-lg mb-2 flex items-center gap-2">☁️ 생각구름 (브레인스토밍)</h3>
                             <p class="text-sm text-gray-500 mb-4">HMW 질문에 대한 아이디어를 말풍선에 자유롭게 적어보세요.</p>
                             <div class="flex flex-col sm:flex-row gap-4 mb-4">
                                 <input type="text" id="idea-name-input" class="w-full sm:w-1/3 bg-white border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="이름">
                                 <input type="text" id="idea-bubble-input" class="flex-grow bg-white border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="아이디어를 입력하세요...">
                                 <button id="add-idea-bubble-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors shadow hover:shadow-md sm:w-auto w-full">추가</button>
                             </div>
                             <div id="idea-bubble-list-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                 <!-- 아이디어 말풍선이 여기에 추가됩니다 -->
                             </div>
                         </div>


                        <!-- SCAMPER 유레카! (신규) -->
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🪄 SCAMPER 유레카!</h3>
                            <p class="text-sm text-gray-500 mb-4">기존 아이디어를 7가지 질문으로 비틀어 새로운 아이디어를 발견해 보세요!</p>
                            <div id="scamper-accordion" class="space-y-2">
                                <!-- S: Substitute -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-red-500">S</span>
                                        <span class="scamper-title">바꾸면? (Substitute)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">무엇을 대신 사용하거나 바꿀 수 있을까?</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: 종이 포스터 대신 '움직이는' 이모티콘으로 만들기"></textarea>
                                    </div>
                                </div>
                                <!-- C: Combine -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-orange-500">C</span>
                                        <span class="scamper-title">합치면? (Combine)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">무엇과 합칠 수 있을까?</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: '칭찬 앱'과 '학교 급식표'를 합치기"></textarea>
                                    </div>
                                </div>
                                <!-- A: Adapt -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-yellow-500">A</span>
                                        <span class="scamper-title">따라하면? (Adapt)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">어디서 아이디어를 빌려올 수 있을까?</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: 게임 속 '퀘스트' 방식을 빌려와서 칭찬 퀘스트 만들기"></textarea>
                                    </div>
                                </div>
                                <!-- M: Modify -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-green-500">M</span>
                                        <span class="scamper-title">크게/작게? (Modify)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">무엇을 더하거나 뺄 수 있을까? (크기, 모양, 색...)</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: 하루에 딱 한 명에게만 칭찬 보내기 (제한하기)"></textarea>
                                    </div>
                                </div>
                                <!-- P: Put to other uses -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-blue-500">P</span>
                                        <span class="scamper-title">다르게 쓰면? (Put...)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">이걸 다른 곳에 쓸 수 있을까?</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: 칭찬 앱을 '가족'에게도 사용하기"></textarea>
                                    </div>
                                </div>
                                <!-- E: Eliminate -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-indigo-500">E</span>
                                        <span class="scamper-title">빼면? (Eliminate)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">무엇을 없애거나 단순하게 만들 수 있을까?</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: '글자' 없이 '그림'으로만 칭찬하기"></textarea>
                                    </div>
                                </div>
                                <!-- R: Reverse -->
                                <div>
                                    <button class="scamper-trigger bg-blue-100 border border-blue-200 text-blue-800">
                                        <span class="scamper-letter text-violet-500">R</span>
                                        <span class="scamper-title">뒤집으면? (Reverse)</span>
                                        <i data-lucide="chevron-down" class="scamper-icon"></i>
                                    </button>
                                    <div class="scamper-content">
                                        <p class="text-sm text-blue-700 mb-2">순서나 역할을 거꾸로 뒤집을 수 있을까?</p>
                                        <textarea rows="3" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm" placeholder="예: '칭찬 받기'가 아니라 '먼저 칭찬하기' 미션 주기"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 주사위 실험실 (신규) -->
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🎲 주사위 실험실</h3>
                            <p class="text-sm text-gray-500 mb-4">주사위 면에 아이디어를 적고, 주사위를 굴려 나온 아이디어들을 조합해 보세요!</p>

                            <div class="mb-4">
                                <label for="dice-count-select" class="font-medium text-gray-700 mr-2">주사위 갯수 선택:</label>
                                <select id="dice-count-select" class="rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="1">1개</option>
                                    <option value="2">2개</option>
                                    <option value="3" selected>3개</option>
                                </select>
                            </div>

                            <div id="dice-inputs-container" class="space-y-6">
                                <!-- 주사위 1 -->
                                <div id="die-1" class="dice-group p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 class="font-bold text-blue-700 mb-3">주사위 1 (예: 누가?)</h4>
                                    <div class="dice-input-group">
                                        <input type="text" class="dice-input" placeholder="면 1: 내가">
                                        <input type="text" class="dice-input" placeholder="면 2: 친구가">
                                        <input type="text" class="dice-input" placeholder="면 3: 선생님이">
                                        <input type="text" class="dice-input" placeholder="면 4: 부모님이">
                                        <input type="text" class="dice-input" placeholder="면 5: 우리 반 전체가">
                                        <input type="text" class="dice-input" placeholder="면 6: 전교생이">
                                    </div>
                                </div>
                                <!-- 주사위 2 -->
                                <div id="die-2" class="dice-group p-4 bg-green-50 rounded-lg border border-green-200">
                                    <h4 class="font-bold text-green-700 mb-3">주사위 2 (예: 무엇을?)</h4>
                                    <div class="dice-input-group">
                                        <input type="text" class="dice-input" placeholder="면 1: 칭찬을">
                                        <input type="text" class="dice-input" placeholder="면 2: 감사를">
                                        <input type="text" class="dice-input" placeholder="면 3: 사과를">
                                        <input type="text" class="dice-input" placeholder="면 4: 응원을">
                                        <input type="text" class="dice-input" placeholder="면 5: 선물을">
                                        <input type="text" class="dice-input" placeholder="면 6: 편지를">
                                    </div>
                                </div>
                                <!-- 주사위 3 -->
                                <div id="die-3" class="dice-group p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                    <h4 class="font-bold text-yellow-700 mb-3">주사위 3 (예: 어떻게?)</h4>
                                    <div class="dice-input-group">
                                        <input type="text" class="dice-input" placeholder="면 1: 앱으로">
                                        <input type="text" class="dice-input" placeholder="면 2: 노래로">
                                        <input type="text" class="dice-input" placeholder="면 3: 그림으로">
                                        <input type="text" class="dice-input" placeholder="면 4: 말로">
                                        <input type="text" class="dice-input" placeholder="면 5: 게임으로">
                                        <input type="text" class="dice-input" placeholder="면 6: 몰래">
                                    </div>
                                </div>
                            </div>

                            <button id="roll-dice-btn" class="mt-6 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg shadow hover:shadow-md transition-all transform hover:scale-105 flex items-center justify-center gap-2">
                                <i data-lucide="dice-5"></i> 주사위 굴리기!
                            </button>

                            <div id="dice-result" class="mt-4">
                                여기에 조합된 아이디어가 나옵니다!
                            </div>
                        </div>

                        <!-- 삼삼오오 카운트다운 (신규) -->
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">⏰ 삼삼오오 카운트다운</h3>
                            <p class="text-sm text-gray-500 mb-4">제한 시간(기본 5분) 동안 3가지 아이디어를 빠르게 생각해 보세요!</p>

                            <div class="flex flex-col items-center">
                                <div id="timer-display">05:00</div>
                                <div class="flex items-center gap-2 mb-4">
                                    <input type="number" id="timer-minutes" class="timer-input" value="5" min="0" max="59">
                                    <span class="font-bold text-lg">:</span>
                                    <input type="number" id="timer-seconds" class="timer-input" value="0" min="0" max="59">
                                </div>
                                <div class="flex gap-3">
                                    <button id="timer-start" class="timer-control-btn">시작</button>
                                    <button id="timer-pause" class="timer-control-btn pause">일시정지</button>
                                    <button id="timer-reset" class="timer-control-btn reset">초기화</button>
                                </div>
                            </div>

                            <div class="mt-6">
                                <label for="countdown-idea-result" class="font-medium text-gray-700 mb-2 block">선택된 아이디어</label>
                                <textarea id="countdown-idea-result" rows="3" class="w-full bg-white border border-gray-300 rounded-lg p-3 text-gray-800 focus:ring-2 focus:ring-blue-400 focus:outline-none" placeholder="카운트다운 후 결정된 최종 아이디어를 적어주세요."></textarea>
                            </div>
                        </div>

                        <!-- 최종 아이디어 정리 (신규) -->
                        <div class="content-card p-6 rounded-xl shadow-sm bg-blue-100 border border-blue-300">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2 text-blue-800">🌟 최종 아이디어</h3>
                            <p class="text-sm text-blue-700 mb-4">위의 활동을 통해 결정된 우리 팀의 최종 아이디어를 정리해 보세요.</p>
                            <textarea rows="5" class="w-full bg-white border border-blue-200 rounded-lg p-3 text-lg font-semibold text-blue-900 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="우리의 최종 아이디어는..."></textarea>
                        </div>

                    </div>
                </div>

                <!-- 4. 미닫이문 (제작) 콘텐츠 -->
                <div id="content-door" class="tab-content space-y-6 hidden animate-fade-in">
                     <h2 class="text-2xl font-bold text-emerald-500">4단계: 세상으로 나아가는 (미닫이문) - 뚝딱! 만들어보기</h2>

                    <!-- '프로토타입' / '테스트' 서브 탭 네비게이션 -->
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex gap-2" aria-label="Tabs">
                            <button class="door-tab-btn active w-1/2 py-3 px-1 text-center border-b-4 text-sm font-medium rounded-t-lg transition-colors duration-200 ease-out hover:bg-emerald-50" data-tab="prototype">
                                🛠️ 프로토타입
                            </button>
                            <button class="door-tab-btn w-1/2 py-3 px-1 text-center border-b-4 border-transparent text-gray-500 text-sm font-medium rounded-t-lg transition-colors duration-200 ease-out hover:bg-emerald-50" data-tab="test">
                                💬 테스트
                            </button>
                        </nav>
                    </div>

                    <!-- 4-1. 프로토타입 탭 콘텐츠 -->
                    <div id="door-content-prototype" class="door-content space-y-6 animate-fade-in">
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-4 flex items-center gap-2">🛠️ 아이디어 제작소</h3>
                            <p class="text-sm text-gray-500 mb-6">아이디어를 어떤 형태로 만들어 볼까요? 아래 버튼 중 하나를 선택하고 내용을 채워보세요.</p>

                            <div id="prototype-type-selector" class="flex flex-wrap gap-3 mb-6">
                                <button class="prototype-btn active" data-type="sketch"><i data-lucide="pencil-line"></i> 스케치</button>
                                <button class="prototype-btn" data-type="photo"><i data-lucide="camera"></i> 사진</button>
                                <button class="prototype-btn" data-type="improv"><i data-lucide="theater"></i> 즉흥극</button>
                                <button class="prototype-btn" data-type="story"><i data-lucide="book-text"></i> 이야기</button>
                                <button class="prototype-btn" data-type="video"><i data-lucide="film"></i> 영상</button>
                                <button class="prototype-btn" data-type="appdesign"><i data-lucide="smartphone"></i> 앱 디자인</button> <!-- 앱 디자인 버튼 추가 -->
                            </div>

                            <div id="prototype-details-container" class="bg-emerald-50/50 border border-emerald-200 rounded-lg p-4 min-h-[15rem]">
                                <!-- 스케치 내용 -->
                                <div id="prototype-content-sketch" class="prototype-content active space-y-3">
                                    <h4 class="font-semibold text-emerald-800">✏️ 스케치 (그림판)</h4>
                                    <p class="text-xs text-gray-600 mb-2">아이디어를 그림으로 표현해 보세요.</p>
                                    <!-- Drawing Tools -->
                                    <div class="flex items-center gap-3 mb-2 p-2 bg-white rounded-lg border border-emerald-200">
                                        <button class="sketch-tool active p-1 rounded border border-emerald-300" data-tool="pencil" title="연필"><i data-lucide="pencil" class="w-5 h-5 pointer-events-none"></i></button>
                                        <button class="sketch-tool p-1 rounded border border-emerald-300" data-tool="eraser" title="지우개"><i data-lucide="eraser" class="w-5 h-5 pointer-events-none"></i></button>
                                        <div class="flex gap-1 ml-auto" id="sketch-color-palette">
                                            <button class="sketch-color active w-5 h-5 rounded-full border-2 border-white shadow" data-color="black" style="background-color: black;"></button>
                                            <button class="sketch-color w-5 h-5 rounded-full border-2 border-white shadow" data-color="red" style="background-color: red;"></button>
                                            <button class="sketch-color w-5 h-5 rounded-full border-2 border-white shadow" data-color="blue" style="background-color: blue;"></button>
                                            <button class="sketch-color w-5 h-5 rounded-full border-2 border-white shadow" data-color="green" style="background-color: green;"></button>
                                            <button class="sketch-color w-5 h-5 rounded-full border-2 border-white shadow" data-color="yellow" style="background-color: yellow;"></button>
                                        </div>
                                         <button id="clear-canvas-btn" class="p-1 rounded border border-emerald-300 text-emerald-700 ml-2" title="모두 지우기"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                                    </div>
                                    <!-- Canvas -->
                                    <canvas id="sketch-canvas" class="w-full h-60 bg-white border-2 border-emerald-300 rounded-lg"></canvas>
                                    <!-- Description -->
                                    <textarea rows="3" placeholder="그림에 대한 설명을 적어주세요..." class="mt-3 w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm"></textarea>
                                </div>
                                <!-- 사진 내용 -->
                                <div id="prototype-content-photo" class="prototype-content space-y-3">
                                    <h4 class="font-semibold text-emerald-800">📷 사진 업로드</h4>
                                    <p class="text-xs text-gray-600">실물로 만든 프로토타입의 사진을 올려주세요. (여러 장 선택 가능)</p>
                                    <label class="file-input-style block">
                                        <input type="file" accept="image/*" multiple id="photo-upload-input">
                                        <i data-lucide="upload-cloud" class="mx-auto h-8 w-8 mb-2"></i>
                                        클릭하여 사진 선택 (여러 장 가능)
                                    </label>
                                    <div id="photo-preview-container" class="flex flex-col items-center gap-4 mt-4">
                                        <!-- 업로드된 사진들이 여기에 추가됩니다 -->
                                    </div>
                                </div>
                                <!-- 즉흥극 내용 -->
                                <div id="prototype-content-improv" class="prototype-content space-y-4">
                                     <h4 class="font-semibold text-emerald-800">🎭 즉흥극 (Improvisation)</h4>
                                     <p class="text-xs text-gray-600 mb-2">아이디어를 짧은 역할극 대본으로 만들어 보세요.</p>
                                     <input type="text" placeholder="작품 이름" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm">
                                     <div class="grid grid-cols-2 gap-3">
                                        <input type="text" placeholder="시간 배경" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm">
                                        <input type="text" placeholder="공간 배경" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm">
                                     </div>
                                     <input type="text" placeholder="등장인물 (쉼표로 구분)" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm">
                                     <div class="grid grid-cols-3 gap-3">
                                        <textarea rows="5" placeholder="처음" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm"></textarea>
                                        <textarea rows="5" placeholder="중간" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm"></textarea>
                                        <textarea rows="5" placeholder="끝" class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm"></textarea>
                                     </div>
                                 </div>
                                <!-- 이야기 내용 -->
                                <div id="prototype-content-story" class="prototype-content space-y-3">
                                    <h4 class="font-semibold text-emerald-800">📖 이야기 (텍스트)</h4>
                                    <p class="text-xs text-gray-600">아이디어를 짧은 이야기나 스토리보드로 만들어 보세요.</p>
                                    <textarea rows="8" placeholder="예: #1. 학교 가는 길. 민지는 풀이 죽어있다...&#10;#2. 교실. 친구가 민지에게 칭찬 앱으로 메시지를 보낸다..." class="w-full bg-white border border-emerald-200 rounded-lg p-2 text-sm"></textarea>
                                </div>
                                <!-- 영상 내용 -->
                                <div id="prototype-content-video" class="prototype-content space-y-3">
                                    <h4 class="font-semibold text-emerald-800">🎬 영상 (촬영/업로드)</h4>
                                    <p class="text-xs text-gray-600">아이디어를 영상으로 만들어 올려주세요. (여러 개 선택 가능)</p>
                                    <label class="file-input-style block">
                                        <input type="file" accept="video/*" multiple id="video-upload-input">
                                        <i data-lucide="video" class="mx-auto h-8 w-8 mb-2"></i>
                                        클릭하여 영상 선택 (여러 개 가능)
                                    </label>
                                    <div id="video-preview-container" class="flex flex-col items-center gap-4 mt-4">
                                        <!-- 업로드된 영상들이 여기에 추가됩니다 -->
                                    </div>
                                </div>
                                <!-- 앱 디자인 내용 (신규) -->
                                <div id="prototype-content-appdesign" class="prototype-content space-y-4">
                                    <h4 class="font-semibold text-emerald-800">📱 앱 디자인</h4>
                                    <p class="text-xs text-gray-600">앱 화면을 간단하게 디자인해 보세요.</p>
                                    <!-- Controls -->
                                     <div class="flex flex-wrap items-center gap-2 p-2 bg-white rounded-lg border border-emerald-200">
                                         <button class="appdesign-add-btn bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded hover:bg-blue-200" data-type="text">텍스트+</button>
                                         <button class="appdesign-add-btn bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded hover:bg-yellow-200" data-type="emoji">이모지+</button>
                                         <button class="appdesign-add-btn bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded hover:bg-gray-200" data-type="button">버튼+</button>
                                         <button class="appdesign-add-btn bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded hover:bg-purple-200" data-type="image">이미지+</button> <!-- 이미지 추가 버튼 -->
                                         <div class="ml-auto flex items-center gap-2" id="app-page-controls">
                                             <button id="prev-page-btn" class="p-1 text-gray-500 hover:text-gray-800 disabled:opacity-50" disabled><i data-lucide="chevron-left" class="w-5 h-5 pointer-events-none"></i></button>
                                             <span id="page-indicator" class="text-sm font-medium">Page 1 / 1</span>
                                             <button id="next-page-btn" class="p-1 text-gray-500 hover:text-gray-800 disabled:opacity-50" disabled><i data-lucide="chevron-right" class="w-5 h-5 pointer-events-none"></i></button>
                                             <button id="add-page-btn" class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded hover:bg-green-200">페이지+</button>
                                         </div>
                                     </div>
                                     <!-- Selected Element Controls -->
                                     <div id="element-controls">
                                         <!-- Text Controls -->
                                         <div id="text-controls" class="hidden items-center gap-2">
                                             <label for="element-font">폰트:</label>
                                             <select id="element-font" class="border rounded text-xs">
                                                 <option value="'Noto Sans KR', sans-serif">기본 (Noto Sans)</option>
                                                 <option value="'Nanum Gothic', sans-serif">나눔고딕</option>
                                                 <option value="'Nanum Myeongjo', serif">나눔명조</option>
                                                 <option value="'Gowun Dodum', sans-serif">고운돋움</option>
                                                 <option value="'East Sea Dokdo', cursive">동해독도</option>
                                                 <option value="'Black Han Sans', sans-serif">검은고딕</option>
                                                 <option value="'Single Day', cursive">싱글데이</option>
                                                 <option value="'Grandiflora One', cursive">그랜디플로라</option>
                                             </select>
                                             <label for="element-color">색:</label>
                                             <input type="color" id="element-color">
                                             <label for="element-size">크기:</label>
                                             <input type="number" id="element-size" min="8" max="72" step="1">
                                         </div>
                                         <!-- Emoji Controls -->
                                          <div id="emoji-controls" class="hidden items-center gap-2">
                                              <label for="emoji-size">크기:</label>
                                              <input type="number" id="emoji-size" min="12" max="200" step="2">
                                          </div>
                                         <!-- Button Controls -->
                                         <div id="button-controls" class="hidden items-center gap-2">
                                              <label for="button-text">텍스트:</label>
                                              <input type="text" id="button-text" class="border rounded w-20">
                                              <label for="button-bgcolor">배경색:</label>
                                              <input type="color" id="button-bgcolor">
                                              <label for="button-textcolor">글자색:</label>
                                              <input type="color" id="button-textcolor">
                                              <label for="button-shape">모양:</label>
                                              <select id="button-shape" class="border rounded text-xs">
                                                 <option value="">사각형</option>
                                                 <option value="circle">원</option>
                                                 <!-- <option value="triangle">삼각형</option> -->
                                              </select>
                                              <!-- Size controls removed, use resize handles instead
                                               <label for="button-width">너비:</label>
                                               <input type="number" id="button-width" min="20" step="5">
                                               <label for="button-height">높이:</label>
                                               <input type="number" id="button-height" min="20" step="5">
                                               -->
                                         </div>
                                          <!-- Image Controls (placeholder) -->
                                          <div id="image-controls" class="hidden items-center gap-2">
                                              <!-- Image specific controls can be added here -->
                                              <span>이미지</span>
                                          </div>
                                         <button id="delete-element-btn" class="p-1"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                                     </div>
                                    <!-- Phone Frame -->
                                    <div id="app-design-wrapper">
                                        <div class="phone-frame">
                                            <div class="phone-notch"></div>
                                            <div class="phone-screen" id="appdesign-screen">
                                                <!-- Elements will be added here -->
                                                 <p class="text-gray-400 text-center text-sm absolute inset-0 flex items-center justify-center pointer-events-none">컨트롤 버튼을 눌러 요소를 추가하세요.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4-2. 테스트 탭 콘텐츠 -->
                    <div id="door-content-test" class="door-content space-y-6 hidden animate-fade-in">
                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🎁 피드백 선물세트</h3> <!-- 명칭 변경 -->
                            <p class="text-sm text-gray-500 mb-4">친구들이 만든 프로토타입을 보고 느낀 점을 4가지 기준으로 적어주세요.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <label for="feedback-plus" class="font-bold text-lg text-green-700 mb-2 block">➕ 좋았던 점</label>
                                    <textarea id="feedback-plus" rows="4" class="w-full bg-white border-green-200 rounded-lg p-2 text-sm" placeholder="어떤 점이 좋았나요?"></textarea>
                                </div>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <label for="feedback-delta" class="font-bold text-lg text-yellow-700 mb-2 block">🔺 개선할 점</label>
                                    <textarea id="feedback-delta" rows="4" class="w-full bg-white border-yellow-200 rounded-lg p-2 text-sm" placeholder="어떻게 바꾸면 더 좋을까요?"></textarea>
                                </div>
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <label for="feedback-question" class="font-bold text-lg text-blue-700 mb-2 block">❓ 궁금한 점</label>
                                    <textarea id="feedback-question" rows="4" class="w-full bg-white border-blue-200 rounded-lg p-2 text-sm" placeholder="더 알고 싶은 점이 있나요?"></textarea>
                                </div>
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                    <label for="feedback-idea" class="font-bold text-lg text-orange-700 mb-2 block">💡 새로운 아이디어</label>
                                    <textarea id="feedback-idea" rows="4" class="w-full bg-white border-orange-200 rounded-lg p-2 text-sm" placeholder="이걸 보고 떠오른 다른 생각은?"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="content-card p-6 rounded-xl shadow-sm">
                            <h3 class="font-bold text-lg mb-2 flex items-center gap-2">📝 좋·아·바 포스트잇</h3>
                            <p class="text-sm text-gray-500 mb-4">프로토타입에 대한 "좋은 점", "아쉬운 점", "바라는 점"을 간단히 적어주세요.</p>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
                                    <label for="feedback-like" class="font-bold text-lg text-pink-700 mb-2 block">💖 좋은 점</label>
                                    <textarea id="feedback-like" rows="5" class="w-full bg-white border-pink-200 rounded-lg p-2 text-sm" placeholder="가장 좋았던 점은..."></textarea>
                                </div>
                                <div class="bg-gray-100 border border-gray-200 rounded-lg p-4">
                                    <label for="feedback-lack" class="font-bold text-lg text-gray-700 mb-2 block">🤔 아쉬운 점</label>
                                    <textarea id="feedback-lack" rows="5" class="w-full bg-white border-gray-200 rounded-lg p-2 text-sm" placeholder="조금 아쉬웠던 점은..."></textarea>
                                </div>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <label for="feedback-wish" class="font-bold text-lg text-purple-700 mb-2 block">🙏 바라는 점</label>
                                    <textarea id="feedback-wish" rows="5" class="w-full bg-white border border-purple-200 rounded-lg p-2 text-sm" placeholder="이렇게 발전하면 좋겠어요..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. 어둠 (성찰) 콘텐츠 -->
                <div id="content-darkness" class="tab-content space-y-6 hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-violet-500">5단계: 생각을 정리하는 (어둠) - 성장! 배움 확장하기</h2>
                    <p class="text-gray-600">우리의 학습 여정을 돌아보며 무엇을 배우고 느꼈는지 정리하고, 다음 단계를 준비해 봅시다.</p>

                    <!-- '알감장 쓰기' (신규) -->
                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">🔍 알감장 쓰기</h3>
                        <p class="text-sm text-gray-500 mb-4">'알게 된 것', '느낀 감정', '성장한 점'을 각각 정리해 보세요.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- 알게 된 것 -->
                            <div class="p-4 bg-violet-50 border border-violet-200 rounded-lg">
                                <label for="reflection-learned" class="font-bold text-lg text-violet-700 mb-2 block flex items-center gap-2">
                                    <i data-lucide="lightbulb" class="w-5 h-5"></i> 알게 된 것
                                </label>
                                <textarea id="reflection-learned" rows="6" class="w-full bg-white border border-violet-200 rounded-lg p-2 text-sm text-violet-900 focus:ring-1 focus:ring-violet-400 focus:outline-none placeholder:text-violet-600/70" placeholder="새롭게 알게 된 점은?"></textarea>
                            </div>
                            <!-- 느낀 감정 -->
                            <div class="p-4 bg-violet-50 border border-violet-200 rounded-lg">
                                <label for="reflection-felt" class="font-bold text-lg text-violet-700 mb-2 block flex items-center gap-2">
                                    <i data-lucide="heart" class="w-5 h-5"></i> 느낀 감정
                                </label>
                                <textarea id="reflection-felt" rows="6" class="w-full bg-white border border-violet-200 rounded-lg p-2 text-sm text-violet-900 focus:ring-1 focus:ring-violet-400 focus:outline-none placeholder:text-violet-600/70" placeholder="어떤 감정을 느꼈나요?"></textarea>
                            </div>
                            <!-- 성장한 점 -->
                            <div class="p-4 bg-violet-50 border border-violet-200 rounded-lg">
                                <label for="reflection-growth" class="font-bold text-lg text-violet-700 mb-2 block flex items-center gap-2">
                                    <i data-lucide="trending-up" class="w-5 h-5"></i> 성장한 점
                                </label>
                                <textarea id="reflection-growth" rows="6" class="w-full bg-white border border-violet-200 rounded-lg p-2 text-sm text-violet-900 focus:ring-1 focus:ring-violet-400 focus:outline-none placeholder:text-violet-600/70" placeholder="스스로 성장했다고 느낀 점은?"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- '이모지로 말해요' (수정) -->
                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-lg flex items-center gap-2">🙂 이모지로 말해요</h3>
                            <button id="open-reflection-emoji-picker-btn" class="bg-violet-500 hover:bg-violet-600 text-white text-sm font-bold py-2 px-3 rounded-lg transition-colors shadow hover:shadow-md flex items-center gap-1">
                                <i data-lucide="plus-circle" class="w-4 h-4"></i> 이모지 추가하기
                            </button>
                        </div>
                        <p class="text-sm text-gray-500 mb-4">이모지를 선택해 문장 상자에 배치하고, 떠오른 생각을 자유롭게 정리해 보세요. (상자 안의 이모지를 클릭하면 삭제됩니다)</p>

                        <!-- 이모지 문장 상자 -->
                        <div id="reflection-emoji-sentence-box" class="mb-3">
                             <p class="placeholder" style="text-align: center;">당신이 선택한 이모지</p> <!-- 텍스트 및 스타일 변경 -->
                        </div>

                        <!-- 문장 텍스트 영역 -->
                        <textarea id="reflection-emoji-sentence-text" class="w-full h-24 bg-white border border-violet-200 rounded-lg p-3 text-sm text-violet-900 focus:ring-1 focus:ring-violet-400 focus:outline-none placeholder:text-violet-600/70 text-center placeholder:text-center" placeholder="문장으로 정리해보세요."></textarea> <!-- placeholder 변경 및 스타일 추가 -->

                        <!-- 초기화 버튼 (위치 변경) -->
                        <div class="text-right mt-3">
                            <button id="reset-reflection-sentence-btn" class="text-sm text-gray-500 hover:text-gray-700 hover:underline">
                                초기화
                            </button>
                        </div>
                    </div>


                    <!-- '자유 글쓰기' (신규) -->
                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">✍️ 자유 글쓰기</h3>
                        <p class="text-sm text-gray-500 mb-4">프로젝트 전체에 대한 감상을 자유롭게 작성해 보세요.</p>
                        <textarea class="w-full h-48 bg-violet-50 border border-violet-200 rounded-lg p-3 text-violet-900 focus:ring-2 focus:ring-violet-400 focus:outline-none placeholder:text-violet-600/70" placeholder="프로젝트를 마치며..."></textarea>
                    </div>
                </div>

                <!-- 6. 열매맺기 (논술작성) 콘텐츠 - 수정 -->
                <div id="content-fruit" class="tab-content space-y-6 hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-red-500 mb-4">열매맺기 - 논술 작성 및 공유하기</h2>

                    <!-- 구글 슬라이드 임베드 -->
                    <div class="content-card p-4 rounded-xl shadow-sm">
                        <iframe src="https://docs.google.com/presentation/d/1LIUvkz3pA0oXByoHPOy-4nyzMekEygokA0dvK87Vk6M/embed?start=false&loop=false&delayms=3000" frameborder="0" width="100%" height="420" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" class="rounded-lg"></iframe>
                    </div>

                    <!-- 논술 작성 영역 -->
                    <div id="essay-content-area" class="content-card p-6 rounded-xl shadow-sm space-y-4">
                        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">🍎 나의 열매 (논술 작성)</h3>
                        <p class="text-sm text-gray-500 mb-4">뮤지컬을 통해 발견한 문제, 그것을 해결하기 위한 아이디어, 그리고 프로젝트 과정을 통해 성장한 점을 중심으로 글을 작성해 보세요.</p>
                        <div class="flex gap-4">
                            <input type="text" id="essay-title" placeholder="제목" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-red-400 focus:border-red-400 focus:outline-none">
                            <input type="text" id="essay-name" placeholder="이름" class="w-1/2 p-2 border border-gray-300 rounded-md focus:ring-red-400 focus:border-red-400 focus:outline-none">
                        </div>
                        <div>
                            <label for="essay-intro" class="block text-sm font-medium text-gray-700 mb-1">서론</label>
                            <textarea id="essay-intro" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-400 focus:border-red-400 focus:outline-none" placeholder="주제를 간단히 소개하고 글을 쓰는 이유를 분명히 밝힙니다."></textarea>
                        </div>
                         <div>
                            <label for="essay-body" class="block text-sm font-medium text-gray-700 mb-1">본론</label>
                            <textarea id="essay-body" rows="8" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-400 focus:border-red-400 focus:outline-none" placeholder="주장을 뒷받침하는 근거와 예시를 체계적으로 제시합니다."></textarea>
                        </div>
                         <div>
                            <label for="essay-conclusion" class="block text-sm font-medium text-gray-700 mb-1">결론</label>
                            <textarea id="essay-conclusion" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-red-400 focus:border-red-400 focus:outline-none" placeholder="본론을 요약하고 주장을 다시 한 번 강조합니다."></textarea>
                        </div>

                         <!-- 버튼 영역 -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button id="download-txt-btn" class="inline-flex items-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-bold py-2 px-3 rounded-lg transition-colors">
                                <i data-lucide="file-text" class="w-4 h-4"></i> TXT
                            </button>
                            <button id="download-jpg-btn" class="inline-flex items-center gap-1 bg-gray-200 hover:bg-gray-300 text-gray-700 text-sm font-bold py-2 px-3 rounded-lg transition-colors">
                                <i data-lucide="image" class="w-4 h-4"></i> JPG
                            </button>
                             <button id="copy-text-btn" class="inline-flex items-center gap-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-3 rounded-lg transition-colors">
                                <i data-lucide="copy" class="w-4 h-4"></i> 복사하기
                            </button>
                        </div>
                        <!-- 복사 완료 메시지 (숨김) -->
                        <div id="copy-success-msg" class="text-right text-green-600 text-sm mt-2 hidden">클립보드에 복사되었습니다!</div>
                    </div>

                    <!-- 패들렛 공유 영역 추가 -->
                    <div class="content-card p-6 rounded-xl shadow-sm">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">📌 작성한 글 공유하기</h3>
                        <p class="text-sm text-gray-500 mb-4">아래 패들렛에 작성한 논술을 공유해 보세요.</p>
                        <div class="w-full" style="height: 600px;">
                            <iframe src="https://padlet.com/embed/i41zk0hmkjbi0uq" frameborder="0" allow="camera;microphone;geolocation" style="width:100%;height:100%;display:block;border-radius:8px;" class="border border-gray-200"></iframe>
                        </div>
                    </div>

                </div>

                <!-- 7. 생각사전 탭 콘텐츠 (신규) -->
                 <div id="content-dictionary" class="tab-content hidden animate-fade-in">
                    <!-- 패들렛이 전체 영역을 차지하도록 -->
                     <iframe src="https://padlet.com/embed/dg52j05sxztmw548" class="padlet-embed w-full h-full" frameborder="0" allow="camera; microphone; geolocation"></iframe>
                 </div>

                <!-- 8. 보고서 탭 콘텐츠 (신규) -->
                <div id="content-report" class="tab-content space-y-6 hidden animate-fade-in">
                    <h2 class="text-2xl font-bold text-purple-500 mb-4">📊 최종 보고서</h2>
                    <p class="text-gray-600 mb-6">모든 단계에서 작성한 내용을 한눈에 확인할 수 있습니다.</p>

                    <!-- 작성자 이름 입력 필드 -->
                    <div class="content-card p-4 rounded-xl shadow-sm">
                        <label for="report-author-name" class="block text-sm font-semibold text-gray-700 mb-2">작성자 이름</label>
                        <input type="text" id="report-author-name" placeholder="이름을 입력하세요" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none">
                    </div>

                    <div id="report-content" class="content-card p-8 rounded-xl shadow-sm space-y-8">
                        <!-- 1단계: 빛 -->
                        <section class="border-l-4 border-amber-500 pl-6">
                            <h3 class="text-xl font-bold text-amber-600 mb-4">💡 1단계: 빛 (영감)</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-amber-700 mb-2">뮤지컬 조각 카드</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div class="bg-amber-50 p-3 rounded"><strong>이야기:</strong> <span id="report-card-story"></span></div>
                                        <div class="bg-amber-50 p-3 rounded"><strong>음악:</strong> <span id="report-card-music"></span></div>
                                        <div class="bg-amber-50 p-3 rounded"><strong>움직임:</strong> <span id="report-card-movement"></span></div>
                                        <div class="bg-amber-50 p-3 rounded"><strong>무대미술:</strong> <span id="report-card-stage"></span></div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-amber-700 mb-2">나의 감상평</h4>
                                    <p class="bg-amber-50 p-3 rounded text-sm"><span id="report-emoji"></span> <span id="report-review"></span></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-amber-700 mb-2">질문상자</h4>
                                    <ul id="report-questions" class="list-disc list-inside bg-amber-50 p-3 rounded text-sm space-y-1"></ul>
                                </div>
                            </div>
                        </section>

                        <!-- 2단계: 거울 -->
                        <section class="border-l-4 border-pink-500 pl-6">
                            <h3 class="text-xl font-bold text-pink-600 mb-4">🪞 2단계: 거울 (공감/정의)</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-pink-700 mb-2">인물 감정 따라가기</h4>
                                    <div class="bg-pink-50 p-3 rounded text-sm">
                                        <p><strong>인물:</strong> <span id="report-character-name"></span></p>
                                        <p><strong>상황:</strong> <span id="report-situation"></span></p>
                                        <p><strong>말:</strong> <span id="report-speech"></span></p>
                                        <p><strong>행동:</strong> <span id="report-action"></span></p>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-pink-700 mb-2">POV 문장</h4>
                                    <div class="bg-pink-50 p-3 rounded text-sm">
                                        <p><strong>필요:</strong> <span id="report-pov-need"></span></p>
                                        <p><strong>이유:</strong> <span id="report-pov-reason"></span></p>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 작성자 정보 -->
                        <section class="border-l-4 border-purple-500 pl-6">
                            <h3 class="text-xl font-bold text-purple-600 mb-4">👤 작성자</h3>
                            <p class="bg-purple-50 p-3 rounded text-sm" id="report-author-display">-</p>
                        </section>

                        <!-- 3단계: 창문 -->
                        <section class="border-l-4 border-blue-500 pl-6">
                            <h3 class="text-xl font-bold text-blue-600 mb-4">🪟 3단계: 창문 (재정의/아이디어)</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-blue-700 mb-2">HMW 문장</h4>
                                    <p class="bg-blue-50 p-3 rounded text-sm" id="report-hmw"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-700 mb-2">아이디어 목록</h4>
                                    <ul id="report-ideas" class="list-disc list-inside bg-blue-50 p-3 rounded text-sm space-y-1"></ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-blue-700 mb-2">최종 아이디어</h4>
                                    <p class="bg-blue-50 p-3 rounded text-sm" id="report-final-idea"></p>
                                </div>
                            </div>
                        </section>

                        <!-- 4단계: 미닫이문 -->
                        <section class="border-l-4 border-emerald-500 pl-6">
                            <h3 class="text-xl font-bold text-emerald-600 mb-4">🚪 4단계: 미닫이문 (프로토타입/테스트)</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-emerald-700 mb-2">선택한 프로토타입 유형</h4>
                                    <p class="bg-emerald-50 p-3 rounded text-sm" id="report-prototype-type"></p>
                                </div>
                                <div id="report-prototype-content">
                                    <h4 class="font-semibold text-emerald-700 mb-2">프로토타입 결과물</h4>
                                    <div class="bg-emerald-50 p-3 rounded text-sm space-y-3">
                                        <!-- 스케치 -->
                                        <div id="report-sketch-section" class="hidden">
                                            <strong class="block mb-2">✏️ 스케치:</strong>
                                            <div id="report-sketch-canvas-container"></div>
                                            <p class="mt-2" id="report-sketch-description"></p>
                                        </div>
                                        <!-- 사진 -->
                                        <div id="report-photo-section" class="hidden">
                                            <strong class="block mb-2">📷 사진:</strong>
                                            <div id="report-photos-container" class="grid grid-cols-2 gap-2"></div>
                                        </div>
                                        <!-- 즉흥극 -->
                                        <div id="report-improv-section" class="hidden">
                                            <strong class="block mb-2">🎭 즉흥극:</strong>
                                            <div id="report-improv-content"></div>
                                        </div>
                                        <!-- 이야기 -->
                                        <div id="report-story-section" class="hidden">
                                            <strong class="block mb-2">📖 이야기:</strong>
                                            <p id="report-story-content" class="whitespace-pre-wrap"></p>
                                        </div>
                                        <!-- 영상 -->
                                        <div id="report-video-section" class="hidden">
                                            <strong class="block mb-2">🎬 영상:</strong>
                                            <div id="report-videos-container" class="grid grid-cols-2 gap-2"></div>
                                        </div>
                                        <!-- 앱 디자인 -->
                                        <div id="report-appdesign-section" class="hidden">
                                            <strong class="block mb-2">📱 앱 디자인:</strong>
                                            <div id="report-appdesign-pages" class="space-y-2"></div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-emerald-700 mb-2">피드백 요약</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                        <div class="bg-green-50 p-3 rounded"><strong>좋았던 점:</strong> <span id="report-feedback-plus"></span></div>
                                        <div class="bg-yellow-50 p-3 rounded"><strong>개선할 점:</strong> <span id="report-feedback-delta"></span></div>
                                        <div class="bg-blue-50 p-3 rounded"><strong>궁금한 점:</strong> <span id="report-feedback-question"></span></div>
                                        <div class="bg-orange-50 p-3 rounded"><strong>새 아이디어:</strong> <span id="report-feedback-idea"></span></div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- 5단계: 어둠 -->
                        <section class="border-l-4 border-violet-500 pl-6">
                            <h3 class="text-xl font-bold text-violet-600 mb-4">🌑 5단계: 어둠 (성찰)</h3>
                            <div class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                    <div class="bg-violet-50 p-3 rounded"><strong>알게 된 것:</strong> <span id="report-learned"></span></div>
                                    <div class="bg-violet-50 p-3 rounded"><strong>느낀 감정:</strong> <span id="report-felt"></span></div>
                                    <div class="bg-violet-50 p-3 rounded"><strong>성장한 점:</strong> <span id="report-growth"></span></div>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-violet-700 mb-2">이모지</h4>
                                    <p class="bg-violet-50 p-3 rounded text-sm" id="report-reflection-emojis"></p>
                                </div>
                            </div>
                        </section>

                        <!-- 열매: 논술 -->
                        <section class="border-l-4 border-red-500 pl-6">
                            <h3 class="text-xl font-bold text-red-600 mb-4">🍎 열매 (논술)</h3>
                            <div class="space-y-4">
                                <div class="bg-red-50 p-3 rounded text-sm">
                                    <p><strong>제목:</strong> <span id="report-essay-title"></span></p>
                                    <p><strong>이름:</strong> <span id="report-essay-name"></span></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-red-700 mb-2">서론</h4>
                                    <p class="bg-red-50 p-3 rounded text-sm whitespace-pre-wrap" id="report-essay-intro"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-red-700 mb-2">본론</h4>
                                    <p class="bg-red-50 p-3 rounded text-sm whitespace-pre-wrap" id="report-essay-body"></p>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-red-700 mb-2">결론</h4>
                                    <p class="bg-red-50 p-3 rounded text-sm whitespace-pre-wrap" id="report-essay-conclusion"></p>
                                </div>
                            </div>
                        </section>
                    </div>

                    <!-- 내보내기 버튼 -->
                    <div class="flex justify-center gap-4 mt-8 pb-4">
                        <button id="export-pdf-btn" class="inline-flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            <i data-lucide="file-text" class="w-5 h-5"></i> PDF
                        </button>
                        <button id="export-png-btn" class="inline-flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            <i data-lucide="image" class="w-5 h-5"></i> PNG
                        </button>
                        <button id="export-txt-btn" class="inline-flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            <i data-lucide="file-down" class="w-5 h-5"></i> TXT
                        </button>
                        <button id="export-copy-btn" class="inline-flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg">
                            <i data-lucide="copy" class="w-5 h-5"></i> 복사하기
                        </button>
                    </div>
                    <div id="export-success-msg" class="text-center text-green-600 font-semibold mt-2 hidden">완료되었습니다!</div>
                </div>

            </div>
        </main>
    </div>

    <!-- 설명서 모달 -->
    <div id="manual-modal" class="fixed inset-0 bg-black bg-opacity-60 z-[100] hidden items-center justify-center p-4 animate-fade-in">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6 md:p-8 relative max-h-[90vh] overflow-y-auto">
            <button id="close-modal-button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <h2 class="grandiflora text-3xl font-bold text-orange-500 text-center mb-6">홍당뮤 설명서</h2>
            <div class="space-y-5 text-left text-gray-700">
                <div class="flex items-start gap-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
                    <div class="text-amber-500"><i data-lucide="lightbulb" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-amber-600">1. 빛 (영감 얻기)</h3>
                        <p class="text-sm">뮤지컬을 보고 인상 깊은 장면, 느낌, 질문을 자유롭게 기록하며 생각의 빛을 켜요.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-pink-50 rounded-lg border border-pink-200">
                    <div class="text-pink-500"><i data-lucide="user-square" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-pink-600">2. 거울 (공감하고 정의하기)</h3>
                        <p class="text-sm">뮤지컬 속 인물의 마음에 공감하며, 나와 우리 주변의 문제를 찾아 이름을 붙여줘요.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="text-blue-500"><i data-lucide="search" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-blue-600">3. 창문 (아이디어 떠올리기)</h3>
                        <p class="text-sm">발견한 문제를 어떻게 해결할지, 세상을 향한 창문을 열고 상상의 나래를 펼쳐요.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                    <div class="text-emerald-500"><i data-lucide="hammer" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-emerald-600">4. 미닫이문 (만들고 실천하기)</h3>
                        <p class="text-sm">아이디어를 눈에 보이는 형태로 만들고 실험해봐요.</p>
                    </div>
                </div>
                <div class="flex items-start gap-4 p-4 bg-violet-50 rounded-lg border border-violet-200">
                    <div class="text-violet-500"><i data-lucide="book-open" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-violet-600">5. 어둠 (성찰하기)</h3>
                        <p class="text-sm">어둠은 새로운 빛을 기다리는 쉼의 시간입니다. 배운 내용을 정리해봐요.</p>
                    </div>
                </div>
                 <div class="flex items-start gap-4 p-4 bg-red-50 rounded-lg border border-red-200">
                    <div class="text-red-500"><i data-lucide="apple" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-red-600">+ 열매맺기 (논술작성)</h3>
                        <p class="text-sm">모든 과정을 돌아보며 배운 점을 논리적인 글로 작성하여 성장의 열매를 맺어요.</p>
                    </div>
                </div>
                <!-- 생각사전 설명 추가 -->
                 <div class="flex items-start gap-4 p-4 bg-teal-50 rounded-lg border border-teal-200">
                    <div class="text-teal-500"><i data-lucide="book-marked" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-teal-600">+ 생각사전</h3>
                        <p class="text-sm">프로젝트를 하며 알게 된 새로운 단어, 개념을 기록하고 공유하는 공간이에요.</p>
                    </div>
                </div>
                <!-- 보고서 설명 추가 -->
                 <div class="flex items-start gap-4 p-4 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="text-purple-500"><i data-lucide="file-bar-chart" class="w-8 h-8"></i></div>
                    <div>
                        <h3 class="font-bold text-purple-600">+ 보고서</h3>
                        <p class="text-sm">작성한 내용을 한눈에 확인하고, PDF, PNG, TXT 등 다양한 형식으로 내보내요.</p>
                    </div>
                </div>

                <!-- 📚 출처 및 참고 문헌 섹션 -->
                <div class="mt-6 pt-6 border-t border-gray-300">
                    <h3 class="font-bold text-gray-800 mb-3">📚 출처 및 참고 문헌</h3>
                    <div class="space-y-3 text-sm text-gray-700">
                        <div>
                            <p class="font-semibold">• 거울, 창, 슬라이딩 유리문 이론</p>
                            <p class="ml-4 text-gray-600">Rudine Sims Bishop (1990). "Mirrors, Windows, and Sliding Glass Doors." Perspectives: Choosing and Using Books for the Classroom, 6 (3).</p>
                            <p class="ml-4 text-gray-500 mt-1">- 어린이 문학을 통해 타인과 세계를 이해하는 독서의 비유적 개념으로, 본 웹앱의 철학적 모티브로 참고하였습니다.</p>
                        </div>
                        <div>
                            <p class="font-semibold">• 디자인 씽킹 방법론</p>
                            <p class="ml-4 text-gray-600">Stanford d.school (2018). "Design Thinking Bootleg." Stanford University Institute of Design.</p>
                            <p class="ml-4 text-gray-500 mt-1">- 공감·정의·아이디어·프로토타입·테스트의 순환적 과정을 제시하는 교육용 자료로, 프로젝트 설계와 단계 구성에 인용하였습니다.</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 개발자 소개 섹션 -->
            <div class="mt-8 pt-6 border-t-2 border-orange-200">
                <h3 class="text-lg font-bold text-orange-600 mb-3">👨‍💻 개발자</h3>
                <div class="bg-orange-50 rounded-lg p-4 space-y-2">
                    <p class="font-bold text-orange-800">교육뮤지컬 꿈꾸는 치수쌤</p>
                    <p class="text-sm text-gray-700">교육뮤지컬을 고민하고, 창작하고, 실천합니다.</p>
                    <p class="text-sm text-gray-700">초등학교 학생들과 함께 꿈꾸는 교육뮤지컬 이야기를 기록합니다.</p>
                    <p class="text-sm text-gray-700">[세상에서 가장 쉬운 뮤지컬 수업], [뮤지컬 창작노트]의 저자입니다.</p>
                    <p class="text-sm text-gray-700">따뜻한 디지털 활용 교육에도 관심이 많습니다.</p>
                    <a href="https://litt.ly/chichiboo" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 text-sm text-orange-600 hover:text-orange-700 hover:underline font-medium">
                        🔗 https://litt.ly/chichiboo
                    </a>
                </div>
            </div>

            <div class="text-center pt-4">
                <button id="start-from-modal-button" class="bg-orange-400 hover:bg-orange-500 text-white font-bold text-lg px-8 py-3 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
                    시작하기!
                </button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emoji-picker-modal">
        <div id="emoji-picker-content">
            <!-- Emojis will be loaded here -->
            <button class="text-gray-400 absolute top-2 right-2" id="close-emoji-picker-inner">&times;</button>
        </div>
    </div>

    <!-- Reflection Emoji Picker Modal (신규) -->
    <div id="reflection-emoji-picker-modal-new" class="animate-fade-in">
        <div id="reflection-emoji-picker-content-new">
            <button id="close-reflection-emoji-picker-new">&times;</button>
            <!-- 성찰 이모지가 여기에 JS로 추가됩니다. -->
        </div>
    </div>

    <!-- 하단 네비게이션 (footer 통합) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-gray-800/95 backdrop-blur-lg z-50 border-t border-gray-200 dark:border-gray-700">
        <div class="max-w-xl mx-auto">
            <!-- 네비게이션 버튼들 -->
            <div class="flex justify-around items-center h-16 pt-2">
                <button data-page="home" class="nav-button home-button flex flex-col items-center justify-center gap-1 transition-all w-16 min-h-[48px]">
                     <i data-lucide="home" class="w-6 h-6"></i>
                     <span class="text-xs font-bold">홈</span>
                </button>
                <button data-tab="light" class="nav-button tab-button flex flex-col items-center justify-center gap-1 transition-all w-16 min-h-[48px]">
                    <i data-lucide="lightbulb" class="w-6 h-6"></i>
                    <span class="text-xs font-bold">빛</span>
                </button>
                <button data-tab="mirror" class="nav-button tab-button flex flex-col items-center justify-center gap-1 transition-all w-16 min-h-[48px]">
                    <i data-lucide="user-square" class="w-6 h-6"></i>
                    <span class="text-xs font-bold">거울</span>
                </button>
                <button data-tab="window" class="nav-button tab-button flex flex-col items-center justify-center gap-1 transition-all w-16 min-h-[48px]">
                    <i data-lucide="search" class="w-6 h-6"></i>
                    <span class="text-xs font-bold">창문</span>
                </button>
                <button data-tab="door" class="nav-button tab-button flex flex-col items-center justify-center gap-1 transition-all w-16 min-h-[48px]">
                    <i data-lucide="hammer" class="w-6 h-6"></i>
                    <span class="text-xs font-bold">문</span>
                </button>
                <button data-tab="darkness" class="nav-button tab-button flex flex-col items-center justify-center gap-1 transition-all w-16 min-h-[48px]">
                    <i data-lucide="book-open" class="w-6 h-6"></i>
                    <span class="text-xs font-bold">어둠</span>
                </button>
            </div>
            <!-- Footer 텍스트 -->
            <div class="text-center py-2">
                <a href="https://litt.ly/chichiboo" target="_blank" rel="noopener noreferrer" class="text-sm text-gray-700 dark:text-gray-300 hover:text-orange-500 dark:hover:text-orange-400 hover:underline transition-colors">
                    created by. 교육뮤지컬 꿈꾸는 치수쌤
                </a>
            </div>
        </div>
    </nav>


    <style>
        /* 네비게이션 높이에 맞춰 body 하단 여백 조정 */
        body {
            padding-bottom: 110px; /* 네비게이션 + footer 텍스트 높이 */
            -webkit-text-size-adjust: 100%; /* 모바일 텍스트 자동 확대 방지 */
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* 터치 영역 최소 크기 보장 */
            button, .emoji-btn, .nav-button {
                min-height: 44px;
                min-width: 44px;
            }

            /* 입력 필드 줌 방지 */
            input, textarea, select {
                font-size: 16px !important;
            }
        }

        /* 작은 모바일 화면 */
        @media (max-width: 480px) {
            h1 {
                font-size: 2.5rem !important;
            }

            h2 {
                font-size: 1.25rem !important;
            }

            .nav-button span {
                font-size: 0.65rem;
            }
        }
    </style>

    <script>
        // --- Global Variables & Initial Setup ---
        const homePage = document.getElementById('home-page');
        const mainContent = document.getElementById('main-content');
        const manualButton = document.getElementById('manual-button');
        const modal = document.getElementById('manual-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const startFromModalButton = document.getElementById('start-from-modal-button');

        const navContainer = document.querySelector('nav');
        const allNavButtons = document.querySelectorAll('.nav-button');
        const homeButton = document.querySelector('.home-button');
        const tabButtons = document.querySelectorAll('.tab-button'); // Includes new 'dictionary' button

        const tabContents = document.querySelectorAll('.tab-content');

        const tabColors = {
            home: '#f97316',     // orange-500
            light: '#f59e0b',    // amber-500
            mirror: '#ec4899',   // pink-500
            window: '#3b82f6',   // blue-500
            door: '#10b981',     // emerald-500
            darkness: '#8b5cf6', // violet-500
            fruit: '#ef4444',     // red-500
            dictionary: '#14b8a6', // teal-500
            report: '#a855f7'    // purple-500
        };

         // --- App Design Variables ---
         const appDesignScreen = document.getElementById('appdesign-screen');
         const elementControls = document.getElementById('element-controls');
         const textControls = document.getElementById('text-controls');
         const emojiControls = document.getElementById('emoji-controls');
         const buttonControls = document.getElementById('button-controls');
         const imageControls = document.getElementById('image-controls'); // Image controls
         const elementFontSelect = document.getElementById('element-font');
         const elementColorInput = document.getElementById('element-color');
         const elementSizeInput = document.getElementById('element-size');
         const emojiSizeInput = document.getElementById('emoji-size');
         const buttonTextInput = document.getElementById('button-text');
         const buttonBgColorInput = document.getElementById('button-bgcolor'); // Button color
         const buttonTextColorInput = document.getElementById('button-textcolor'); // New: Button text color
         const buttonShapeSelect = document.getElementById('button-shape');
         const deleteElementBtn = document.getElementById('delete-element-btn');
         const emojiPickerModal = document.getElementById('emoji-picker-modal');
         const emojiPickerContent = document.getElementById('emoji-picker-content');
         // const closeEmojiPickerBtn = document.getElementById('close-emoji-picker-inner'); // Re-find dynamically
         const addPageBtn = document.getElementById('add-page-btn');
         const prevPageBtn = document.getElementById('prev-page-btn');
         const nextPageBtn = document.getElementById('next-page-btn');
         const pageIndicator = document.getElementById('page-indicator');
         const addElementBtns = document.querySelectorAll('.appdesign-add-btn');
         const imageUploadInput = document.getElementById('image-upload-input'); // Image upload input

        // Moved App Design variables before usage
         let appPages = [[]]; // Array of pages, each page is an array of elements
         let currentPageIndex = 0;
         let selectedElement = null;
         let dragOffsetX = 0;
         let dragOffsetY = 0;
         let isDraggingElement = false;
         let isResizing = false;
         let resizeHandleType = ''; // e.g., 'bottom-right'
         let initialResizeInfo = {}; // Store initial pos/size during resize

        // --- Core Functions ---

        function showPage(pageName) {
            if (homePage) homePage.classList.toggle('hidden', pageName !== 'home');
            if (mainContent) mainContent.classList.toggle('hidden', pageName === 'home');
        }

         // Function to hide controls
         function hideElementControls() {
             if (elementControls) elementControls.classList.remove('visible');
             // Remove resize handles when deselecting
             removeResizeHandles();
             if (selectedElement) {
                 selectedElement.classList.remove('selected');
                 selectedElement = null; // Also deselect element data
             }
         }

        function setActiveTab(target) {
            allNavButtons.forEach(btn => {
                btn.classList.remove('active-nav');
                btn.style.color = '#6b7280'; // gray-500
            });
            tabContents.forEach(content => content.classList.add('hidden'));

            // 보고서 탭 활성화 시 데이터 수집
            if (target === 'report') {
                updateReportData();
            }

            if (target === 'home') {
                if (homeButton) { // Check if homeButton exists
                    homeButton.classList.add('active-nav');
                    homeButton.style.color = tabColors.home;
                }
            } else {
                // Find button by data-tab attribute
                const activeButton = document.querySelector(`.nav-button[data-tab="${target}"]`);
                const activeContent = document.getElementById(`content-${target}`);

                if (activeButton) {
                    activeButton.classList.add('active-nav');
                    // Use color from tabColors, default to gray if not found
                    activeButton.style.color = tabColors[target] || '#6b7280';
                }
                if (activeContent) {
                    activeContent.classList.remove('hidden');
                     // '미닫이문' 탭 활성화 시 기본 서브탭 설정
                     if (target === 'door') {
                        const defaultDoorTab = document.querySelector('.door-tab-btn[data-tab="prototype"]');
                        const doorTabButtons = document.querySelectorAll('.door-tab-btn'); // Define doorTabButtons here
                        const prototypeContents = document.querySelectorAll('.prototype-content'); // Define prototypeContents here
                         if (defaultDoorTab && doorTabButtons.length > 0 && prototypeContents.length > 0) { // Add checks
                            // Ensure the prototype content is also visible before clicking the tab
                            const defaultDoorContent = document.getElementById('door-content-prototype');
                            if(defaultDoorContent) defaultDoorContent.classList.remove('hidden');
                             // Activate the correct sub-tab content first
                             const prototypeContent = document.getElementById('door-content-prototype');
                             const testContent = document.getElementById('door-content-test');
                             if(prototypeContent) prototypeContent.classList.remove('hidden');
                             if(testContent) testContent.classList.add('hidden');
                             doorTabButtons.forEach(btn => btn.classList.remove('active'));
                             defaultDoorTab.classList.add('active'); // Manually set active class for sub-tab


                            // Activate the correct prototype type content
                            const defaultPrototypeButton = document.querySelector('#prototype-type-selector .prototype-btn.active') || document.querySelector('#prototype-type-selector .prototype-btn[data-type="sketch"]'); // Find current active or default to sketch
                             if (defaultPrototypeButton) {
                                 const type = defaultPrototypeButton.dataset.type;
                                 prototypeContents.forEach(content => content.classList.remove('active'));
                                 const activePrototypeContent = document.getElementById(`prototype-content-${type}`);
                                 if (activePrototypeContent) activePrototypeContent.classList.add('active');

                                  // Setup canvas only if sketch is the default active type
                                  if (type === 'sketch') {
                                       requestAnimationFrame(setupSketchCanvas);
                                  }
                             } else {
                                  // Fallback: If no prototype button is active, default to sketch
                                  const sketchButton = document.querySelector('#prototype-type-selector .prototype-btn[data-type="sketch"]');
                                  const sketchContent = document.getElementById('prototype-content-sketch');
                                  if (sketchButton && sketchContent) {
                                       sketchButton.classList.add('active');
                                       sketchContent.classList.add('active');
                                       requestAnimationFrame(setupSketchCanvas);
                                  }
                             }
                         }
                    }
                } else {
                     console.warn(`Content area for tab "${target}" not found.`);
                 }
            }
             // Hide controls when switching main tabs
             hideElementControls();
        }


        const openModal = () => {
             if(modal) modal.classList.remove('hidden');
            if(modal) modal.classList.add('flex');
        };

        const closeModal = () => {
             if(modal) modal.classList.add('hidden');
             if(modal) modal.classList.remove('flex');
        };

        // Event Listeners for Modal
         if (manualButton) manualButton.addEventListener('click', openModal);
         if (closeModalButton) closeModalButton.addEventListener('click', closeModal);
         if (modal) {
             modal.addEventListener('click', (e) => {
                 if (e.target === modal) {
                     closeModal();
                 }
             });
         }
          if (startFromModalButton) {
              startFromModalButton.addEventListener('click', () => {
                  closeModal();
                  showPage('main');
                  setActiveTab('light');
              });
          }


        // Event Listeners for Main Tabs
        if (homeButton) {
            homeButton.addEventListener('click', () => {
                showPage('home');
                setActiveTab('home');
            });
        }
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                 if (tabName) { // Check if data-tab exists
                     showPage('main');
                     setActiveTab(tabName);
                 } else {
                     console.warn("Button clicked without data-tab attribute:", button);
                 }
            });
        });

        // Event Listeners for Extra Navigation Buttons (Fruit, Dictionary, Report)
        const extraNavButtons = document.querySelectorAll('.extra-nav-button');
        extraNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                if (tabName) {
                    showPage('main');
                    setActiveTab(tabName);
                }
            });
        });


        // --- '빛' 탭 스크립트 ---
        const emojiSelector = document.getElementById('emoji-selector');
        const selectedEmojiInput = document.getElementById('selected-emoji');
        const questionInput = document.getElementById('question-input');
        const addQuestionBtn = document.getElementById('add-question-btn');
        const questionList = document.getElementById('question-list');
        const questionPlaceholder = document.getElementById('question-placeholder');

        // 이모지 선택
        if (emojiSelector) {
            emojiSelector.addEventListener('click', (e) => {
                const button = e.target.closest('.emoji-btn');
                if (button) {
                    emojiSelector.querySelectorAll('.emoji-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                     if(selectedEmojiInput) selectedEmojiInput.value = button.dataset.emoji;
                }
            });
        }

        // 질문 추가
        function addQuestion() {
             if (!questionInput || !questionList) return; // Add checks
            const questionText = questionInput.value.trim();
            if (questionText) {
                if (questionPlaceholder) questionPlaceholder.classList.add('hidden');
                const newQuestion = document.createElement('li');
                newQuestion.className = 'p-3 bg-white border border-gray-200 rounded-lg text-gray-800 text-sm flex justify-between items-center animate-fade-in';
                const textSpan = document.createElement('span');
                textSpan.textContent = `❓ ${questionText}`;
                newQuestion.appendChild(textSpan);
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '삭제';
                deleteBtn.className = 'text-red-500 hover:text-red-700 text-xs font-medium ml-4';
                deleteBtn.onclick = () => {
                    newQuestion.remove();
                    // Check children excluding the placeholder if it exists
                     const actualItemCount = Array.from(questionList.children).filter(child => child !== questionPlaceholder).length;
                     if (actualItemCount === 0 && questionPlaceholder) {
                          questionPlaceholder.classList.remove('hidden');
                     }
                };
                newQuestion.appendChild(deleteBtn);
                questionList.appendChild(newQuestion);
                questionInput.value = '';
            }
        }


        if (addQuestionBtn) addQuestionBtn.addEventListener('click', addQuestion);
        if (questionInput) questionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addQuestion();
        });

        // --- '빛' 탭 스크립트 끝 ---

        // --- '거울' 탭 스크립트 ---
        const mirrorTabButtons = document.querySelectorAll('.mirror-tab-btn');
        const mirrorContents = document.querySelectorAll('.mirror-content');
        const povCharacterNameInput = document.getElementById('pov-character-name');
        const povNeedInput = document.getElementById('pov-need');
        const povReasonInput = document.getElementById('pov-reason');
        const povSentenceDisplay = document.getElementById('pov-sentence-display');

        function updatePovSentence() {
            if (!povCharacterNameInput || !povNeedInput || !povReasonInput || !povSentenceDisplay) return;
            const character = povCharacterNameInput.value.trim() || '[인물]';
            const need = povNeedInput.value.trim() || '[필요한 것]';
            const reason = povReasonInput.value.trim() || '[이유/생각]';
            povSentenceDisplay.innerHTML = `
                <div>
                    <span class="font-bold">${character}</span>은(는) <span class="font-bold text-pink-600">${need}</span>을(를) 필요로 한다.
                    <br>
                    왜냐하면 <span class="font-bold text-pink-600">${reason}</span> 때문이다.
                </div>`;
        }

        if (mirrorTabButtons.length > 0) {
            mirrorTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    mirrorTabButtons.forEach(btn => btn.classList.remove('active'));
                    mirrorContents.forEach(content => content.classList.add('hidden'));
                    button.classList.add('active');
                    const activeContent = document.getElementById(`mirror-content-${tabName}`);
                    if (activeContent) activeContent.classList.remove('hidden');
                });
            });
        }
        if (povCharacterNameInput) povCharacterNameInput.addEventListener('input', updatePovSentence);
        if (povNeedInput) povNeedInput.addEventListener('input', updatePovSentence);
        if (povReasonInput) povReasonInput.addEventListener('input', updatePovSentence);
        // --- '거울' 탭 스크립트 끝 ---

        // --- '창문' 탭 스크립트 ---
        const windowTabButtons = document.querySelectorAll('.window-tab-btn');
        const windowContents = document.querySelectorAll('.window-content');
        const windowHmwUserInput = document.getElementById('window-hmw-user');
        const windowHmwNeedInput = document.getElementById('window-hmw-need');
        const hmwSentenceDisplay = document.getElementById('hmw-sentence-display');
        const hmwDisplayUser = document.getElementById('hmw-display-user');
        const hmwDisplayNeed = document.getElementById('hmw-display-need');
        const ideaNameInput = document.getElementById('idea-name-input'); // Name input
        const ideaBubbleInput = document.getElementById('idea-bubble-input'); // Idea input
        const addIdeaBubbleBtn = document.getElementById('add-idea-bubble-btn'); // Add button
        const ideaBubbleListContainer = document.getElementById('idea-bubble-list-container'); // Container


        // '창문' 탭의 서브탭(재정의/아이디어) 전환 로직
        if (windowTabButtons.length > 0) {
            windowTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    windowTabButtons.forEach(btn => btn.classList.remove('active'));
                    windowContents.forEach(content => content.classList.add('hidden'));
                    button.classList.add('active');
                    const activeContent = document.getElementById(`window-content-${tabName}`);
                    if (activeContent) activeContent.classList.remove('hidden');
                });
            });
        }

        // HMW 문장 자동 생성
        function updateHmwSentence() {
            if (!windowHmwUserInput || !windowHmwNeedInput || !hmwDisplayUser || !hmwDisplayNeed) return;
            const user = windowHmwUserInput.value.trim() || '[사용자]';
            const need = windowHmwNeedInput.value.trim() || '[원하는 것]';

            hmwDisplayUser.textContent = user;
            hmwDisplayNeed.textContent = need;
        }
        if (windowHmwUserInput) windowHmwUserInput.addEventListener('input', updateHmwSentence);
        if (windowHmwNeedInput) windowHmwNeedInput.addEventListener('input', updateHmwSentence);

         // 아이디어 말풍선 추가
         function addIdeaBubble() {
             if (!ideaNameInput || !ideaBubbleInput || !ideaBubbleListContainer) return;
             const nameText = ideaNameInput.value.trim();
             const ideaText = ideaBubbleInput.value.trim();

             if (ideaText) { // Idea text is mandatory
                 const bubble = document.createElement('div');
                 bubble.className = 'post-it-bubble animate-fade-in';

                 const innerDiv = document.createElement('div');
                 innerDiv.className = 'post-it-bubble-inner';

                 // Name Input (optional, but create the element)
                 const nameInput = document.createElement('input');
                 nameInput.type = 'text';
                 nameInput.value = nameText; // Pre-fill if provided
                 nameInput.placeholder = '이름 (선택)';
                 nameInput.className = 'post-it-name-input';
                 innerDiv.appendChild(nameInput);

                 // Idea Text Area (editable)
                 const textArea = document.createElement('textarea');
                 textArea.value = ideaText;
                 textArea.className = 'post-it-text-bubble';
                 textArea.placeholder = '아이디어';
                 // Make textarea auto-grow
                 textArea.style.height = 'auto';
                 textArea.style.height = (textArea.scrollHeight) + 'px';
                 textArea.addEventListener('input', () => {
                     textArea.style.height = 'auto';
                     textArea.style.height = (textArea.scrollHeight) + 'px';
                 }, false);
                 innerDiv.appendChild(textArea);

                 bubble.appendChild(innerDiv);

                 // 삭제 버튼
                 const deleteBtn = document.createElement('button');
                 deleteBtn.className = 'post-it-delete-bubble';
                 deleteBtn.innerHTML = '&times;';
                 deleteBtn.onclick = () => {
                     bubble.remove();
                 };
                 bubble.appendChild(deleteBtn);

                 ideaBubbleListContainer.prepend(bubble); // 맨 위에 추가
                 ideaNameInput.value = ''; // Clear inputs
                 ideaBubbleInput.value = '';
                 ideaNameInput.focus(); // Focus back on name for next entry
             }
         }

         if (addIdeaBubbleBtn) addIdeaBubbleBtn.addEventListener('click', addIdeaBubble);
         // Optional: Add idea on Enter key press in the idea input
         if (ideaBubbleInput) ideaBubbleInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter' && !e.shiftKey) { // Prevent Enter in textarea adding new bubble
                 e.preventDefault(); // Prevent line break
                 addIdeaBubble();
             }
         });


        // --- '창문' 탭 신규 기능 스크립트 ---

        // 1. SCAMPER 아코디언
        const scamperAccordion = document.getElementById('scamper-accordion');
        if (scamperAccordion) {
            scamperAccordion.addEventListener('click', (e) => {
                const trigger = e.target.closest('.scamper-trigger');
                if (!trigger) return;

                const content = trigger.nextElementSibling;
                const icon = trigger.querySelector('.scamper-icon');

                // Toggle active state for the clicked item
                 const isActive = trigger.classList.contains('active');

                // Close all items first (optional: if you want only one open at a time)
                 // scamperAccordion.querySelectorAll('.scamper-trigger.active').forEach(activeTrigger => {
                 //     if (activeTrigger !== trigger) {
                 //         activeTrigger.classList.remove('active');
                 //         activeTrigger.nextElementSibling.classList.remove('active');
                 //     }
                 // });


                if (!isActive) {
                    trigger.classList.add('active');
                     if(content) content.classList.add('active'); // Check if content exists
                } else {
                     trigger.classList.remove('active');
                      if(content) content.classList.remove('active');
                }
                 // Update icons after toggling
                 renderIcons(); // Re-render icons to ensure correct rotation
            });
        }



        // 2. 주사위 실험실
        const diceCountSelect = document.getElementById('dice-count-select');
        const diceInputsContainer = document.getElementById('dice-inputs-container');
        const rollDiceBtn = document.getElementById('roll-dice-btn');
        const diceResult = document.getElementById('dice-result');

        function updateDiceView() {
            if (!diceCountSelect || !diceInputsContainer) return;
            const count = parseInt(diceCountSelect.value, 10);
            const diceGroups = diceInputsContainer.querySelectorAll('.dice-group');

            diceGroups.forEach((group, index) => {
                group.classList.toggle('hidden', index >= count);
            });
        }

        if (diceCountSelect) diceCountSelect.addEventListener('change', updateDiceView);

        if (rollDiceBtn) {
            rollDiceBtn.addEventListener('click', () => {
                if (!diceCountSelect || !diceInputsContainer || !diceResult) return;
                const count = parseInt(diceCountSelect.value, 10);
                let combinedIdea = "";

                for (let i = 1; i <= count; i++) {
                    const dieGroup = document.getElementById(`die-${i}`);
                    if (dieGroup && !dieGroup.classList.contains('hidden')) {
                        const inputs = Array.from(dieGroup.querySelectorAll('.dice-input')).map(input => input.value.trim()).filter(val => val !== ''); // Get only non-empty values
                        if (inputs.length > 0) {
                            const randomIndex = Math.floor(Math.random() * inputs.length);
                            combinedIdea += inputs[randomIndex] + " ";
                         } else {
                              combinedIdea += `(주사위 ${i} 비어있음) `;
                         }
                    }
                }

                diceResult.textContent = combinedIdea.trim() || "아이디어를 입력하고 주사위를 굴려보세요!";
            });
        }
         // Initial dice view setup
         if (diceCountSelect) updateDiceView(); // Check if element exists


        // 3. 삼삼오오 카운트다운
        const timerDisplay = document.getElementById('timer-display');
        const minutesInput = document.getElementById('timer-minutes');
        const secondsInput = document.getElementById('timer-seconds');
        const startBtn = document.getElementById('timer-start');
        const pauseBtn = document.getElementById('timer-pause');
        const timerResetBtn = document.getElementById('timer-reset'); // Changed variable name

        let timerInterval = null;
        let totalSeconds = 300; // 기본 5분

        function formatTime(seconds) {
             const clampedSeconds = Math.max(0, seconds); // Ensure seconds is not negative
            const min = String(Math.floor(clampedSeconds / 60)).padStart(2, '0');
            const sec = String(clampedSeconds % 60).padStart(2, '0');
            return `${min}:${sec}`;
        }


        function updateTimerDisplay() {
            if (timerDisplay) timerDisplay.textContent = formatTime(totalSeconds);
        }

        function startTimer() {
            if (timerInterval) return; // 이미 실행 중
            if (totalSeconds <= 0) return; // Don't start if time is up
            if (timerDisplay) timerDisplay.classList.remove('timer-finished');

            timerInterval = setInterval(() => {
                totalSeconds--;
                updateTimerDisplay();

                if (totalSeconds <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    if (timerDisplay) timerDisplay.classList.add('timer-finished');
                    // TODO: 알림 소리 등
                     // Use a custom modal or message box instead of alert
                     // showCustomAlert('시간 종료!');
                     console.log('Timer finished!'); // Placeholder
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timerInterval);
            timerInterval = null;
        }

        function resetTimer() {
            pauseTimer();
             // Ensure inputs exist before accessing value
             const minsValue = minutesInput ? minutesInput.value : '5';
             const secsValue = secondsInput ? secondsInput.value : '0';
            const mins = parseInt(minsValue, 10) || 0;
            const secs = parseInt(secsValue, 10) || 0;
            totalSeconds = (mins * 60) + secs;
            // Ensure totalSeconds is not negative
            if (totalSeconds < 0) totalSeconds = 0;
            updateTimerDisplay();
            if (timerDisplay) timerDisplay.classList.remove('timer-finished');
        }


        if (startBtn) startBtn.addEventListener('click', startTimer);
        if (pauseBtn) pauseBtn.addEventListener('click', pauseTimer);
        if (timerResetBtn) timerResetBtn.addEventListener('click', resetTimer); // Changed variable name
        // Reset timer when inputs are changed
        if (minutesInput) minutesInput.addEventListener('change', resetTimer);
        if (secondsInput) secondsInput.addEventListener('change', resetTimer);
        // Initial display update
        if (timerDisplay) updateTimerDisplay(); // Check if timerDisplay exists before calling


        // --- '창문' 탭 신규 기능 스크립트 ---

        // --- '미닫이문' 탭 스크립트 ---
        const doorTabButtons = document.querySelectorAll('.door-tab-btn');
        const doorContents = document.querySelectorAll('.door-content');
        const prototypeTypeSelector = document.getElementById('prototype-type-selector');
        const prototypeContents = document.querySelectorAll('.prototype-content');
        const photoPreview = document.getElementById('photo-preview');
        const videoPreview = document.getElementById('video-preview');
        const sketchCanvas = document.getElementById('sketch-canvas');
        const sketchColorPalette = document.getElementById('sketch-color-palette');
        const sketchTools = document.querySelectorAll('.sketch-tool');
        const clearCanvasBtn = document.getElementById('clear-canvas-btn');
        let sketchCtx;
        let isDrawing = false;
        let currentTool = 'pencil';
        let currentColor = 'black';
        let lastX = 0;
        let lastY = 0;

        // '미닫이문' 탭의 서브탭(프로토타입/테스트) 전환 로직
        if (doorTabButtons.length > 0) {
            doorTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    doorTabButtons.forEach(btn => btn.classList.remove('active'));
                    doorContents.forEach(content => content.classList.add('hidden'));
                    button.classList.add('active');
                    const activeContent = document.getElementById(`door-content-${tabName}`);
                    if (activeContent) activeContent.classList.remove('hidden');
                     // Hide app design controls when switching sub-tabs
                     hideElementControls();
                });
            });
             // Ensure default active state for prototype tab (handled by setActiveTab)
        }

        // 프로토타입 종류 선택 로직
        if (prototypeTypeSelector) {
            prototypeTypeSelector.addEventListener('click', (e) => {
                const button = e.target.closest('.prototype-btn');
                if (button) {
                    const type = button.dataset.type;
                    prototypeTypeSelector.querySelectorAll('.prototype-btn').forEach(btn => btn.classList.remove('active'));
                    prototypeContents.forEach(content => content.classList.remove('active')); // Use 'active' class for content too

                    button.classList.add('active');
                    const activeContent = document.getElementById(`prototype-content-${type}`);
                    if (activeContent) activeContent.classList.add('active');

                    // If sketch is selected, ensure canvas is ready
                    if (type === 'sketch') {
                         requestAnimationFrame(setupSketchCanvas); // Use rAF to ensure layout is calculated
                    }
                     // Hide controls if switching away from app design
                     if (type !== 'appdesign') {
                        hideElementControls();
                    }
                }
            });
             // Default active state is handled by setActiveTab calling setupSketchCanvas
        }

        // 스케치 그림판 설정 함수
        function setupSketchCanvas() {
             if (!sketchCanvas) return; // Exit if canvas doesn't exist

             // Adjust canvas size for high DPI screens ONLY IF NOT ALREADY DONE or if size changed
             const dpr = window.devicePixelRatio || 1;
             const rect = sketchCanvas.getBoundingClientRect();
             const desiredWidth = Math.floor(rect.width); // Use floor to avoid fractional pixels
             const desiredHeight = Math.floor(rect.height);

             // Only resize if necessary to avoid clearing canvas unintentionally
             if (sketchCanvas.width !== desiredWidth * dpr || sketchCanvas.height !== desiredHeight * dpr) {
                 sketchCanvas.width = desiredWidth * dpr;
                 sketchCanvas.height = desiredHeight * dpr;
                 sketchCtx = sketchCanvas.getContext('2d', { willReadFrequently: false }); // Set context if resized
                 if(sketchCtx) sketchCtx.scale(dpr, dpr); // Scale context only if context is valid
                 console.log("Canvas resized and context set.");
             } else if (!sketchCtx) {
                 // If size is correct but context not set (first time)
                  sketchCtx = sketchCanvas.getContext('2d', { willReadFrequently: false });
                   if(sketchCtx) sketchCtx.scale(dpr, dpr);
                  console.log("Context set without resize.");
             }

             if(sketchCtx) { // Ensure context exists before setting properties
                sketchCtx.strokeStyle = currentColor;
                sketchCtx.lineWidth = 2;
                sketchCtx.lineJoin = 'round';
                sketchCtx.lineCap = 'round';
             } else {
                 console.error("Failed to get sketch context");
                 return; // Stop if context failed
             }


             // Remove previous listeners before adding new ones to prevent duplicates
             sketchCanvas.removeEventListener('mousedown', startDrawing);
             sketchCanvas.removeEventListener('mousemove', draw);
             sketchCanvas.removeEventListener('mouseup', stopDrawing);
             sketchCanvas.removeEventListener('mouseout', stopDrawing);
             sketchCanvas.removeEventListener('touchstart', startDrawingTouch);
             sketchCanvas.removeEventListener('touchmove', drawTouch);
             sketchCanvas.removeEventListener('touchend', stopDrawing);

             // Add event listeners
             sketchCanvas.addEventListener('mousedown', startDrawing);
             sketchCanvas.addEventListener('mousemove', draw);
             sketchCanvas.addEventListener('mouseup', stopDrawing);
             sketchCanvas.addEventListener('mouseout', stopDrawing);
             // Touch events
             sketchCanvas.addEventListener('touchstart', startDrawingTouch, { passive: false }); // Need passive: false for preventDefault
             sketchCanvas.addEventListener('touchmove', drawTouch, { passive: false });
             sketchCanvas.addEventListener('touchend', stopDrawing);
             // console.log("Sketch event listeners attached."); // Reduce logging
        }


        function getMousePos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
            // No scaling needed here if context is scaled
            return {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }
          function getTouchPos(canvas, evt) {
            const rect = canvas.getBoundingClientRect();
             if (evt.touches.length > 0) {
                 return {
                    x: evt.touches[0].clientX - rect.left,
                    y: evt.touches[0].clientY - rect.top
                };
             }
             return { x: 0, y: 0 }; // Fallback
        }


        function startDrawing(e) {
             if (!sketchCtx || !isElementVisible(sketchCanvas)) return; // Check visibility
            isDrawing = true;
            const pos = getMousePos(sketchCanvas, e);
            [lastX, lastY] = [pos.x, pos.y];
             sketchCtx.beginPath(); // Start a new path
             sketchCtx.moveTo(lastX, lastY);
        }
         function startDrawingTouch(e) {
              if (!sketchCtx || !isElementVisible(sketchCanvas)) return;
             if (e.touches.length === 1) {
                 e.preventDefault();
                 isDrawing = true;
                 const pos = getTouchPos(sketchCanvas, e);
                 [lastX, lastY] = [pos.x, pos.y];
                  sketchCtx.beginPath();
                  sketchCtx.moveTo(lastX, lastY);
             }
         }

        function draw(e) {
            if (!isDrawing || !sketchCtx || !isElementVisible(sketchCanvas)) return;
            const pos = getMousePos(sketchCanvas, e);
            drawLine(pos.x, pos.y);
            // Don't update lastX/Y here, update after stroke in drawLine
        }

        function drawTouch(e) {
             if (!isDrawing || e.touches.length !== 1 || !sketchCtx || !isElementVisible(sketchCanvas)) return;
             e.preventDefault();
             const pos = getTouchPos(sketchCanvas, e);
             drawLine(pos.x, pos.y);
              // Don't update lastX/Y here
         }

         function drawLine(x, y) {
             if (!sketchCtx) return;
             // Set drawing properties inside drawLine to ensure they are current
             if (currentTool === 'pencil') {
                 sketchCtx.globalCompositeOperation = 'source-over';
                 sketchCtx.strokeStyle = currentColor;
                 sketchCtx.lineWidth = 2;
             } else if (currentTool === 'eraser') {
                 sketchCtx.globalCompositeOperation = 'destination-out';
                 sketchCtx.strokeStyle = 'rgba(0,0,0,1)'; // Eraser needs a color to clear
                 sketchCtx.lineWidth = 10;
             }
             // Continue the path from the last point
              sketchCtx.lineTo(x, y);
             sketchCtx.stroke(); // Draw the segment
             // Update last position *after* drawing the segment
              [lastX, lastY] = [x, y];

         }


        function stopDrawing() {
             if (!isDrawing) return;
             isDrawing = false;
              // sketchCtx.closePath(); // Not typically needed for freehand drawing
        }

         // Helper to check if element is visible
         function isElementVisible(el) {
             if (!el) return false;
             return !!( el.offsetWidth || el.offsetHeight || el.getClientRects().length );
         }


        // Tool selection
        sketchTools.forEach(tool => {
            tool.addEventListener('click', () => {
                sketchTools.forEach(t => t.classList.remove('active'));
                tool.classList.add('active');
                currentTool = tool.dataset.tool;
            });
        });

        // Color selection
        if (sketchColorPalette) {
            sketchColorPalette.addEventListener('click', (e) => {
                const colorButton = e.target.closest('.sketch-color');
                if (colorButton) {
                    sketchColorPalette.querySelectorAll('.sketch-color').forEach(c => c.classList.remove('active'));
                    colorButton.classList.add('active');
                    currentColor = colorButton.dataset.color;
                    // Note: strokeStyle is set within drawLine now
                }
            });
        }
          // Clear canvas
         if (clearCanvasBtn) {
             clearCanvasBtn.addEventListener('click', () => {
                 if (sketchCtx && sketchCanvas) {
                    const dpr = window.devicePixelRatio || 1;
                    sketchCtx.clearRect(0, 0, sketchCanvas.width / dpr, sketchCanvas.height / dpr);
                 }
             });
         }


        // 파일 미리보기 (사진, 영상)
        const photoUploadInput = document.getElementById('photo-upload-input');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const videoUploadInput = document.getElementById('video-upload-input');
        const videoPreviewContainer = document.getElementById('video-preview-container');

        // 드래그 앤 드롭 재정렬 함수
        function makeDraggable(container) {
            let draggedElement = null;

            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('relative')) {
                    draggedElement = e.target;
                    e.target.style.opacity = '0.5';
                }
            });

            container.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('relative')) {
                    e.target.style.opacity = '1';
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.relative:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // 사진 업로드 (여러 장 지원)
        if (photoUploadInput && photoPreviewContainer) {
            photoUploadInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const imgWrapper = document.createElement('div');
                                imgWrapper.className = 'relative cursor-move';
                                imgWrapper.draggable = true;

                                const img = document.createElement('img');
                                img.src = event.target.result;
                                img.alt = '업로드된 사진';
                                img.className = 'max-w-xs mx-auto rounded-lg shadow pointer-events-none';

                                const deleteBtn = document.createElement('button');
                                deleteBtn.textContent = '×';
                                deleteBtn.className = 'absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full hover:bg-red-600 font-bold z-10';
                                deleteBtn.onclick = () => imgWrapper.remove();

                                const dragHandle = document.createElement('div');
                                dragHandle.className = 'absolute top-2 left-2 bg-gray-700 bg-opacity-50 text-white px-2 py-1 rounded text-xs';
                                dragHandle.textContent = '☰ 드래그';

                                imgWrapper.appendChild(img);
                                imgWrapper.appendChild(deleteBtn);
                                imgWrapper.appendChild(dragHandle);
                                photoPreviewContainer.appendChild(imgWrapper);
                            }
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            // 드래그 기능 활성화
            makeDraggable(photoPreviewContainer);
        }

        // 영상 업로드 (여러 개 지원)
        if (videoUploadInput && videoPreviewContainer) {
            videoUploadInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    files.forEach(file => {
                        if (file.type.startsWith('video/')) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                const videoWrapper = document.createElement('div');
                                videoWrapper.className = 'relative cursor-move';
                                videoWrapper.draggable = true;

                                const video = document.createElement('video');
                                video.src = event.target.result;
                                video.controls = true;
                                video.className = 'max-w-xs mx-auto rounded-lg shadow';

                                const deleteBtn = document.createElement('button');
                                deleteBtn.textContent = '×';
                                deleteBtn.className = 'absolute top-2 right-2 bg-red-500 text-white w-6 h-6 rounded-full hover:bg-red-600 font-bold z-10';
                                deleteBtn.onclick = () => videoWrapper.remove();

                                const dragHandle = document.createElement('div');
                                dragHandle.className = 'absolute top-2 left-2 bg-gray-700 bg-opacity-50 text-white px-2 py-1 rounded text-xs';
                                dragHandle.textContent = '☰ 드래그';

                                videoWrapper.appendChild(video);
                                videoWrapper.appendChild(deleteBtn);
                                videoWrapper.appendChild(dragHandle);
                                videoPreviewContainer.appendChild(videoWrapper);
                            }
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });

            // 드래그 기능 활성화
            makeDraggable(videoPreviewContainer);
        }

         // --- App Design Logic ---
         // Variables declared earlier


         // --- Emoji Picker Setup ---
          const commonEmojis = [
             '😀', '😂', '😊', '😍', '🤔', '😢', '😠', '😮', '🎉', '💖', '👍', '👎',
             '👋', '🙏', '👀', '👂', '👃', '👄', '🧠', '👤', '👥', '💬', '✏️', '🔒',
             '🔑', '💡', '🔍', '⚙️', '📞', '⏰', '⭐', '❤️', '💔', '💯', '✅', '❌',
             '❓', '❗', '➡️', '⬅️', '⬆️', '⬇️', '➕', '➖', '🏠', '🏫', '🏢', '🌍'
         ];
          if(emojiPickerContent) {
             // Clear existing emojis except close button before repopulating
             const closeButton = emojiPickerContent.querySelector('#close-emoji-picker-inner');
             if (closeButton) {
                 emojiPickerContent.innerHTML = ''; // Clear everything
                 emojiPickerContent.appendChild(closeButton); // Add close button back
             }
              commonEmojis.forEach(emoji => {
                 const btn = document.createElement('button');
                 btn.textContent = emoji;
                 btn.onclick = () => {
                     addElement('emoji', emoji);
                     closeEmojiPicker();
                 };
                 emojiPickerContent.appendChild(btn);
             });
          }
           // Use the outer button if it exists
           // if (closeEmojiPickerBtn) { // This variable might not be defined if element is dynamically added
            const innerCloseBtn = document.getElementById('close-emoji-picker-inner');
             if (innerCloseBtn) {
                 innerCloseBtn.addEventListener('click', closeEmojiPicker);
             }

            // Close modal if clicking outside content
           if(emojiPickerModal) {
                 emojiPickerModal.addEventListener('click', (e) => {
                     if (e.target === emojiPickerModal) {
                         closeEmojiPicker();
                     }
                 });
           }


          function openEmojiPicker() {
              if (emojiPickerModal) emojiPickerModal.classList.add('visible');
          }
           function closeEmojiPicker() {
               if (emojiPickerModal) emojiPickerModal.classList.remove('visible');
           }


          // --- Page Management ---
          function saveCurrentPageState() {
             if (!appDesignScreen) return;
             const elements = [];
             appDesignScreen.querySelectorAll('.app-element').forEach(el => {
                 const styleData = { // Save computed style for reliable restoration
                     left: el.style.left || '10px',
                     top: el.style.top || '10px',
                     width: el.style.width || '',
                     height: el.style.height || '',
                     fontSize: el.style.fontSize || '',
                     color: el.style.color || '',
                     fontFamily: el.style.fontFamily || '',
                     backgroundColor: el.style.backgroundColor || '', // For buttons
                 };
                  const elementData = {
                      id: el.dataset.id || `el-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`, // Assign ID if new
                      type: el.dataset.type,
                      content: el.dataset.type === 'image' ? el.querySelector('img')?.src : el.textContent, // Save image src
                      style: styleData,
                      shape: el.dataset.shape || '' // Store button shape
                  };
                 elements.push(elementData);
                 // Update element's dataset.id if it was new
                 if (!el.dataset.id) el.dataset.id = elementData.id;
             });
             appPages[currentPageIndex] = elements;
             // console.log(`Page ${currentPageIndex + 1} saved:`, appPages[currentPageIndex]); // Reduce logging
         }

          function renderPage(pageIndex) {
              if (!appDesignScreen || pageIndex < 0 || pageIndex >= appPages.length) return;

               // Save state *before* clearing the screen
               // saveCurrentPageState(); // Let's try saving only when explicitly needed or switching page

              currentPageIndex = pageIndex;
              appDesignScreen.innerHTML = ''; // Clear screen

              const pageElements = appPages[currentPageIndex];
               if (pageElements.length === 0) {
                 // Show placeholder if page is empty
                 appDesignScreen.innerHTML = '<p class="text-gray-400 text-center text-sm absolute inset-0 flex items-center justify-center pointer-events-none">컨트롤 버튼을 눌러 요소를 추가하세요.</p>';
             } else {
                 pageElements.forEach(elementData => {
                     const el = createElementFromData(elementData);
                     appDesignScreen.appendChild(el);
                 });
             }
              updatePageIndicator();
              hideElementControls(); // Deselect elements when changing pages
              renderIcons(); // Re-render icons if needed
              // console.log(`Page ${currentPageIndex + 1} rendered.`); // Reduce logging
          }

           function createElementFromData(data) {
              let element;
              if (data.type === 'button') {
                  element = document.createElement('button');
                  element.className = 'app-element button-element';
                  element.textContent = data.content;
              } else if (data.type === 'image') {
                  element = document.createElement('div');
                  element.className = 'app-element image-element';
                  const img = document.createElement('img');
                  img.src = data.content; // Content is the data URL
                  img.alt = 'Uploaded Image';
                   // Apply dimensions from style to the container div
                   element.style.width = data.style.width || '100px'; // Default size
                   element.style.height = data.style.height || 'auto'; // Default auto height
                   img.style.pointerEvents = 'none'; // Ensure img doesn't block drag/resize
                   element.appendChild(img);
              }
               else {
                  element = document.createElement('div');
                   element.className = `app-element ${data.type}-element`;
                   element.textContent = data.content;
              }
               element.dataset.id = data.id;
               element.dataset.type = data.type;

               // Apply saved styles directly
                Object.keys(data.style).forEach(key => {
                    if (data.style[key]) { // Apply only if value exists
                        element.style[key] = data.style[key];
                    }
                });

               // Apply button shape
               if (data.type === 'button' && data.shape) {
                    element.dataset.shape = data.shape;
                    if (data.shape === 'circle') {
                         element.classList.add('button-shape-circle');
                         // Set CSS variable for size if circle
                         const size = Math.max(parseFloat(data.style.width) || 50, parseFloat(data.style.height) || 50);
                         element.style.setProperty('--size', `${size}px`);
                     }
                    // Add other shapes if implemented
                }


               if(data.type === 'text') {
                  element.setAttribute('contenteditable', 'true');
                  // Add input listener for continuous save, blur for final save
                  element.addEventListener('input', saveCurrentPageState);
                  element.addEventListener('blur', saveCurrentPageState);
               }

              makeElementDraggable(element);
               // Use mousedown/touchstart for selection to be consistent with drag/resize start
              element.addEventListener('mousedown', (e) => {
                  e.stopPropagation();
                   // If clicking a handle, don't re-select, let handle logic take over
                   if (!e.target.classList.contains('resize-handle')) {
                        selectElement(element);
                   }
              });
               element.addEventListener('touchstart', (e) => {
                   e.stopPropagation();
                    if (!e.target.classList.contains('resize-handle')) {
                        selectElement(element);
                    }
               }, { passive: true }); // Make selection passive if not preventing default for drag
               return element;
           }

          function addPage() {
             saveCurrentPageState(); // Save current before adding
             appPages.push([]); // Add a new empty page
             renderPage(appPages.length - 1); // Switch to the new page
         }

          function prevPage() {
             if (currentPageIndex > 0) {
                 saveCurrentPageState(); // Save before switching
                 renderPage(currentPageIndex - 1);
             }
         }

          function nextPage() {
             if (currentPageIndex < appPages.length - 1) {
                  saveCurrentPageState(); // Save before switching
                 renderPage(currentPageIndex + 1);
             } else {
                 // Optional: Add a new page if trying to go past the last one
                 // addPage(); // This automatically saves and renders
             }
         }


          function updatePageIndicator() {
             if(pageIndicator) {
                  pageIndicator.textContent = `Page ${currentPageIndex + 1} / ${appPages.length}`;
             }
              if(prevPageBtn) prevPageBtn.disabled = currentPageIndex === 0;
              // Next button should be disabled only if on the last page
              if(nextPageBtn) nextPageBtn.disabled = currentPageIndex === appPages.length - 1;
          }

           // Attach listeners to add buttons
           if (addElementBtns.length > 0) {
               addElementBtns.forEach(btn => {
                   btn.addEventListener('click', () => {
                       const type = btn.dataset.type;
                       if (type === 'emoji') {
                           openEmojiPicker();
                       } else if (type === 'image') {
                            if(imageUploadInput) imageUploadInput.click(); // Trigger file input
                       }
                        else {
                           addElement(type);
                       }
                   });
               });
           }

           // Image Upload Handler
            if (imageUploadInput) {
                imageUploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            addElement('image', event.target.result); // Add image with data URL
                        }
                        reader.readAsDataURL(file);
                         // Reset input value to allow uploading the same file again
                         e.target.value = null;
                    } else if (file) {
                         // Replace alert with a custom message box if possible
                        console.warn('Invalid file type. Please upload an image (png, jpg, gif).');
                        // showCustomAlert('이미지 파일(png, jpg, gif)만 업로드 가능합니다.');
                    }
                });
            }


           // Attach page navigation listeners
          if(addPageBtn) addPageBtn.addEventListener('click', addPage);
          if(prevPageBtn) prevPageBtn.addEventListener('click', prevPage);
          if(nextPageBtn) nextPageBtn.addEventListener('click', nextPage);


          // --- Element Selection & Controls ---
          function selectElement(element) {
              if (!element || !element.classList.contains('app-element')) {
                  deselectElement(); // Deselect if invalid target
                  return;
              }

             // Deselect previous
             if (selectedElement && selectedElement !== element) {
                  selectedElement.classList.remove('selected');
                  removeResizeHandles(selectedElement); // Remove handles from old selection
             }
              // Select new
             selectedElement = element;
             selectedElement.classList.add('selected');
             addResizeHandles(selectedElement); // Add handles to new selection
             showElementControls(selectedElement);
          }

          function deselectElement() {
              if (selectedElement) {
                  selectedElement.classList.remove('selected');
                   removeResizeHandles(selectedElement); // Remove handles on deselect
                  selectedElement = null;
              }
               hideElementControls();
          }

           // Deselect when clicking on the screen background
          if(appDesignScreen) {
              appDesignScreen.addEventListener('mousedown', (e) => {
                   // Only deselect if the direct target is the screen itself AND not a resize handle
                    if (e.target === appDesignScreen) {
                       deselectElement();
                   }
              });
               appDesignScreen.addEventListener('touchstart', (e) => {
                    if (e.target === appDesignScreen) {
                       deselectElement();
                   }
               }, { passive: true }); // Use passive true if not preventing default
          }


          function showElementControls(element) {
              if (!elementControls || !element) return;

              const type = element.dataset.type;
              // Hide all specific controls first
              if(textControls) textControls.classList.add('hidden');
              if(emojiControls) emojiControls.classList.add('hidden');
              if(buttonControls) buttonControls.classList.add('hidden');
              if(imageControls) imageControls.classList.add('hidden'); // Hide image controls

              // Show controls relevant to the element type and populate values
              if (type === 'text' && textControls && elementFontSelect && elementColorInput && elementSizeInput) {
                  textControls.classList.remove('hidden');
                   elementFontSelect.value = element.style.fontFamily || "'Noto Sans KR', sans-serif"; // Default to body font
                  elementColorInput.value = element.style.color ? rgbToHex(element.style.color) : '#000000';
                  elementSizeInput.value = parseInt(element.style.fontSize) || 16;
              } else if (type === 'emoji' && emojiControls && emojiSizeInput) {
                  emojiControls.classList.remove('hidden');
                  emojiSizeInput.value = parseInt(element.style.fontSize) || 24;
              } else if (type === 'button' && buttonControls && buttonTextInput && buttonBgColorInput && buttonTextColorInput && buttonShapeSelect) { // Include text color input
                  buttonControls.classList.remove('hidden');
                   buttonTextInput.value = element.textContent;
                    buttonBgColorInput.value = element.style.backgroundColor ? rgbToHex(element.style.backgroundColor) : '#3b82f6'; // Default blue
                    buttonTextColorInput.value = element.style.color ? rgbToHex(element.style.color) : '#ffffff'; // Default white text color
                   buttonShapeSelect.value = element.dataset.shape || '';
                   // Size inputs removed
              } else if (type === 'image' && imageControls) {
                   imageControls.classList.remove('hidden');
                   // Populate image controls if any are added
              }


              elementControls.classList.add('visible');
          }


           // Function to convert rgb(r, g, b) to #rrggbb
          function rgbToHex(rgb) {
              if (!rgb || !rgb.startsWith('rgb')) return rgb; // Return original if not rgb
               // Handle cases like "rgb(0, 0, 0)"
              const match = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/);
               if (match) {
                   const r = parseInt(match[1], 10).toString(16).padStart(2, '0');
                   const g = parseInt(match[2], 10).toString(16).padStart(2, '0');
                   const b = parseInt(match[3], 10).toString(16).padStart(2, '0');
                   return `#${r}${g}${b}`;
               }
               return rgb; // Fallback
          }



           // Apply changes from controls
            if(elementFontSelect) elementFontSelect.addEventListener('change', (e) => {
                if (selectedElement && selectedElement.dataset.type === 'text') {
                    selectedElement.style.fontFamily = e.target.value;
                     // Apply corresponding Tailwind class if needed/possible, or just rely on inline style
                     selectedElement.classList.remove('font-noto-sans-kr', 'font-nanum-gothic', 'font-nanum-myeongjo', 'font-gowun-dodum', 'font-east-sea-dokdo', 'font-black-han-sans', 'font-single-day', 'font-grandiflora-one');
                      // Add class based on selection
                      switch(e.target.value) {
                          case "'Nanum Gothic', sans-serif": selectedElement.classList.add('font-nanum-gothic'); break;
                          case "'Nanum Myeongjo', serif": selectedElement.classList.add('font-nanum-myeongjo'); break;
                          case "'Gowun Dodum', sans-serif": selectedElement.classList.add('font-gowun-dodum'); break;
                          case "'East Sea Dokdo', cursive": selectedElement.classList.add('font-east-sea-dokdo'); break;
                          case "'Black Han Sans', sans-serif": selectedElement.classList.add('font-black-han-sans'); break;
                          case "'Single Day', cursive": selectedElement.classList.add('font-single-day'); break;
                          case "'Grandiflora One', cursive": selectedElement.classList.add('font-grandiflora-one'); break;
                          default: selectedElement.classList.add('font-noto-sans-kr'); // Fallback
                      }
                    saveCurrentPageState();
                }
            });
           if(elementColorInput) elementColorInput.addEventListener('input', (e) => {
               if (selectedElement && selectedElement.dataset.type === 'text') { // Only for text
                  selectedElement.style.color = e.target.value;
                  saveCurrentPageState(); // Save after change
               }
           });
           if(elementSizeInput) elementSizeInput.addEventListener('input', (e) => {
               if (selectedElement && selectedElement.dataset.type === 'text') { // Only for text
                  selectedElement.style.fontSize = `${e.target.value}px`;
                  saveCurrentPageState();
               }
           });
           if(emojiSizeInput) emojiSizeInput.addEventListener('input', (e) => {
                 if (selectedElement && selectedElement.dataset.type === 'emoji') { // Only for emoji
                    selectedElement.style.fontSize = `${e.target.value}px`;
                    saveCurrentPageState();
                 }
             });
          if(buttonTextInput) buttonTextInput.addEventListener('input', (e) => {
                 if (selectedElement && selectedElement.dataset.type === 'button') { // Only for button
                    selectedElement.textContent = e.target.value;
                    // Reset size if needed to allow auto-sizing
                     // selectedElement.style.width = '';
                     // selectedElement.style.height = '';
                    saveCurrentPageState();
                 }
             });
            if(buttonBgColorInput) buttonBgColorInput.addEventListener('input', (e) => {
                if (selectedElement && selectedElement.dataset.type === 'button') {
                    selectedElement.style.backgroundColor = e.target.value;
                    saveCurrentPageState();
                }
            });
             // New handler for button text color
             if (buttonTextColorInput) buttonTextColorInput.addEventListener('input', (e) => {
                 if (selectedElement && selectedElement.dataset.type === 'button') {
                     selectedElement.style.color = e.target.value;
                     saveCurrentPageState();
                 }
             });
          if (buttonShapeSelect) buttonShapeSelect.addEventListener('change', (e) => {
                 if (selectedElement && selectedElement.dataset.type === 'button') { // Only for button
                     const shape = e.target.value;
                     selectedElement.dataset.shape = shape;
                      // Remove previous shape classes before adding new one
                     selectedElement.classList.remove('button-shape-circle'); // Add more if needed

                     // Apply new shape class
                     if (shape === 'circle') {
                          selectedElement.classList.add('button-shape-circle');
                          // For circle, force width/height to be equal via aspect ratio
                          selectedElement.style.aspectRatio = '1 / 1';
                          // Make width and height equal based on the larger dimension
                          const size = Math.max(selectedElement.offsetWidth, selectedElement.offsetHeight);
                          selectedElement.style.width = `${size}px`;
                          selectedElement.style.height = `${size}px`;
                           selectedElement.style.setProperty('--size', `${size}px`); // Update CSS variable

                     } else {
                          // Remove aspect ratio for non-circle shapes
                          selectedElement.style.aspectRatio = '';
                           // Optional: reset width/height if needed for non-circle
                          // selectedElement.style.width = 'auto';
                          // selectedElement.style.height = 'auto';
                     }

                     saveCurrentPageState();
                 }
             });
         // Size inputs removed

           // Delete Element
           if(deleteElementBtn) deleteElementBtn.addEventListener('click', () => {
               if (selectedElement) {
                   selectedElement.remove(); // This also removes handles implicitly
                   hideElementControls();
                   saveCurrentPageState(); // Save after deletion
                   // Re-show placeholder if screen is empty
                    if (appDesignScreen && appDesignScreen.querySelectorAll('.app-element').length === 0) {
                       appDesignScreen.innerHTML = '<p class="text-gray-400 text-center text-sm absolute inset-0 flex items-center justify-center pointer-events-none">컨트롤 버튼을 눌러 요소를 추가하세요.</p>';
                    }
               }
           });

           // --- Resize Handle Logic ---
           function addResizeHandles(element) {
               removeResizeHandles(element); // Ensure no duplicates
               const handleTypes = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
               handleTypes.forEach(type => {
                   const handle = document.createElement('div');
                   handle.className = `resize-handle ${type}`;
                   handle.dataset.type = type;
                   element.appendChild(handle);
                   handle.addEventListener('mousedown', startResize);
                   handle.addEventListener('touchstart', startResize, { passive: false });
               });
           }

            function removeResizeHandles(element = null) {
                 // If an element is passed, remove from that one. Otherwise remove from the globally selected one.
                 const target = element || selectedElement;
                if (target) {
                    target.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                }
                 // Also remove handles if no specific element is targeted but one might be globally selected
                  else if (selectedElement) {
                     selectedElement.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                 }
            }


            function startResize(e) {
                e.stopPropagation(); // Prevent selecting the element again
                e.preventDefault(); // Prevent default actions like text selection

                isResizing = true;
                resizeHandleType = e.target.dataset.type;
                selectedElement = e.target.closest('.app-element'); // Ensure we have the element
                 if (!selectedElement) { isResizing = false; return; }


                const rect = selectedElement.getBoundingClientRect();
                 const screenRect = appDesignScreen.getBoundingClientRect();

                let clientX, clientY;
                if (e.type === 'touchstart') {
                    if (e.touches.length !== 1) { isResizing = false; return; }
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                initialResizeInfo = {
                    startX: clientX,
                    startY: clientY,
                    initialWidth: selectedElement.offsetWidth,
                    initialHeight: selectedElement.offsetHeight,
                    initialLeft: parseFloat(selectedElement.style.left) || 0,
                    initialTop: parseFloat(selectedElement.style.top) || 0,
                    aspectRatio: selectedElement.classList.contains('button-shape-circle') ? 1 : null // Store initial aspect ratio for circle
                };
                 // console.log("Start Resize:", initialResizeInfo, resizeHandleType); // Reduce logging


                document.addEventListener('mousemove', resizeMove);
                                document.addEventListener('mouseup', stopResize);
                 document.addEventListener('touchmove', resizeMove, { passive: false });
                 document.addEventListener('touchend', stopResize);
            }

            function resizeMove(e) {
                if (!isResizing || !selectedElement) return;

                e.preventDefault();

                 let clientX, clientY;
                 if (e.type === 'touchmove') {
                     if (e.touches.length !== 1) return; // Only track one finger
                     clientX = e.touches[0].clientX;
                     clientY = e.touches[0].clientY;
                 } else {
                     clientX = e.clientX;
                     clientY = e.clientY; // Corrected: Use clientY for mousemove
                 }


                const dx = clientX - initialResizeInfo.startX;
                const dy = clientY - initialResizeInfo.startY;

                 let newWidth = initialResizeInfo.initialWidth;
                 let newHeight = initialResizeInfo.initialHeight;
                 let newLeft = initialResizeInfo.initialLeft;
                 let newTop = initialResizeInfo.initialTop;

                  // Calculate new dimensions based on handle type
                 if (resizeHandleType.includes('right')) {
                     newWidth = initialResizeInfo.initialWidth + dx;
                 }
                 if (resizeHandleType.includes('left')) { // Use 'if' not 'else if' for corners
                     newWidth = initialResizeInfo.initialWidth - dx;
                     newLeft = initialResizeInfo.initialLeft + dx;
                 }

                 if (resizeHandleType.includes('bottom')) {
                     newHeight = initialResizeInfo.initialHeight + dy;
                 }
                 if (resizeHandleType.includes('top')) { // Use 'if' not 'else if' for corners
                     newHeight = initialResizeInfo.initialHeight - dy;
                     newTop = initialResizeInfo.initialTop + dy;
                 }

                  // Maintain aspect ratio for circle buttons
                 if (initialResizeInfo.aspectRatio === 1) {
                     const size = Math.max(newWidth, newHeight); // Use the larger dimension
                      // Adjust position based on which handle is being dragged
                     if (resizeHandleType.includes('left')) newLeft += (newWidth - size); // Adjust left if width changed
                     if (resizeHandleType.includes('top')) newTop += (newHeight - size); // Adjust top if height changed
                      newWidth = size;
                     newHeight = size;
                     selectedElement.style.setProperty('--size', `${size}px`); // Update CSS variable for circle
                 }



                 // Minimum size constraint
                 const minSize = 20;
                 newWidth = Math.max(minSize, newWidth);
                 newHeight = Math.max(minSize, newHeight);

                 // Update element style
                 selectedElement.style.width = `${newWidth}px`;
                 selectedElement.style.height = `${newHeight}px`;
                 selectedElement.style.left = `${newLeft}px`;
                 selectedElement.style.top = `${newTop}px`;

            }

            function stopResize(e) {
                if (!isResizing) return;
                isResizing = false;
                resizeHandleType = '';
                 // console.log("Stop Resize"); // Reduce logging


                document.removeEventListener('mousemove', resizeMove);
                document.removeEventListener('mouseup', stopResize);
                 document.removeEventListener('touchmove', resizeMove);
                 document.removeEventListener('touchend', stopResize);

                 saveCurrentPageState(); // Save final size/pos
                 // Re-show controls which might have updated values
                  if (selectedElement) showElementControls(selectedElement);
            }



          // --- Element Dragging ---
           function makeElementDraggable(element) {
               element.addEventListener('mousedown', startDrag);
               element.addEventListener('touchstart', startDrag, { passive: false });
           }

           function startDrag(e) {
               // Exit if resizing has already started from a handle
               if (isResizing || !appDesignScreen) return;

                // Ensure the target is the element itself, not a handle or inner contenteditable area during editing
               const targetHandle = e.target.closest('.resize-handle');
               const isEditingText = e.target.closest('[contenteditable="true"]') === document.activeElement; // More robust check

               if (targetHandle || isEditingText) {
                    // console.log("Drag prevented:", { isResizing, isEditingText }); // Reduce logging
                   return; // Don't start drag if interacting with handle or editing text
               }


               isDraggingElement = true;
               selectedElement = e.target.closest('.app-element');
               if (!selectedElement) { isDraggingElement = false; return; }

               // Bring dragged element to front temporarily
               selectedElement.style.zIndex = 1000;
               selectedElement.classList.add('dragging');
               // Select the element visually (might already be selected)
               selectElement(selectedElement);


               const rect = selectedElement.getBoundingClientRect();
               const screenRect = appDesignScreen.getBoundingClientRect();
               let clientX, clientY;

               if (e.type === 'touchstart') {
                    if (e.touches.length !== 1) { isDraggingElement = false; return; }
                    e.preventDefault(); // Prevent scroll while dragging ONLY for touchstart on element
                   clientX = e.touches[0].clientX;
                   clientY = e.touches[0].clientY;
               } else {
                   // Prevent default text selection ONLY if NOT contenteditable or not actively editing
                    if (!selectedElement.isContentEditable || document.activeElement !== selectedElement) {
                       e.preventDefault();
                    }
                   clientX = e.clientX;
                   clientY = e.clientY;
               }

               // Calculate offset relative to the element's current top/left style
               dragOffsetX = clientX - screenRect.left - (parseFloat(selectedElement.style.left) || 0);
               dragOffsetY = clientY - screenRect.top - (parseFloat(selectedElement.style.top) || 0);


               document.addEventListener('mousemove', dragMove);
               document.addEventListener('mouseup', stopDrag);
               document.addEventListener('touchmove', dragMove, { passive: false });
               document.addEventListener('touchend', stopDrag);
           }

           function dragMove(e) {
               if (!isDraggingElement || !selectedElement || !appDesignScreen) return;
               e.preventDefault(); // Prevent scrolling during drag

               const screenRect = appDesignScreen.getBoundingClientRect();
               let clientX, clientY;

               if (e.type === 'touchmove') {
                   if (e.touches.length !== 1) return;
                   clientX = e.touches[0].clientX;
                   clientY = e.touches[0].clientY;
               } else {
                   clientX = e.clientX;
                   clientY = e.clientY;
               }

               let newX = clientX - screenRect.left - dragOffsetX;
               let newY = clientY - screenRect.top - dragOffsetY;

               const screenWidth = appDesignScreen.clientWidth;
               const screenHeight = appDesignScreen.clientHeight;
               const elementWidth = selectedElement.offsetWidth;
               const elementHeight = selectedElement.offsetHeight;

               newX = Math.max(0, Math.min(newX, screenWidth - elementWidth));
               newY = Math.max(0, Math.min(newY, screenHeight - elementHeight));

               selectedElement.style.left = `${newX}px`;
               selectedElement.style.top = `${newY}px`;
           }

           function stopDrag(e) {
               if (!isDraggingElement || !selectedElement) return;
               selectedElement.style.zIndex = ''; // Reset z-index
               isDraggingElement = false;
               selectedElement.classList.remove('dragging');
               // Keep it selected after dragging
               // selectElement(selectedElement); // Already selected


               document.removeEventListener('mousemove', dragMove);
               document.removeEventListener('mouseup', stopDrag);
               document.removeEventListener('touchmove', dragMove);
               document.removeEventListener('touchend', stopDrag);

               saveCurrentPageState(); // Save position after drag ends
           }



          // --- Add Element Function ---
         function addElement(type, content = '') {
             if (!appDesignScreen) return;
             const placeholder = appDesignScreen.querySelector('p:not(.app-element)');
             if (placeholder) placeholder.remove();

             let element;
             const elementId = `el-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

             if (type === 'text') {
                 element = document.createElement('div');
                 element.className = 'app-element text-element font-noto-sans-kr'; // Add default font class
                 element.textContent = '텍스트 상자';
                 element.setAttribute('contenteditable', 'true');
                  element.style.fontFamily = "'Noto Sans KR', sans-serif"; // Default font style
                  element.addEventListener('input', saveCurrentPageState);
                  element.addEventListener('blur', saveCurrentPageState);
             } else if (type === 'emoji') {
                 element = document.createElement('div');
                 element.className = 'app-element emoji-element';
                 element.textContent = content || '😀';
                 element.style.fontSize = '24px';
             } else if (type === 'button') {
                 element = document.createElement('button');
                 element.className = 'app-element button-element';
                 element.textContent = '버튼';
                 element.style.width = 'auto';
                 element.style.height = 'auto';
                 element.style.backgroundColor = '#3b82f6'; // Default color
                 element.style.color = '#ffffff'; // Default text color
             } else if (type === 'image') {
                 element = document.createElement('div');
                 element.className = 'app-element image-element';
                 const img = document.createElement('img');
                 img.src = content; // content is the dataURL
                 img.alt = 'Uploaded Image';
                 img.style.pointerEvents = 'none'; // Prevent img interference
                 element.appendChild(img);
                  element.style.width = '100px'; // Default image size
                  element.style.height = 'auto';
             }


             if (element) {
                 element.dataset.id = elementId;
                 element.dataset.type = type;
                  const existingElements = appDesignScreen.querySelectorAll('.app-element').length;
                  const initialLeft = 50 + (existingElements * 10) % 150;
                  const initialTop = 50 + (existingElements * 40) % (appDesignScreen.clientHeight - 100);
                 element.style.left = `${initialLeft}px`;
                 element.style.top = `${initialTop}px`;

                 makeElementDraggable(element);
                 element.addEventListener('mousedown', (e) => {
                     e.stopPropagation();
                      if (!e.target.classList.contains('resize-handle')) {
                           selectElement(element);
                      }
                 });
                  element.addEventListener('touchstart', (e) => {
                      e.stopPropagation();
                       if (!e.target.classList.contains('resize-handle')) {
                           selectElement(element);
                       }
                  }, { passive: true }); // Make selection passive

                 appDesignScreen.appendChild(element);
                 selectElement(element); // Select the newly added element
                 saveCurrentPageState(); // Save after adding
             }
         }



          // --- Initial page render ---
         if (appDesignScreen) renderPage(0); // Check if appDesignScreen exists

        // --- '미닫이문' 탭 스크립트 끝 ---

        // --- '어둠' 탭 스크립트 (신규) ---
        const openPickerBtn = document.getElementById('open-reflection-emoji-picker-btn');
        const reflectionModal = document.getElementById('reflection-emoji-picker-modal-new');
        const reflectionModalContent = document.getElementById('reflection-emoji-picker-content-new');
        const closeReflectionModalBtn = document.getElementById('close-reflection-emoji-picker-new');
        const sentenceBox = document.getElementById('reflection-emoji-sentence-box');
        const sentenceBoxPlaceholder = document.querySelector('#reflection-emoji-sentence-box .placeholder');
        const sentenceText = document.getElementById('reflection-emoji-sentence-text');
        const reflectionResetBtn = document.getElementById('reset-reflection-sentence-btn'); // <-- 변수명 수정 확인

        // 성찰 관련 이모지 리스트
        const reflectionEmojis = [
            '😀', '😂', '😊', '😍', '🤔', '😢', '😠', '😮', '🎉', '💖', '👍', '👎',
            '👋', '🙏', '👀', '👂', '👃', '👄', '🧠', '👤', '👥', '💬', '✏️', '🔒',
            '🔑', '💡', '🔍', '⚙️', '📞', '⏰', '⭐', '❤️', '💔', '💯', '✅', '❌',
            '❓', '❗', '➡️', '⬅️', '⬆️', '⬇️', '➕', '➖', '🏠', '🏫', '🏢', '🌍'
        ];

        // 새 이모지 피커 모달 채우기
        function populateReflectionEmojiPicker() {
            if (!reflectionModalContent) return;
            // Clear existing emojis except close button before repopulating
             const closeButton = reflectionModalContent.querySelector('#close-reflection-emoji-picker-new');
             if (closeButton) {
                 // Keep the close button, remove only emojis
                 const existingEmojis = reflectionModalContent.querySelectorAll('button:not(#close-reflection-emoji-picker-new)');
                 existingEmojis.forEach(btn => btn.remove());
             } else {
                 // If no close button exists (should not happen based on HTML), clear everything
                 reflectionModalContent.innerHTML = '';
             }


            // close 버튼 다음부터 이모지 추가
            reflectionEmojis.forEach(emoji => {
                const btn = document.createElement('button');
                btn.textContent = emoji;
                btn.dataset.emoji = emoji;
                btn.addEventListener('click', () => {
                   addEmojiToSentence(emoji);
                   // Close the modal after selection (optional)
                   if (reflectionModal) reflectionModal.classList.remove('visible');
                });
                reflectionModalContent.appendChild(btn);
            });
        }

        // 문장 상자에 이모지 추가
        function addEmojiToSentence(emoji) {
            if (!sentenceBox) return;
            // 플레이스홀더 숨기기
            if (sentenceBoxPlaceholder) sentenceBoxPlaceholder.classList.add('hidden');

            const emojiSpan = document.createElement('span');
            emojiSpan.className = 'selected-reflection-emoji';
            emojiSpan.textContent = emoji;
            // 클릭 시 자신을 삭제하는 기능 추가
            emojiSpan.addEventListener('click', () => {
                emojiSpan.remove();
                checkSentenceBoxPlaceholder(); // 이모지 삭제 후 플레이스홀더 체크
            });
            sentenceBox.appendChild(emojiSpan);
        }

        // 문장 상자가 비었는지 확인하고 플레이스홀더 표시/숨김
        function checkSentenceBoxPlaceholder() {
            if (sentenceBox && sentenceBoxPlaceholder) {
                const emojiCount = sentenceBox.querySelectorAll('.selected-reflection-emoji').length;
                sentenceBoxPlaceholder.classList.toggle('hidden', emojiCount > 0);
            }
        }

        // 새 모달 열기/닫기
        if (openPickerBtn) {
            openPickerBtn.addEventListener('click', () => {
                if (reflectionModal) reflectionModal.classList.add('visible');
            });
        }
        if (closeReflectionModalBtn) {
            closeReflectionModalBtn.addEventListener('click', () => {
                if (reflectionModal) reflectionModal.classList.remove('visible');
            });
        }
        if (reflectionModal) {
            reflectionModal.addEventListener('click', (e) => {
                if (e.target === reflectionModal) {
                    reflectionModal.classList.remove('visible');
                }
            });
        }

        // 초기화 버튼
        if (reflectionResetBtn) { // <-- 변수명 수정 확인
            reflectionResetBtn.addEventListener('click', () => { // <-- 변수명 수정 확인
                if (sentenceBox) {
                     // Remove only emoji spans, keep placeholder if it exists
                     sentenceBox.querySelectorAll('.selected-reflection-emoji').forEach(span => span.remove());
                 }
                checkSentenceBoxPlaceholder(); // Show placeholder if empty
                if (sentenceText) sentenceText.value = ''; // 텍스트 삭제
            });
        }

        // 이모지 피커 실행 (최초 1회만 실행)
        let reflectionPickerInitialized = false;
        if (!reflectionPickerInitialized) {
            populateReflectionEmojiPicker();
            reflectionPickerInitialized = true;
        }

        // --- '어둠' 탭 스크립트 끝 ---

        // --- '열매' 탭 스크립트 (신규) ---
        const essayContentArea = document.getElementById('essay-content-area');
        const essayTitle = document.getElementById('essay-title');
        const essayName = document.getElementById('essay-name');
        const essayIntro = document.getElementById('essay-intro');
        const essayBody = document.getElementById('essay-body');
        const essayConclusion = document.getElementById('essay-conclusion');
        const downloadTxtBtn = document.getElementById('download-txt-btn');
        const downloadJpgBtn = document.getElementById('download-jpg-btn');
        const copyTextBtn = document.getElementById('copy-text-btn');
        const copySuccessMsg = document.getElementById('copy-success-msg');

        // TXT 다운로드
        if (downloadTxtBtn) {
            downloadTxtBtn.addEventListener('click', () => {
                 const title = essayTitle ? essayTitle.value.trim() : '제목 없음';
                 const name = essayName ? essayName.value.trim() : '이름 없음';
                 const intro = essayIntro ? essayIntro.value.trim() : '';
                 const body = essayBody ? essayBody.value.trim() : '';
                 const conclusion = essayConclusion ? essayConclusion.value.trim() : '';

                 const content = `제목: ${title}\n이름: ${name}\n\n[서론]\n${intro}\n\n[본론]\n${body}\n\n[결론]\n${conclusion}`;
                 const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(blob);
                 link.download = `${title || '논술'}_${name || '학생'}.txt`; // 파일명 설정
                 link.click();
                 URL.revokeObjectURL(link.href);
            });
        }

        // JPG 다운로드
        if (downloadJpgBtn && essayContentArea && typeof html2canvas !== 'undefined') {
            downloadJpgBtn.addEventListener('click', () => {
                html2canvas(essayContentArea, {
                    scale: 2, // 해상도 높이기
                    useCORS: true // 외부 폰트 사용 시 필요할 수 있음
                }).then(canvas => {
                     const title = essayTitle ? essayTitle.value.trim() : '제목 없음';
                     const name = essayName ? essayName.value.trim() : '이름 없음';
                     const link = document.createElement('a');
                     link.download = `${title || '논술'}_${name || '학생'}.jpg`;
                     link.href = canvas.toDataURL('image/jpeg', 0.9); // JPEG 형식, 품질 0.9
                     link.click();
                }).catch(err => {
                     console.error('JPG 생성 오류:', err);
                     // 사용자에게 오류 메시지 표시 (alert 대신 다른 방법 권장)
                     // showCustomAlert('이미지 생성 중 오류가 발생했습니다.');
                 });
            });
        } else if (downloadJpgBtn && typeof html2canvas === 'undefined') {
             console.error('html2canvas 라이브러리가 로드되지 않았습니다.');
             // 버튼 비활성화 또는 사용자 알림
             downloadJpgBtn.disabled = true;
             downloadJpgBtn.title = '이미지 생성 라이브러리 로딩 실패';
         }


        // 텍스트 복사
        if (copyTextBtn) {
            copyTextBtn.addEventListener('click', () => {
                 const title = essayTitle ? essayTitle.value.trim() : '';
                 const name = essayName ? essayName.value.trim() : '';
                 const intro = essayIntro ? essayIntro.value.trim() : '';
                 const body = essayBody ? essayBody.value.trim() : '';
                 const conclusion = essayConclusion ? essayConclusion.value.trim() : '';

                 const contentToCopy = `제목: ${title}\n이름: ${name}\n\n[서론]\n${intro}\n\n[본론]\n${body}\n\n[결론]\n${conclusion}`;

                 // 임시 textarea 사용 (execCommand 방식)
                 const textarea = document.createElement('textarea');
                 textarea.value = contentToCopy;
                 document.body.appendChild(textarea);
                 textarea.select();
                 try {
                     const successful = document.execCommand('copy');
                     if (successful && copySuccessMsg) {
                         copySuccessMsg.classList.remove('hidden');
                         setTimeout(() => {
                             copySuccessMsg.classList.add('hidden');
                         }, 2000); // 2초 후 메시지 숨김
                     } else {
                         console.error('텍스트 복사 실패 (execCommand)');
                          // 사용자에게 오류 알림 (alert 대신 다른 방법 권장)
                         // showCustomAlert('텍스트 복사에 실패했습니다.');
                     }
                 } catch (err) {
                     console.error('텍스트 복사 중 오류 발생:', err);
                      // 사용자에게 오류 알림 (alert 대신 다른 방법 권장)
                     // showCustomAlert('텍스트 복사 중 오류가 발생했습니다.');
                 }
                 document.body.removeChild(textarea);

            });
        }

        // --- '열매' 탭 스크립트 끝 ---


        // Lucide 아이콘 렌더링 - Ensure icons are rendered after dynamic content is added
         function renderIcons() {
             try { // Wrap in try-catch in case lucide fails
                lucide.createIcons();
             } catch (error) {
                 console.error("Lucide icon rendering failed:", error);
             }
         }
         // renderIcons(); // Call only once on DOMContentLoaded

        // Call setup for sketch canvas initially if it's the default view
        // setActiveTab will call this when 'door' tab is activated.

         // Initial setup call after all functions are defined
         // --- Language Toggle, Dark Mode, and Backup/Restore Functionality ---

         // Translations object
         const translations = {
             kor: {
                 appTitle: '홍당뮤',
                 appSubtitle: 'With. 디자인씽킹',
                 welcome: '홍당뮤에 온 걸 환영해!',
                 tagline: '홍익인간 = 당신의 생각 + 뮤지컬',
                 manual: '설명서 📖',
                 start: '시작하기!',
                 home: '홈',
                 light: '빛',
                 mirror: '거울',
                 window: '창문',
                 door: '문',
                 darkness: '어둠',
                 fruit: '열매',
                 dictionary: '사전',
                 // Tab titles
                 lightTitle: '1단계: 생각의 시작 (빛) - 반짝! 영감 얻기',
                 mirrorTitle: '2단계: 나를 비추는 (거울) - 끄덕! 공감하고 문제 정의하기',
                 windowTitle: '3단계: 세상을 보는 (창문) - 상상! 아이디어 펼치기',
                 doorTitle: '4단계: 세상으로 나아가는 (미닫이문) - 뚝딱! 만들어보기',
                 darknessTitle: '5단계: 생각을 정리하는 (어둠) - 성장! 배움 확장하기',
                 fruitTitle: '열매맺기 - 논술 작성 및 공유하기',
                 // Manual modal
                 manualTitle: '홍당뮤 설명서',
                 manualLight: '1. 빛 (영감 얻기)',
                 manualLightDesc: '뮤지컬을 보고 떠오른 생각이나 느낌, 질문을 자유롭게 기록하며 생각의 빛을 켜요.',
                 manualMirror: '2. 거울 (공감하고 정의하기)',
                 manualMirrorDesc: '뮤지컬 속 인물의 마음에 공감하며, 나와 우리 주변의 문제를 찾아 이름을 붙여줘요.',
                 manualWindow: '3. 창문 (아이디어 떠올리기)',
                 manualWindowDesc: '발견한 문제를 어떻게 해결할지, 세상을 향한 창문을 열고 상상의 나래를 펼쳐요.',
                 manualDoor: '4. 미닫이문 (만들고 실천하기)',
                 manualDoorDesc: '우리의 아이디어를 눈에 보이는 형태로 만들고 실험해봐요.',
                 manualDarkness: '5. 어둠 (성찰하기)',
                 manualDarknessDesc: '어둠은 새로운 빛을 기다리는 쉼의 시간입니다. 배운 내용을 정리해봐요.',
                 manualFruit: '+ 열매맺기 (논술작성)',
                 manualFruitDesc: '모든 과정을 돌아보며 배운 점을 논리적인 글로 작성하여 성장의 열매를 맺어요.',
                 manualDictionary: '+ 생각사전',
                 manualDictionaryDesc: '프로젝트를 하며 알게 된 새로운 단어, 개념을 기록하고 공유하는 공간이에요.',
                 manualReport: '+ 보고서',
                 manualReportDesc: '작성한 내용을 한눈에 확인하고, PDF, PNG, TXT 등 다양한 형식으로 내보내요.',
                 manualReferences: '📚 출처 및 참고 문헌',
                 referenceTheory: '• 거울, 창, 슬라이딩 유리문 이론',
                 referenceCitation1: 'Rudine Sims Bishop (1990). "Mirrors, Windows, and Sliding Glass Doors." Perspectives: Choosing and Using Books for the Classroom, 6 (3).',
                 referenceDesc1: '- 어린이 문학을 통해 타인과 세계를 이해하는 독서의 비유적 개념으로, 본 웹앱의 철학적 모티브로 참고하였습니다.',
                 referenceDesign: '• 디자인 씽킹 방법론',
                 referenceCitation2: 'Stanford d.school (2018). "Design Thinking Bootleg." Stanford University Institute of Design.',
                 referenceDesc2: '- 공감·정의·아이디어·프로토타입·테스트의 순환적 과정을 제시하는 교육용 자료로, 프로젝트 설계와 단계 구성에 인용하였습니다.',
                 developerTitle: '👨‍💻 개발자',
                 developerName: '교육뮤지컬 꿈꾸는 치수쌤',
                 developerDesc1: '교육뮤지컬을 고민하고, 창작하고, 실천합니다.',
                 developerDesc2: '초등학교 학생들과 함께 꿈꾸는 교육뮤지컬 이야기를 기록합니다.',
                 developerDesc3: '[세상에서 가장 쉬운 뮤지컬 수업], [뮤지컬 창작노트]의 저자입니다.',
                 developerDesc4: '따뜻한 디지털 활용 교육에도 관심이 많습니다.',
                 footer: 'created by. 교육뮤지컬 꿈꾸는 치수쌤'
             },
             eng: {
                 appTitle: 'Hong-Dang-Mu',
                 appSubtitle: 'With. Design Thinking',
                 welcome: 'Welcome to Hong-Dang-Mu!',
                 tagline: 'Hongik Ingan = Your Thoughts + Musical',
                 manual: 'Manual 📖',
                 start: 'Start!',
                 home: 'Home',
                 light: 'Light',
                 mirror: 'Mirror',
                 window: 'Window',
                 door: 'Door',
                 darkness: 'Reflection',
                 fruit: 'Harvest',
                 dictionary: 'Dict',
                 report: 'Report',
                 // Tab titles
                 lightTitle: 'Step 1: Light - Spark of Inspiration',
                 mirrorTitle: 'Step 2: Mirror - Empathy & Problem Definition',
                 windowTitle: 'Step 3: Window - Ideation & Imagination',
                 doorTitle: 'Step 4: Sliding Door - Prototyping & Making',
                 darknessTitle: 'Step 5: Reflection - Growth & Learning',
                 fruitTitle: 'Harvest - Essay Writing & Sharing',
                 // Manual modal
                 manualTitle: 'Hong-Dang-Mu Manual',
                 manualLight: '1. Light (Inspiration)',
                 manualLightDesc: 'Record memorable scenes, feelings, and questions from the musical.',
                 manualMirror: '2. Mirror (Empathy & Definition)',
                 manualMirrorDesc: 'Empathize with characters and discover problems around you.',
                 manualWindow: '3. Window (Ideation)',
                 manualWindowDesc: 'Imagine creative ideas to solve the problems.',
                 manualDoor: '4. Sliding Door (Making & Action)',
                 manualDoorDesc: 'Create visible prototypes and experiment with your ideas.',
                 manualDarkness: '5. Reflection (Contemplation)',
                 manualDarknessDesc: 'Reflect on the entire process and organize your learning.',
                 manualFruit: '+ Harvest (Essay Writing)',
                 manualFruitDesc: 'Organize your entire project experience into an essay.',
                 manualDictionary: '+ Thought Dictionary',
                 manualDictionaryDesc: 'Record and share new words and concepts you learned.',
                 manualReport: '+ Report',
                 manualReportDesc: 'View all your work at a glance and export in PDF, PNG, TXT formats.',
                 manualReferences: '📚 References & Bibliography',
                 referenceTheory: '• Mirrors, Windows, and Sliding Glass Doors Theory',
                 referenceCitation1: 'Rudine Sims Bishop (1990). "Mirrors, Windows, and Sliding Glass Doors." Perspectives: Choosing and Using Books for the Classroom, 6 (3).',
                 referenceDesc1: '- Referenced as a metaphorical concept for understanding others and the world through children\'s literature, serving as the philosophical motif of this web app.',
                 referenceDesign: '• Design Thinking Methodology',
                 referenceCitation2: 'Stanford d.school (2018). "Design Thinking Bootleg." Stanford University Institute of Design.',
                 referenceDesc2: '- Educational resource presenting the cyclical process of empathy, definition, ideation, prototyping, and testing, cited in project design and stage structure.',
                 developerTitle: '👨‍💻 Developer',
                 developerName: 'Teacher Chisu who dreams of educational musicals',
                 developerDesc1: 'Contemplates, creates, and practices educational musicals.',
                 developerDesc2: 'Records stories of educational musicals dreamed together with elementary school students.',
                 developerDesc3: 'Author of "The Easiest Musical Class in the World" and "Musical Creation Notes".',
                 developerDesc4: 'Deeply interested in warm digital educational practices.',
                 footer: 'created by. Teacher Chisu who dreams of educational musicals'
             }
         };

         let currentLang = 'kor';

         // Language Toggle
         function setLanguage(lang) {
             currentLang = lang;
             localStorage.setItem('language', lang);

             // Apply translations
             const t = translations[lang];

             // Header
             const title = document.querySelector('header h1');
             if (title) title.textContent = t.appTitle;

             const subtitle = document.querySelector('header p.grandiflora');
             if (subtitle) subtitle.textContent = t.appSubtitle;

             // Home page
             const welcomeEl = document.querySelector('#home-page h2');
             if (welcomeEl) welcomeEl.textContent = t.welcome;

             const taglineEl = document.querySelector('#home-page p');
             if (taglineEl) taglineEl.textContent = t.tagline;

             const manualBtn = document.getElementById('manual-button');
             if (manualBtn) manualBtn.textContent = t.manual;

             const startBtn = document.getElementById('start-from-modal-button');
             if (startBtn) startBtn.textContent = t.start;

             // Nav buttons (now only 6)
             const navButtons = document.querySelectorAll('.nav-button span');
             navButtons.forEach((span, idx) => {
                 const btnKey = ['home', 'light', 'mirror', 'window', 'door', 'darkness'][idx];
                 if (t[btnKey]) span.textContent = t[btnKey];
             });

             // Extra nav buttons on home page
             const extraNavButtons = document.querySelectorAll('.extra-nav-button');
             if (extraNavButtons.length >= 3) {
                 const fruitBtn = extraNavButtons[0];
                 const dictBtn = extraNavButtons[1];
                 const reportBtn = extraNavButtons[2];

                 if (fruitBtn) {
                     const icon = fruitBtn.querySelector('i');
                     fruitBtn.innerHTML = '';
                     if (icon) fruitBtn.appendChild(icon);
                     fruitBtn.appendChild(document.createTextNode(lang === 'kor' ? '열매맺기' : 'Harvest'));
                 }
                 if (dictBtn) {
                     const icon = dictBtn.querySelector('i');
                     dictBtn.innerHTML = '';
                     if (icon) dictBtn.appendChild(icon);
                     dictBtn.appendChild(document.createTextNode(lang === 'kor' ? '생각사전' : 'Dictionary'));
                 }
                 if (reportBtn) {
                     const icon = reportBtn.querySelector('i');
                     reportBtn.innerHTML = '';
                     if (icon) reportBtn.appendChild(icon);
                     reportBtn.appendChild(document.createTextNode(lang === 'kor' ? '보고서' : 'Report'));
                 }
             }

             // Tab titles in main content
             const lightTitle = document.querySelector('#content-light h2');
             if (lightTitle) lightTitle.textContent = t.lightTitle;

             const mirrorTitle = document.querySelector('#content-mirror h2');
             if (mirrorTitle) mirrorTitle.textContent = t.mirrorTitle;

             const windowTitle = document.querySelector('#content-window h2');
             if (windowTitle) windowTitle.textContent = t.windowTitle;

             const doorTitle = document.querySelector('#content-door h2');
             if (doorTitle) doorTitle.textContent = t.doorTitle;

             const darknessTitle = document.querySelector('#content-darkness h2');
             if (darknessTitle) darknessTitle.textContent = t.darknessTitle;

             const fruitTitle = document.querySelector('#content-fruit h2');
             if (fruitTitle) fruitTitle.textContent = t.fruitTitle;

             // Manual modal
             const manualTitle = document.querySelector('#manual-modal h2');
             if (manualTitle) manualTitle.textContent = t.manualTitle;

             const manualItems = [
                 { selector: '#manual-modal .space-y-5 > div:nth-child(1) h3', key: 'manualLight' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(1) p', key: 'manualLightDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(2) h3', key: 'manualMirror' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(2) p', key: 'manualMirrorDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(3) h3', key: 'manualWindow' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(3) p', key: 'manualWindowDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(4) h3', key: 'manualDoor' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(4) p', key: 'manualDoorDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(5) h3', key: 'manualDarkness' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(5) p', key: 'manualDarknessDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(6) h3', key: 'manualFruit' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(6) p', key: 'manualFruitDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(7) h3', key: 'manualDictionary' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(7) p', key: 'manualDictionaryDesc' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(8) h3', key: 'manualReport' },
                 { selector: '#manual-modal .space-y-5 > div:nth-child(8) p', key: 'manualReportDesc' }
             ];

             manualItems.forEach(item => {
                 const el = document.querySelector(item.selector);
                 if (el && t[item.key]) el.textContent = t[item.key];
             });

             const referencesTitle = document.querySelector('#manual-modal .mt-6.pt-6 h3');
             if (referencesTitle) referencesTitle.textContent = t.manualReferences;

             // References section
             const refTheory = document.querySelector('#manual-modal .mt-6.pt-6 .space-y-3 > div:nth-child(1) p:nth-child(1)');
             if (refTheory) refTheory.textContent = t.referenceTheory;

             const refCitation1 = document.querySelector('#manual-modal .mt-6.pt-6 .space-y-3 > div:nth-child(1) p:nth-child(2)');
             if (refCitation1) refCitation1.textContent = t.referenceCitation1;

             const refDesc1 = document.querySelector('#manual-modal .mt-6.pt-6 .space-y-3 > div:nth-child(1) p:nth-child(3)');
             if (refDesc1) refDesc1.textContent = t.referenceDesc1;

             const refDesign = document.querySelector('#manual-modal .mt-6.pt-6 .space-y-3 > div:nth-child(2) p:nth-child(1)');
             if (refDesign) refDesign.textContent = t.referenceDesign;

             const refCitation2 = document.querySelector('#manual-modal .mt-6.pt-6 .space-y-3 > div:nth-child(2) p:nth-child(2)');
             if (refCitation2) refCitation2.textContent = t.referenceCitation2;

             const refDesc2 = document.querySelector('#manual-modal .mt-6.pt-6 .space-y-3 > div:nth-child(2) p:nth-child(3)');
             if (refDesc2) refDesc2.textContent = t.referenceDesc2;

             // Developer section
             const devTitle = document.querySelector('#manual-modal .mt-8.pt-6 h3');
             if (devTitle) devTitle.textContent = t.developerTitle;

             const devName = document.querySelector('#manual-modal .mt-8.pt-6 .bg-orange-50 p:nth-child(1)');
             if (devName) devName.textContent = t.developerName;

             const devDesc1 = document.querySelector('#manual-modal .mt-8.pt-6 .bg-orange-50 p:nth-child(2)');
             if (devDesc1) devDesc1.textContent = t.developerDesc1;

             const devDesc2 = document.querySelector('#manual-modal .mt-8.pt-6 .bg-orange-50 p:nth-child(3)');
             if (devDesc2) devDesc2.textContent = t.developerDesc2;

             const devDesc3 = document.querySelector('#manual-modal .mt-8.pt-6 .bg-orange-50 p:nth-child(4)');
             if (devDesc3) devDesc3.textContent = t.developerDesc3;

             const devDesc4 = document.querySelector('#manual-modal .mt-8.pt-6 .bg-orange-50 p:nth-child(5)');
             if (devDesc4) devDesc4.textContent = t.developerDesc4;

             // Footer
             const footerLink = document.querySelector('footer a');
             if (footerLink) footerLink.textContent = t.footer;
         }

         // Dark Mode Toggle
         function toggleDarkMode() {
             document.body.classList.toggle('dark-mode');
             const isDark = document.body.classList.contains('dark-mode');
             localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
         }

         // Backup - Save all form data to JSON
         function downloadBackup() {
             const data = {
                 version: '1.0',
                 timestamp: new Date().toISOString(),
                 language: currentLang,
                 darkMode: document.body.classList.contains('dark-mode'),
                 formData: {}
             };

             // Collect all input, textarea, and select values
             document.querySelectorAll('input[type="text"], input[type="number"], textarea, select').forEach(el => {
                 if (el.id && el.id !== 'backup-file-input' && el.id !== 'image-upload-input') {
                     data.formData[el.id] = el.value;
                 }
             });

             // Collect emoji selections
             const selectedEmoji = document.getElementById('selected-emoji');
             if (selectedEmoji) data.formData['selected-emoji'] = selectedEmoji.value;

             // Save app design pages data if exists
             if (typeof appPages !== 'undefined') { // Use appPages instead of appDesignPages
                 data.appDesignPages = appPages;
             }

             const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = `hongdangmu-backup-${new Date().toISOString().split('T')[0]}.json`;
             link.style.display = 'none';

             document.body.appendChild(link);
             link.click();

             setTimeout(() => {
                 document.body.removeChild(link);
                 URL.revokeObjectURL(url);
             }, 100);
         }

         // Restore from JSON backup
         function uploadBackup() {
             const fileInput = document.getElementById('backup-file-input');
             if (fileInput) fileInput.click();
         }

         function handleBackupFile(event) {
             const file = event.target.files[0];
             if (!file) return;

             const reader = new FileReader();
             reader.onload = (e) => {
                 try {
                     const data = JSON.parse(e.target.result);

                     // Restore language
                     if (data.language) {
                         setLanguage(data.language);
                     }

                     // Restore dark mode
                     if (data.darkMode) {
                         if (data.darkMode && !document.body.classList.contains('dark-mode')) {
                             toggleDarkMode();
                         } else if (!data.darkMode && document.body.classList.contains('dark-mode')) {
                             toggleDarkMode();
                         }
                     }

                     // Restore form data
                     if (data.formData) {
                         Object.keys(data.formData).forEach(id => {
                             const el = document.getElementById(id);
                             if (el) el.value = data.formData[id];
                         });
                     }

                     // Restore app design pages if exists
                     if (data.appDesignPages && typeof appPages !== 'undefined') {
                         appPages = data.appDesignPages;
                         if (typeof renderPage === 'function' && typeof currentPageIndex !== 'undefined') {
                             renderPage(currentPageIndex);
                         }
                     }

                     alert('백업이 성공적으로 복원되었습니다! / Backup restored successfully!');
                 } catch (error) {
                     alert('백업 파일을 읽는 중 오류가 발생했습니다. / Error reading backup file.');
                     console.error(error);
                 }
             };
             reader.readAsText(file);
             event.target.value = ''; // Reset file input
         }

         // Initialize controls
         document.getElementById('lang-toggle').addEventListener('click', () => {
             const newLang = currentLang === 'kor' ? 'eng' : 'kor';
             setLanguage(newLang);
         });
         document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);
         document.getElementById('backup-download').addEventListener('click', downloadBackup);
         document.getElementById('backup-upload').addEventListener('click', uploadBackup);
         document.getElementById('backup-file-input').addEventListener('change', handleBackupFile);

         // Load saved preferences
         const savedLang = localStorage.getItem('language');
         if (savedLang) setLanguage(savedLang);

         const savedDarkMode = localStorage.getItem('darkMode');
         if (savedDarkMode === 'enabled') {
             document.body.classList.add('dark-mode');
         }

         // --- End of new functionality ---

         // --- 보고서 기능 ---
         function updateReportData() {
             // 작성자 이름
             const reportAuthorName = document.getElementById('report-author-name');
             const reportAuthorDisplay = document.getElementById('report-author-display');
             if (reportAuthorDisplay && reportAuthorName) {
                 reportAuthorDisplay.textContent = reportAuthorName.value.trim() || '-';
             }

             // 1단계: 빛
             const cardStory = document.getElementById('card-story');
             const cardMusic = document.getElementById('card-music');
             const cardMovement = document.getElementById('card-movement');
             const cardStage = document.getElementById('card-stage');
             const selectedEmojiInput = document.getElementById('selected-emoji');
             const reviewText = document.getElementById('review-text');
             const questionList = document.getElementById('question-list');

             if (cardStory) document.getElementById('report-card-story').textContent = cardStory.value || '-';
             if (cardMusic) document.getElementById('report-card-music').textContent = cardMusic.value || '-';
             if (cardMovement) document.getElementById('report-card-movement').textContent = cardMovement.value || '-';
             if (cardStage) document.getElementById('report-card-stage').textContent = cardStage.value || '-';
             if (selectedEmojiInput) document.getElementById('report-emoji').textContent = selectedEmojiInput.value || '';
             if (reviewText) document.getElementById('report-review').textContent = reviewText.value || '-';

             const reportQuestions = document.getElementById('report-questions');
             if (reportQuestions && questionList) {
                 reportQuestions.innerHTML = '';
                 const questions = questionList.querySelectorAll('li:not(#question-placeholder)');
                 questions.forEach(q => {
                     const text = q.querySelector('span')?.textContent || q.textContent.replace('삭제', '').trim();
                     if (text) {
                         const li = document.createElement('li');
                         li.textContent = text;
                         reportQuestions.appendChild(li);
                     }
                 });
                 if (reportQuestions.children.length === 0) {
                     reportQuestions.innerHTML = '<li>작성된 질문이 없습니다.</li>';
                 }
             }

             // 2단계: 거울
             const characterName = document.getElementById('pov-character-name');
             const situation = document.getElementById('empathy-situation');
             const speech = document.getElementById('empathy-speech');
             const action = document.getElementById('empathy-action');
             const povNeed = document.getElementById('pov-need');
             const povReason = document.getElementById('pov-reason');

             if (characterName) document.getElementById('report-character-name').textContent = characterName.value || '-';
             if (situation) document.getElementById('report-situation').textContent = situation.value || '-';
             if (speech) document.getElementById('report-speech').textContent = speech.value || '-';
             if (action) document.getElementById('report-action').textContent = action.value || '-';
             if (povNeed) document.getElementById('report-pov-need').textContent = povNeed.value || '-';
             if (povReason) document.getElementById('report-pov-reason').textContent = povReason.value || '-';

             // 3단계: 창문
             const hmwUser = document.getElementById('window-hmw-user');
             const hmwNeed = document.getElementById('window-hmw-need');
             const hmwText = `우리는 어떻게 하면 ${hmwUser?.value || '[사용자]'}이/가 ${hmwNeed?.value || '[원하는 것]'}할 수 있을까?`;
             document.getElementById('report-hmw').textContent = hmwText;

             const ideaBubbles = document.querySelectorAll('#idea-bubble-list-container .post-it-bubble');
             const reportIdeas = document.getElementById('report-ideas');
             if (reportIdeas) {
                 reportIdeas.innerHTML = '';
                 ideaBubbles.forEach(bubble => {
                     const text = bubble.querySelector('.post-it-text-bubble')?.value;
                     if (text) {
                         const li = document.createElement('li');
                         li.textContent = text;
                         reportIdeas.appendChild(li);
                     }
                 });
                 if (reportIdeas.children.length === 0) {
                     reportIdeas.innerHTML = '<li>작성된 아이디어가 없습니다.</li>';
                 }
             }

             const finalIdea = document.querySelector('#window-content-idea textarea[rows="5"]');
             if (finalIdea) document.getElementById('report-final-idea').textContent = finalIdea.value || '-';

             // 4단계: 미닫이문
             const prototypeTypes = {
                 'sketch': '스케치',
                 'photo': '사진',
                 'improv': '즉흥극',
                 'story': '이야기',
                 'video': '영상',
                 'appdesign': '앱 디자인'
             };

             // 작성된 프로토타입 유형 수집
             const createdTypes = [];

             // 각 유형별 데이터 수집 및 표시
             // 스케치 - 캔버스에 실제 그려진 내용이 있는지 확인
             const canvas = document.getElementById('sketch-canvas');
             const sketchDesc = document.querySelector('#prototype-content-sketch textarea');
             let hasSketchContent = false;

             if (canvas) {
                 const ctx = canvas.getContext('2d');
                 if (ctx) {
                     // 캔버스에 그려진 내용이 있는지 확인 (빈 캔버스가 아닌지)
                     const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                     const data = imageData.data;
                     // 투명하지 않은 픽셀이 하나라도 있는지 확인
                     for (let i = 3; i < data.length; i += 4) {
                         if (data[i] !== 0) { // 알파 채널이 0이 아니면 그려진 것
                             hasSketchContent = true;
                             break;
                         }
                     }
                 }
             }

             if (hasSketchContent || (sketchDesc && sketchDesc.value.trim())) {
                 createdTypes.push('스케치');
                 const section = document.getElementById('report-sketch-section');
                 const container = document.getElementById('report-sketch-canvas-container');
                 if (section && container) {
                     section.classList.remove('hidden');
                     container.innerHTML = '';
                     if (hasSketchContent) {
                         const img = document.createElement('img');
                         img.src = canvas.toDataURL('image/png');
                         img.className = 'max-w-full rounded border';
                         container.appendChild(img);
                     }
                     const descEl = document.getElementById('report-sketch-description');
                     if (descEl) {
                         descEl.textContent = (sketchDesc && sketchDesc.value.trim()) ? sketchDesc.value : (hasSketchContent ? '(설명 없음)' : '-');
                     }
                 }
             } else {
                 const section = document.getElementById('report-sketch-section');
                 if (section) section.classList.add('hidden');
             }

             // 사진
             const photos = document.querySelectorAll('#photo-preview-container img');
             if (photos.length > 0) {
                 createdTypes.push('사진');
                 const section = document.getElementById('report-photo-section');
                 const container = document.getElementById('report-photos-container');
                 if (section && container) {
                     section.classList.remove('hidden');
                     container.innerHTML = '';
                     photos.forEach(img => {
                         const clone = img.cloneNode(true);
                         clone.className = 'rounded border';
                         container.appendChild(clone);
                     });
                 }
             } else {
                 const section = document.getElementById('report-photo-section');
                 if (section) section.classList.add('hidden');
             }

             // 즉흥극
             const improvInputs = document.querySelectorAll('#prototype-content-improv input, #prototype-content-improv textarea');
             const hasImprovContent = Array.from(improvInputs).some(input => input.value.trim());
             if (hasImprovContent) {
                 createdTypes.push('즉흥극');
                 const section = document.getElementById('report-improv-section');
                 const improvContent = document.getElementById('report-improv-content');
                 if (section && improvContent && improvInputs.length > 0) {
                     section.classList.remove('hidden');
                     const title = improvInputs[0].value || '-';
                     const time = improvInputs[1].value || '-';
                     const place = improvInputs[2].value || '-';
                     const chars = improvInputs[3].value || '-';
                     const begin = improvInputs[4].value || '-';
                     const middle = improvInputs[5].value || '-';
                     const end = improvInputs[6].value || '-';
                     improvContent.innerHTML = `
                         <p><strong>작품명:</strong> ${title}</p>
                         <p><strong>배경:</strong> ${time} / ${place}</p>
                         <p><strong>등장인물:</strong> ${chars}</p>
                         <p><strong>처음:</strong> ${begin}</p>
                         <p><strong>중간:</strong> ${middle}</p>
                         <p><strong>끝:</strong> ${end}</p>
                     `;
                 }
             } else {
                 const section = document.getElementById('report-improv-section');
                 if (section) section.classList.add('hidden');
             }

             // 이야기
             const storyTextarea = document.querySelector('#prototype-content-story textarea');
             if (storyTextarea && storyTextarea.value.trim()) {
                 createdTypes.push('이야기');
                 const section = document.getElementById('report-story-section');
                 if (section) {
                     section.classList.remove('hidden');
                     document.getElementById('report-story-content').textContent = storyTextarea.value || '-';
                 }
             } else {
                 const section = document.getElementById('report-story-section');
                 if (section) section.classList.add('hidden');
             }

             // 영상
             const videos = document.querySelectorAll('#video-preview-container video');
             if (videos.length > 0) {
                 createdTypes.push('영상');
                 const section = document.getElementById('report-video-section');
                 const container = document.getElementById('report-videos-container');
                 if (section && container) {
                     section.classList.remove('hidden');
                     container.innerHTML = '';
                     videos.forEach(video => {
                         const clone = video.cloneNode(true);
                         clone.className = 'rounded border w-full';
                         clone.controls = true;
                         container.appendChild(clone);
                     });
                 }
             } else {
                 const section = document.getElementById('report-video-section');
                 if (section) section.classList.add('hidden');
             }

             // 앱 디자인
             if (typeof appPages !== 'undefined' && appPages.length > 0 && appPages.some(page => page.length > 0)) {
                 createdTypes.push('앱 디자인');
                 const section = document.getElementById('report-appdesign-section');
                 const pagesContainer = document.getElementById('report-appdesign-pages');
                 if (section && pagesContainer) {
                     section.classList.remove('hidden');
                     pagesContainer.innerHTML = '';

                     // 페이지 수만 표시 (이미지 없이)
                     const totalPages = appPages.filter(page => page.length > 0).length;
                     const pageInfo = document.createElement('p');
                     pageInfo.className = 'text-gray-700';
                     pageInfo.textContent = `총 ${totalPages}개 페이지 생성됨`;
                     pagesContainer.appendChild(pageInfo);
                 }
             } else {
                 const section = document.getElementById('report-appdesign-section');
                 if (section) section.classList.add('hidden');
             }

             // 프로토타입 유형 표시
             const prototypeTypeText = createdTypes.length > 0 ? createdTypes.join(', ') : '-';
             document.getElementById('report-prototype-type').textContent = prototypeTypeText;

             const feedbackPlus = document.getElementById('feedback-plus');
             const feedbackDelta = document.getElementById('feedback-delta');
             const feedbackQuestion = document.getElementById('feedback-question');
             const feedbackIdea = document.getElementById('feedback-idea');

             if (feedbackPlus) document.getElementById('report-feedback-plus').textContent = feedbackPlus.value || '-';
             if (feedbackDelta) document.getElementById('report-feedback-delta').textContent = feedbackDelta.value || '-';
             if (feedbackQuestion) document.getElementById('report-feedback-question').textContent = feedbackQuestion.value || '-';
             if (feedbackIdea) document.getElementById('report-feedback-idea').textContent = feedbackIdea.value || '-';

             // 5단계: 어둠
             const learned = document.getElementById('reflection-learned');
             const felt = document.getElementById('reflection-felt');
             const growth = document.getElementById('reflection-growth');

             if (learned) document.getElementById('report-learned').textContent = learned.value || '-';
             if (felt) document.getElementById('report-felt').textContent = felt.value || '-';
             if (growth) document.getElementById('report-growth').textContent = growth.value || '-';

             const reflectionEmojis = document.querySelectorAll('#reflection-emoji-sentence-box .selected-reflection-emoji');
             const emojiText = Array.from(reflectionEmojis).map(e => e.textContent).join(' ');
             document.getElementById('report-reflection-emojis').textContent = emojiText || '-';

             // 열매: 논술
             const essayTitle = document.getElementById('essay-title');
             const essayName = document.getElementById('essay-name');
             const essayIntro = document.getElementById('essay-intro');
             const essayBody = document.getElementById('essay-body');
             const essayConclusion = document.getElementById('essay-conclusion');

             if (essayTitle) document.getElementById('report-essay-title').textContent = essayTitle.value || '-';
             if (essayName) document.getElementById('report-essay-name').textContent = essayName.value || '-';
             if (essayIntro) document.getElementById('report-essay-intro').textContent = essayIntro.value || '-';
             if (essayBody) document.getElementById('report-essay-body').textContent = essayBody.value || '-';
             if (essayConclusion) document.getElementById('report-essay-conclusion').textContent = essayConclusion.value || '-';
         }

         function generateReportText() {
             const authorName = document.getElementById('report-author-name')?.value.trim() || '(작성자 미입력)';
             const sections = [
                 '='.repeat(60),
                 '홍당뮤 프로젝트 최종 보고서',
                 '='.repeat(60),
                 '',
                 `작성자: ${authorName}`,
                 '',
                 '■ 1단계: 빛 (영감)',
                 '─'.repeat(40),
                 `뮤지컬 조각 카드:`,
                 `  이야기: ${document.getElementById('report-card-story')?.textContent || '-'}`,
                 `  음악: ${document.getElementById('report-card-music')?.textContent || '-'}`,
                 `  움직임: ${document.getElementById('report-card-movement')?.textContent || '-'}`,
                 `  무대미술: ${document.getElementById('report-card-stage')?.textContent || '-'}`,
                 '',
                 `나의 감상평: ${document.getElementById('report-emoji')?.textContent || ''} ${document.getElementById('report-review')?.textContent || '-'}`,
                 '',
                 `질문상자:`,
                 ...Array.from(document.querySelectorAll('#report-questions li')).map(li => `  • ${li.textContent}`),
                 '',
                 '■ 2단계: 거울 (공감/정의)',
                 '─'.repeat(40),
                 `인물: ${document.getElementById('report-character-name')?.textContent || '-'}`,
                 `상황: ${document.getElementById('report-situation')?.textContent || '-'}`,
                 `말: ${document.getElementById('report-speech')?.textContent || '-'}`,
                 `행동: ${document.getElementById('report-action')?.textContent || '-'}`,
                 '',
                 `필요한 것: ${document.getElementById('report-pov-need')?.textContent || '-'}`,
                 `이유: ${document.getElementById('report-pov-reason')?.textContent || '-'}`,
                 '',
                 '■ 3단계: 창문 (재정의/아이디어)',
                 '─'.repeat(40),
                 `HMW: ${document.getElementById('report-hmw')?.textContent || '-'}`,
                 '',
                 `아이디어 목록:`,
                 ...Array.from(document.querySelectorAll('#report-ideas li')).map(li => `  • ${li.textContent}`),
                 '',
                 `최종 아이디어: ${document.getElementById('report-final-idea')?.textContent || '-'}`,
                 '',
                 '■ 4단계: 미닫이문 (프로토타입/테스트)',
                 '─'.repeat(40),
                 `프로토타입 유형: ${document.getElementById('report-prototype-type')?.textContent || '-'}`,
                 ''
             ];

             // 각 프로토타입 유형별 결과물 추가
             if (!document.getElementById('report-sketch-section')?.classList.contains('hidden')) {
                 sections.push('▷ 스케치:');
                 sections.push(`  ${document.getElementById('report-sketch-description')?.textContent || '(설명 없음)'}`);
                 sections.push('');
             }

             if (!document.getElementById('report-photo-section')?.classList.contains('hidden')) {
                 const photoCount = document.querySelectorAll('#report-photos-container img').length;
                 sections.push(`▷ 사진: ${photoCount}장 업로드됨`);
                 sections.push('');
             }

             if (!document.getElementById('report-improv-section')?.classList.contains('hidden')) {
                 sections.push('▷ 즉흥극:');
                 const improvContent = document.getElementById('report-improv-content')?.textContent || '';
                 sections.push(improvContent.split('\n').map(line => `  ${line.trim()}`).join('\n'));
                 sections.push('');
             }

             if (!document.getElementById('report-story-section')?.classList.contains('hidden')) {
                 sections.push('▷ 이야기:');
                 sections.push(`  ${document.getElementById('report-story-content')?.textContent || '-'}`);
                 sections.push('');
             }

             if (!document.getElementById('report-video-section')?.classList.contains('hidden')) {
                 const videoCount = document.querySelectorAll('#video-preview-container video').length;
                 sections.push(`▷ 영상: ${videoCount}개 업로드됨`);
                 sections.push('');
             }

             if (!document.getElementById('report-appdesign-section')?.classList.contains('hidden')) {
                 sections.push('▷ 앱 디자인:');
                 const pageText = document.querySelector('#report-appdesign-pages p')?.textContent || '페이지 없음';
                 sections.push(`  ${pageText}`);
                 sections.push('');
             }

             sections.push(
                 `피드백:`,
                 `  좋았던 점: ${document.getElementById('report-feedback-plus')?.textContent || '-'}`,
                 `  개선할 점: ${document.getElementById('report-feedback-delta')?.textContent || '-'}`,
                 `  궁금한 점: ${document.getElementById('report-feedback-question')?.textContent || '-'}`,
                 `  새 아이디어: ${document.getElementById('report-feedback-idea')?.textContent || '-'}`,
                 '',
                 '■ 5단계: 어둠 (성찰)',
                 '─'.repeat(40),
                 `알게 된 것: ${document.getElementById('report-learned')?.textContent || '-'}`,
                 `느낀 감정: ${document.getElementById('report-felt')?.textContent || '-'}`,
                 `성장한 점: ${document.getElementById('report-growth')?.textContent || '-'}`,
                 `이모지: ${document.getElementById('report-reflection-emojis')?.textContent || '-'}`,
                 '',
                 '■ 열매 (논술)',
                 '─'.repeat(40),
                 `제목: ${document.getElementById('report-essay-title')?.textContent || '-'}`,
                 `이름: ${document.getElementById('report-essay-name')?.textContent || '-'}`,
                 '',
                 '[서론]',
                 document.getElementById('report-essay-intro')?.textContent || '',
                 '',
                 '[본론]',
                 document.getElementById('report-essay-body')?.textContent || '',
                 '',
                 '[결론]',
                 document.getElementById('report-essay-conclusion')?.textContent || '',
                 '',
                 '='.repeat(60)
             );
             return sections.join('\n');
         }

         // 내보내기 기능
         if (document.getElementById('export-pdf-btn')) {
             document.getElementById('export-pdf-btn').addEventListener('click', () => {
                 const reportContent = document.getElementById('report-content');
                 if (reportContent && typeof html2canvas !== 'undefined') {
                     // HTML을 Canvas로 변환 후 이미지로 PDF 생성
                     html2canvas(reportContent, {
                         scale: 2,
                         useCORS: true,
                         backgroundColor: '#ffffff'
                     }).then(canvas => {
                         const imgData = canvas.toDataURL('image/png');
                         const authorName = document.getElementById('report-author-name')?.value.trim() || '학생';

                         // PDF를 만들기 위해 window.print() 사용 (간단한 방법)
                         const printWindow = window.open('', '', 'height=600,width=800');
                         printWindow.document.write('<html><head><title>홍당뮤 보고서</title>');
                         printWindow.document.write('<style>body{margin:0;padding:20px;}img{max-width:100%;}</style>');
                         printWindow.document.write('</head><body>');
                         printWindow.document.write(`<img src="${imgData}" />`);
                         printWindow.document.write('</body></html>');
                         printWindow.document.close();

                         setTimeout(() => {
                             printWindow.print();
                             showExportSuccess();
                         }, 250);
                     }).catch(err => {
                         console.error('PDF 생성 오류:', err);
                         alert('PDF 생성 중 오류가 발생했습니다.');
                     });
                 } else {
                     alert('html2canvas 라이브러리가 필요합니다.');
                 }
             });
         }

         if (document.getElementById('export-png-btn')) {
             document.getElementById('export-png-btn').addEventListener('click', () => {
                 const reportContent = document.getElementById('report-content');
                 if (reportContent && typeof html2canvas !== 'undefined') {
                     html2canvas(reportContent, { scale: 2, useCORS: true }).then(canvas => {
                         const link = document.createElement('a');
                         link.download = '홍당뮤_보고서.png';
                         link.href = canvas.toDataURL('image/png');
                         link.click();
                         showExportSuccess();
                     }).catch(err => console.error('PNG 생성 오류:', err));
                 }
             });
         }

         if (document.getElementById('export-txt-btn')) {
             document.getElementById('export-txt-btn').addEventListener('click', () => {
                 try {
                     const content = generateReportText();

                     // BOM 추가하여 UTF-8 인코딩 명시
                     const BOM = '\uFEFF';
                     const blob = new Blob([BOM + content], { type: 'text/plain;charset=utf-8' });
                     const url = URL.createObjectURL(blob);
                     const link = document.createElement('a');
                     link.href = url;
                     const authorName = document.getElementById('report-author-name')?.value.trim() || '학생';
                     link.download = `홍당뮤_보고서_${authorName}.txt`;
                     link.style.display = 'none';

                     // DOM에 추가하고 클릭 후 제거
                     document.body.appendChild(link);
                     link.click();

                     // 약간의 지연 후 정리
                     setTimeout(() => {
                         document.body.removeChild(link);
                         URL.revokeObjectURL(url);
                     }, 100);

                     showExportSuccess();
                 } catch (error) {
                     console.error('TXT 다운로드 오류:', error);
                     alert('TXT 파일 다운로드 중 오류가 발생했습니다.');
                 }
             });
         }

         if (document.getElementById('export-copy-btn')) {
             document.getElementById('export-copy-btn').addEventListener('click', () => {
                 const content = generateReportText();
                 const textarea = document.createElement('textarea');
                 textarea.value = content;
                 document.body.appendChild(textarea);
                 textarea.select();
                 try {
                     document.execCommand('copy');
                     showExportSuccess();
                 } catch (err) {
                     console.error('복사 실패:', err);
                 }
                 document.body.removeChild(textarea);
             });
         }

         function showExportSuccess() {
             const msg = document.getElementById('export-success-msg');
             if (msg) {
                 msg.classList.remove('hidden');
                 setTimeout(() => msg.classList.add('hidden'), 2000);
             }
         }

         // Title click to navigate home
         const appTitle = document.getElementById('app-title');
         if (appTitle) {
             appTitle.addEventListener('click', () => {
                 showPage('home');
                 setActiveTab('home');
             });
         }

         document.addEventListener('DOMContentLoaded', () => {
              showPage('home');
              setActiveTab('home');
              renderIcons(); // Render icons on load
              checkSentenceBoxPlaceholder(); // Check placeholder on initial load for reflection tab

              // Ensure sketch canvas is setup if 'door' tab is initially active (though unlikely)
              const initialActiveTab = document.querySelector('.nav-button.active-nav');
              if (initialActiveTab && initialActiveTab.dataset.tab === 'door') {
                   const initialActivePrototype = document.querySelector('#prototype-type-selector .prototype-btn.active');
                   if (initialActivePrototype && initialActivePrototype.dataset.type === 'sketch') {
                       requestAnimationFrame(setupSketchCanvas);
                   }
              }
         });

    </script>
</body>
</html>